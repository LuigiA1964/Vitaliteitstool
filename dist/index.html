<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vitaliteitstool — Analyseprogramma</title>
  <link rel="stylesheet" href="libs/leaflet.min.css">
  <style>
    /* Google Fonts removed for offline - using system fonts fallback */


    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --color-bg: #f8fafc;
      --color-surface: #ffffff;
      --color-surface-alt: #f1f5f9;
      --color-border: #e2e8f0;
      --color-border-hover: #cbd5e1;
      --color-text: #1e293b;
      --color-text-muted: #64748b;
      --color-text-dim: #94a3b8;
      --color-accent: #3b82f6;
      --color-accent-hover: #2563eb;
      --color-success: #16a34a;
      --color-warning: #d97706;
      --color-danger: #dc2626;
      --color-score-red: #dc2626;
      --color-score-orange: #ea580c;
      --color-score-yellow: #ca8a04;
      --color-score-green: #16a34a;
      --sidebar-width: 320px;
      --header-height: 56px;
      --font-sans: 'IBM Plex Sans', -apple-system, sans-serif;
      --font-mono: 'IBM Plex Mono', monospace;
      --radius: 8px;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    [data-theme="dark"] {
      --color-bg: #0a0e17;
      --color-surface: #111827;
      --color-surface-alt: #1a2235;
      --color-border: #1e293b;
      --color-border-hover: #334155;
      --color-text: #e2e8f0;
      --color-text-muted: #94a3b8;
      --color-text-dim: #64748b;
      --color-accent: #3b82f6;
      --color-accent-hover: #2563eb;
      --color-success: #22c55e;
      --color-warning: #f59e0b;
      --color-danger: #ef4444;
      --color-score-red: #dc2626;
      --color-score-orange: #f97316;
      --color-score-yellow: #eab308;
      --color-score-green: #22c55e;
      --shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    body {
      font-family: var(--font-sans);
      background: var(--color-bg);
      color: var(--color-text);
      height: 100vh;
      overflow: hidden;
      font-size: 14px;
      line-height: 1.5;
    }

    /* === HEADER === */
    .header {
      height: var(--header-height);
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 100;
      position: relative;
    }

    .header__brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header__logo {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--color-accent), #8b5cf6);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      color: white;
    }

    .header__title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .header__subtitle {
      font-size: 12px;
      color: var(--color-text-muted);
      font-weight: 400;
    }

    .header__actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* === BUTTONS === */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      background: var(--color-surface-alt);
      color: var(--color-text);
      font-family: var(--font-sans);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .btn:hover { background: var(--color-border); border-color: var(--color-border-hover); }
    .btn--primary { background: var(--color-accent); border-color: var(--color-accent); color: white; }
    .btn--primary:hover { background: var(--color-accent-hover); }
    .btn--danger { background: var(--color-danger); border-color: var(--color-danger); color: white; }
    .btn--sm { padding: 5px 10px; font-size: 12px; }
    .btn--icon { padding: 8px; min-width: 36px; justify-content: center; }
    .btn--ghost { background: transparent; border-color: transparent; color: var(--color-text-muted); padding: 4px 8px; }
    .btn--ghost:hover { color: var(--color-text); background: var(--color-surface-alt); }

    /* === FILTER PANEL === */
    .filter-panel { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .filter-panel--open { max-height: 600px; overflow-y: auto; }
    .filter-group { margin-bottom: 12px; }
    .filter-group__label { font-size: 11px; font-weight: 600; color: var(--color-text-dim); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; }
    .filter-select { width: 100%; padding: 6px 8px; border: 1px solid var(--color-border); border-radius: var(--radius); background: var(--color-surface-alt); color: var(--color-text); font-family: var(--font-sans); font-size: 12px; outline: none; appearance: none; cursor: pointer; }
    .filter-select:focus { border-color: var(--color-accent); }
    .filter-chips { display: flex; flex-wrap: wrap; gap: 4px; }
    .filter-chip { padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 500; cursor: pointer; border: 1px solid var(--color-border); background: var(--color-surface-alt); color: var(--color-text-muted); transition: all 0.15s; user-select: none; }
    .filter-chip:hover { border-color: var(--color-accent); color: var(--color-text); }
    .filter-chip--active { background: rgba(59,130,246,0.15); border-color: var(--color-accent); color: var(--color-accent); }
    .filter-chip--vuln { border-color: rgba(239,68,68,0.3); }
    .filter-chip--vuln.filter-chip--active { background: rgba(239,68,68,0.15); border-color: var(--color-danger); color: var(--color-danger); }
    .filter-chip--quality { border-color: rgba(34,197,94,0.3); }
    .filter-chip--quality.filter-chip--active { background: rgba(34,197,94,0.15); border-color: var(--color-success); color: var(--color-success); }
    .filter-chip--opp { border-color: rgba(245,158,11,0.3); }
    .filter-chip--opp.filter-chip--active { background: rgba(245,158,11,0.15); border-color: var(--color-warning); color: var(--color-warning); }
    .filter-range { display: flex; align-items: center; gap: 6px; }
    .filter-range__input { width: 52px; padding: 4px 6px; border: 1px solid var(--color-border); border-radius: 4px; background: var(--color-surface-alt); color: var(--color-text); font-family: var(--font-mono); font-size: 11px; text-align: center; }
    .filter-range__sep { color: var(--color-text-dim); font-size: 11px; }
    .filter-toggle { display: flex; align-items: center; justify-content: space-between; padding: 4px 0; cursor: pointer; font-size: 12px; }
    .filter-toggle__switch { width: 32px; height: 18px; border-radius: 9px; background: var(--color-border); position: relative; transition: background 0.2s; }
    .filter-toggle__switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 14px; height: 14px; border-radius: 50%; background: var(--color-text-dim); transition: all 0.2s; }
    .filter-toggle--active .filter-toggle__switch { background: var(--color-accent); }
    .filter-toggle--active .filter-toggle__switch::after { left: 16px; background: white; }
    .filter-active-count { display: inline-flex; align-items: center; justify-content: center; min-width: 16px; height: 16px; border-radius: 8px; background: var(--color-accent); color: white; font-size: 10px; font-weight: 600; padding: 0 4px; }
    .filter-clear { font-size: 11px; color: var(--color-accent); cursor: pointer; border: none; background: none; font-family: var(--font-sans); }
    .filter-clear:hover { text-decoration: underline; }

    /* === OPPORTUNITY & ENVIRONMENTAL BADGES === */
    .opp-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 500; margin-bottom: 4px; margin-right: 4px; }
    .opp-badge--situation { background: rgba(245,158,11,0.1); color: #f59e0b; border: 1px solid rgba(245,158,11,0.2); }
    .opp-badge--social { background: rgba(168,85,247,0.1); color: #a855f7; border: 1px solid rgba(168,85,247,0.2); }
    .env-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 500; margin-bottom: 4px; margin-right: 4px; background: rgba(6,182,212,0.1); color: #06b6d4; border: 1px solid rgba(6,182,212,0.2); }
    .barrier-phase { padding: 8px 12px; border-left: 3px solid var(--color-accent); background: var(--color-surface-alt); border-radius: 0 var(--radius) var(--radius) 0; margin-bottom: 6px; }
    .barrier-phase__name { font-size: 12px; font-weight: 600; margin-bottom: 2px; }
    .barrier-phase__desc { font-size: 11px; color: var(--color-text-muted); }
    .barrier-phase__count { font-size: 10px; color: var(--color-accent); font-family: var(--font-mono); }

    /* === SCORE EXPLANATION === */
    .score-explain { margin: 12px 0; border: 1px solid var(--color-border); border-radius: var(--radius); overflow: hidden; }
    .score-explain__toggle {
      display: flex; align-items: center; justify-content: space-between; padding: 10px 14px;
      background: var(--color-surface-alt); cursor: pointer; user-select: none; transition: background 0.15s;
    }
    .score-explain__toggle:hover { background: var(--color-border); }
    .score-explain__toggle-label { font-size: 12px; font-weight: 600; color: var(--color-text); }
    .score-explain__toggle-icon { font-size: 10px; color: var(--color-text-muted); transition: transform 0.2s; }
    .score-explain--open .score-explain__toggle-icon { transform: rotate(180deg); }
    .score-explain__body { display: none; padding: 14px; border-top: 1px solid var(--color-border); }
    .score-explain--open .score-explain__body { display: block; }
    .score-explain__formula {
      padding: 10px 12px; background: var(--color-surface-alt); border-radius: var(--radius);
      font-family: var(--font-mono); font-size: 11px; color: var(--color-text); margin-bottom: 12px;
      line-height: 1.6; overflow-x: auto;
    }
    .score-explain__row {
      display: flex; align-items: center; justify-content: space-between; padding: 6px 0;
      border-bottom: 1px solid var(--color-border); font-size: 12px;
    }
    .score-explain__row:last-child { border-bottom: none; }
    .score-explain__dim-name { color: var(--color-text); font-weight: 500; flex: 1; }
    .score-explain__dim-score { font-family: var(--font-mono); font-weight: 600; width: 36px; text-align: right; }
    .score-explain__dim-weight { font-family: var(--font-mono); color: var(--color-text-muted); width: 40px; text-align: right; }
    .score-explain__dim-contrib { font-family: var(--font-mono); color: var(--color-accent); font-weight: 600; width: 48px; text-align: right; }
    .score-explain__dim-bar { flex: 0 0 60px; height: 6px; background: var(--color-border); border-radius: 3px; margin-left: 8px; overflow: hidden; }
    .score-explain__dim-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
    .score-explain__total {
      display: flex; align-items: center; justify-content: space-between; padding: 10px 0 0;
      margin-top: 8px; border-top: 2px solid var(--color-border); font-size: 13px; font-weight: 700;
    }
    .score-explain__total-label { color: var(--color-text); }
    .score-explain__total-value { font-family: var(--font-mono); font-size: 16px; }
    .score-explain__note {
      margin-top: 12px; padding: 10px; background: var(--color-surface-alt); border-radius: var(--radius);
      font-size: 11px; color: var(--color-text-muted); line-height: 1.5;
    }
    .score-explain__source-list { margin-top: 8px; padding-left: 0; list-style: none; }
    .score-explain__source-list li { font-size: 11px; color: var(--color-text-muted); padding: 3px 0; padding-left: 12px; position: relative; }
    .score-explain__source-list li::before { content: '→'; position: absolute; left: 0; color: var(--color-accent); }

    /* === SECTION TABS === */
    .section-tabs { display: flex; border-bottom: 1px solid var(--color-border); margin-bottom: 12px; }
    .section-tab { padding: 6px 12px; font-size: 11px; font-weight: 500; color: var(--color-text-muted); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s; }
    .section-tab:hover { color: var(--color-text); }
    .section-tab--active { color: var(--color-accent); border-bottom-color: var(--color-accent); }
    .tab-content { display: none; }
    .tab-content--active { display: block; }

    /* === LAYOUT === */
    .layout {
      display: flex;
      height: calc(100vh - var(--header-height));
    }

    /* === SIDEBAR === */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--color-surface);
      border-right: 1px solid var(--color-border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex-shrink: 0;
    }

    .sidebar__section {
      padding: 16px;
      border-bottom: 1px solid var(--color-border);
    }

    .sidebar__section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--color-text-dim);
      margin-bottom: 10px;
    }

    .sidebar__scrollable {
      flex: 1;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--color-border) transparent;
    }

    /* === DIMENSION WEIGHTS === */
    .weight-slider {
      margin-bottom: 12px;
    }

    .weight-slider__label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .weight-slider__name {
      font-size: 12px;
      font-weight: 500;
    }

    .weight-slider__value {
      font-size: 12px;
      font-weight: 600;
      color: var(--color-accent);
      font-family: var(--font-mono);
    }

    .weight-slider input[type="range"] {
      width: 100%;
      height: 4px;
      appearance: none;
      background: var(--color-border);
      border-radius: 2px;
      outline: none;
    }

    .weight-slider input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--color-accent);
      cursor: pointer;
    }

    /* === SCORE CARD === */
    .score-card {
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .score-card:hover {
      border-color: var(--color-accent);
      background: var(--color-surface);
    }

    .score-card__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .score-card__name {
      font-size: 13px;
      font-weight: 500;
    }

    .score-card__score {
      font-size: 18px;
      font-weight: 700;
      font-family: var(--font-mono);
    }

    .score-card__bar {
      height: 4px;
      background: var(--color-border);
      border-radius: 2px;
      overflow: hidden;
    }

    .score-card__bar-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    /* === MAP === */
    .map-container {
      flex: 1;
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
      background: var(--color-bg);
    }

    .map-overlay {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1000;
      display: flex;
      gap: 8px;
    }

    .map-legend {
      position: absolute;
      bottom: 30px;
      right: 12px;
      z-index: 1000;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 12px;
      min-width: 150px;
    }

    .map-legend__title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--color-text-dim);
      margin-bottom: 8px;
    }

    .map-legend__item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .map-legend__color {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      flex-shrink: 0;
    }

    /* === BRANCH HIGHLIGHT === */
    .branch-highlight-banner {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: var(--color-surface);
      border: 1px solid var(--color-accent);
      border-radius: var(--radius);
      padding: 8px 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      font-weight: 500;
      animation: slideDown 0.2s ease;
    }
    .branch-highlight-banner__count {
      font-family: var(--font-mono);
      font-weight: 700;
      color: var(--color-accent);
    }
    .branch-highlight-banner__close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: var(--color-text-muted);
      padding: 2px 6px;
      border-radius: 4px;
    }
    .branch-highlight-banner__close:hover {
      background: var(--color-surface-alt);
      color: var(--color-text);
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    @keyframes pulseHighlight {
      0%, 100% { opacity: 0.9; }
      50% { opacity: 0.5; }
    }

    /* === DETAIL PANEL === */
    .detail-panel {
      width: 380px;
      background: var(--color-surface);
      border-left: 1px solid var(--color-border);
      display: none;
      flex-direction: column;
      overflow: hidden;
      flex-shrink: 0;
    }

    .detail-panel--open { display: flex; }

    .detail-panel__header {
      padding: 16px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .detail-panel__title {
      font-size: 16px;
      font-weight: 600;
    }

    .detail-panel__content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      scrollbar-width: thin;
      scrollbar-color: var(--color-border) transparent;
    }

    /* === RADAR CHART === */
    .radar-container {
      width: 100%;
      aspect-ratio: 1;
      max-width: 280px;
      margin: 0 auto 16px;
    }

    /* === STATS GRID === */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }

    .stat-box {
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 10px;
      text-align: center;
    }

    .stat-box__value {
      font-size: 24px;
      font-weight: 700;
      font-family: var(--font-mono);
    }

    .stat-box__label {
      font-size: 11px;
      color: var(--color-text-muted);
      margin-top: 2px;
    }

    /* === BRANCH DIALOG === */
    .dialog-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 5000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .dialog-overlay--open { display: flex; }

    .dialog {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      width: 90%;
      max-width: 680px;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
    }

    .dialog__header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .dialog__title {
      font-size: 20px;
      font-weight: 600;
    }

    .dialog__code {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--color-text-dim);
      margin-top: 4px;
    }

    .dialog__close {
      background: none;
      border: none;
      color: var(--color-text-muted);
      cursor: pointer;
      font-size: 24px;
      padding: 4px;
      line-height: 1;
    }

    .dialog__close:hover { color: var(--color-text); }

    .dialog__body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      scrollbar-width: thin;
      scrollbar-color: var(--color-border) transparent;
    }

    .dialog__scores {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }

    .dialog__score-block {
      flex: 1;
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 16px;
      text-align: center;
    }

    .dialog__score-value {
      font-size: 36px;
      font-weight: 700;
      font-family: var(--font-mono);
    }

    .dialog__score-label {
      font-size: 12px;
      color: var(--color-text-muted);
      margin-top: 4px;
    }

    .dialog__section {
      margin-bottom: 20px;
    }

    .dialog__section-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--color-text-dim);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dialog__section-title::before {
      content: '';
      width: 3px;
      height: 14px;
      border-radius: 2px;
    }

    .dialog__section-title--quality::before { background: var(--color-success); }
    .dialog__section-title--vulnerability::before { background: var(--color-danger); }
    .dialog__section-title--action::before { background: var(--color-accent); }

    .dialog__text {
      font-size: 14px;
      line-height: 1.7;
      color: var(--color-text);
    }

    .dialog__tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .dialog__tag {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }

    .dialog__tag--quality {
      background: rgba(34,197,94,0.15);
      color: var(--color-success);
      border: 1px solid rgba(34,197,94,0.3);
    }

    .dialog__tag--vulnerability {
      background: rgba(239,68,68,0.15);
      color: var(--color-danger);
      border: 1px solid rgba(239,68,68,0.3);
    }

    .dialog__tag--action {
      background: rgba(59,130,246,0.15);
      color: var(--color-accent);
      border: 1px solid rgba(59,130,246,0.3);
    }

    .dialog__monoculture-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: var(--radius);
      font-size: 12px;
      font-weight: 500;
      margin-top: 12px;
    }

    .dialog__monoculture-badge--yes {
      background: rgba(249,115,22,0.15);
      color: var(--color-warning);
      border: 1px solid rgba(249,115,22,0.3);
    }

    .dialog__monoculture-badge--no {
      background: rgba(34,197,94,0.1);
      color: var(--color-success);
      border: 1px solid rgba(34,197,94,0.2);
    }

    /* === BRANCHE OVERVIEW DIALOG === */
    #brancheOverviewDialog {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5000;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    #brancheOverviewDialog.branche-overview--open {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    .branche-overview {
      background: var(--color-surface);
      border-radius: var(--radius);
      width: 94%;
      max-width: 1100px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      position: relative;
      z-index: 5001;
    }

    .branche-overview__header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .branche-overview__title {
      font-size: 18px;
      font-weight: 700;
    }

    .branche-overview__close {
      background: none;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      padding: 4px 12px;
      cursor: pointer;
      font-size: 16px;
      color: var(--color-text-muted);
      transition: all 0.15s;
    }

    .branche-overview__close:hover {
      border-color: var(--color-danger);
      color: var(--color-danger);
    }

    .branche-overview__toolbar {
      padding: 12px 24px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      flex-shrink: 0;
    }

    .branche-overview__search {
      flex: 1;
      min-width: 200px;
      padding: 8px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      background: var(--color-surface-alt);
      color: var(--color-text);
      font-family: var(--font-sans);
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s;
    }

    .branche-overview__search:focus {
      border-color: var(--color-accent);
    }

    .branche-overview__filter-select {
      padding: 8px 10px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      background: var(--color-surface-alt);
      color: var(--color-text);
      font-family: var(--font-sans);
      font-size: 12px;
      outline: none;
      cursor: pointer;
      appearance: none;
    }

    .branche-overview__count {
      font-size: 12px;
      color: var(--color-text-muted);
      font-family: var(--font-mono);
      white-space: nowrap;
    }

    .branche-overview__body {
      flex: 1;
      overflow-y: auto;
      padding: 16px 24px;
      scrollbar-width: thin;
      scrollbar-color: var(--color-border) transparent;
    }

    .branche-overview__grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 10px;
    }

    .branche-card {
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 12px 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .branche-card:hover {
      border-color: var(--color-accent);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
      transform: translateY(-1px);
    }

    .branche-card--active {
      border-color: var(--color-accent);
      background: rgba(59, 130, 246, 0.05);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
    }

    .branche-card__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .branche-card__name {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text);
      line-height: 1.3;
    }

    .branche-card__group {
      font-size: 10px;
      color: var(--color-text-dim);
      margin-top: 2px;
    }

    .branche-card__scores {
      display: flex;
      gap: 6px;
    }

    .branche-card__score {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      font-family: var(--font-mono);
    }

    .branche-card__score--quality {
      background: rgba(34, 197, 94, 0.1);
      color: var(--color-success);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .branche-card__score--vuln {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .branche-card__tags {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
    }

    .branche-card__tag {
      padding: 1px 6px;
      border-radius: 8px;
      font-size: 9px;
      font-weight: 500;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-muted);
    }

    .branche-card__count-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
      font-family: var(--font-mono);
      background: rgba(59, 130, 246, 0.08);
      color: var(--color-accent);
      border: 1px solid rgba(59, 130, 246, 0.15);
    }

    .branche-card__count-badge--zero {
      background: var(--color-surface);
      color: var(--color-text-dim);
      border-color: var(--color-border);
    }

    /* Branche detail (inline, full-width) */
    .branche-detail {
      grid-column: 1 / -1;
      background: var(--color-surface);
      border: 2px solid var(--color-accent);
      border-radius: var(--radius);
      padding: 20px;
      animation: slideDown 0.2s ease;
    }

    .branche-detail__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .branche-detail__name {
      font-size: 18px;
      font-weight: 700;
      color: var(--color-text);
      margin-bottom: 2px;
    }

    .branche-detail__meta {
      font-size: 12px;
      color: var(--color-text-muted);
      font-family: var(--font-mono);
    }

    .branche-detail__close {
      background: none;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 12px;
      color: var(--color-text-muted);
    }

    .branche-detail__close:hover {
      border-color: var(--color-danger);
      color: var(--color-danger);
    }

    .branche-detail__scores-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .branche-detail__score-box {
      flex: 1;
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 12px;
      text-align: center;
    }

    .branche-detail__score-num {
      font-size: 28px;
      font-weight: 700;
      font-family: var(--font-mono);
    }

    .branche-detail__score-lbl {
      font-size: 11px;
      color: var(--color-text-muted);
      margin-top: 2px;
    }

    .branche-detail__sections {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .branche-detail__section {
      background: var(--color-surface-alt);
      border-radius: var(--radius);
      padding: 14px;
      border: 1px solid var(--color-border);
    }

    .branche-detail__section--full {
      grid-column: 1 / -1;
    }

    .branche-detail__section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--color-text-dim);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .branche-detail__section-title::before {
      content: '';
      width: 3px;
      height: 12px;
      border-radius: 2px;
    }

    .branche-detail__section-title--quality::before { background: var(--color-success); }
    .branche-detail__section-title--vuln::before { background: var(--color-danger); }
    .branche-detail__section-title--action::before { background: var(--color-accent); }
    .branche-detail__section-title--count::before { background: #a855f7; }

    .branche-detail__text {
      font-size: 13px;
      line-height: 1.6;
      color: var(--color-text);
      margin-bottom: 8px;
    }

    .branche-detail__tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    /* Occurrence table */
    .branche-detail__occ-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .branche-detail__occ-table th {
      text-align: left;
      padding: 6px 8px;
      border-bottom: 2px solid var(--color-border);
      font-weight: 600;
      color: var(--color-text-dim);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .branche-detail__occ-table td {
      padding: 5px 8px;
      border-bottom: 1px solid var(--color-border);
      color: var(--color-text);
    }

    .branche-detail__occ-table tr:last-child td {
      border-bottom: none;
    }

    .branche-detail__occ-table td:last-child {
      font-family: var(--font-mono);
      font-weight: 600;
      text-align: right;
    }

    .branche-detail__occ-none {
      font-size: 12px;
      color: var(--color-text-dim);
      font-style: italic;
      padding: 8px 0;
    }

    .branche-detail__occ-summary {
      display: flex;
      gap: 16px;
      margin-bottom: 10px;
    }

    .branche-detail__occ-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 8px 14px;
    }

    .branche-detail__occ-stat-num {
      font-size: 22px;
      font-weight: 700;
      font-family: var(--font-mono);
      color: var(--color-accent);
    }

    .branche-detail__occ-stat-lbl {
      font-size: 10px;
      color: var(--color-text-muted);
    }

    @media (max-width: 800px) {
      .branche-detail__sections {
        grid-template-columns: 1fr;
      }
      .branche-overview__grid {
        grid-template-columns: 1fr;
      }
    }

    /* === IMPORT === */
    .import-zone {
      border: 2px dashed var(--color-border);
      border-radius: var(--radius);
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .import-zone:hover {
      border-color: var(--color-accent);
      background: rgba(59,130,246,0.05);
    }

    .import-zone__icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .import-zone__text {
      font-size: 13px;
      color: var(--color-text-muted);
    }

    /* === BRANCH LIST === */
    .branch-list {
      max-height: 300px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--color-border) transparent;
    }

    .branch-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.1s;
    }

    .branch-item:hover { background: var(--color-surface-alt); }

    .branch-item__dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .branch-item__name {
      flex: 1;
      font-size: 13px;
    }

    .branch-item__scores {
      display: flex;
      gap: 8px;
      font-size: 11px;
      font-family: var(--font-mono);
    }

    .branch-item__quality { color: var(--color-success); }
    .branch-item__vulnerability { color: var(--color-danger); }

    /* === SEARCH === */
    .search-input {
      width: 100%;
      padding: 8px 12px;
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      color: var(--color-text);
      font-family: var(--font-sans);
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s;
    }

    .search-input:focus { border-color: var(--color-accent); }
    .search-input::placeholder { color: var(--color-text-dim); }

    /* === DATA STATUS === */
    .data-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      margin-bottom: 8px;
    }

    .data-status--loaded {
      background: rgba(34,197,94,0.1);
      color: var(--color-success);
    }

    .data-status--empty {
      background: rgba(148,163,184,0.1);
      color: var(--color-text-dim);
    }

    .data-status__dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .data-status--loaded .data-status__dot { background: var(--color-success); }
    .data-status--empty .data-status__dot { background: var(--color-text-dim); }

    /* === MONOCULTURE ALERTS === */
    .mono-alert {
      background: rgba(249,115,22,0.1);
      border: 1px solid rgba(249,115,22,0.3);
      border-radius: var(--radius);
      padding: 10px 12px;
      margin-bottom: 8px;
    }

    .mono-alert__title {
      font-size: 12px;
      font-weight: 600;
      color: var(--color-warning);
      margin-bottom: 4px;
    }

    .mono-alert__text {
      font-size: 12px;
      color: var(--color-text-muted);
    }

    /* === EMPTY STATE === */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 40px;
    }

    .empty-state__icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state__title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .empty-state__text {
      font-size: 14px;
      color: var(--color-text-muted);
      max-width: 400px;
    }

    /* === THEME TOGGLE === */
    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      background: var(--color-surface-alt);
      color: var(--color-text-muted);
      font-family: var(--font-sans);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s ease;
      user-select: none;
    }
    .theme-toggle:hover {
      background: var(--color-border);
      color: var(--color-text);
    }

    /* === SCROLLBAR === */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--color-border-hover); }

    /* === UTILITY === */
    .color-red { color: var(--color-score-red); }
    .color-orange { color: var(--color-score-orange); }
    .color-yellow { color: var(--color-score-yellow); }
    .color-green { color: var(--color-score-green); }
    .bg-red { background: var(--color-score-red); }
    .bg-orange { background: var(--color-score-orange); }
    .bg-yellow { background: var(--color-score-yellow); }
    .bg-green { background: var(--color-score-green); }
    .text-center { text-align: center; }
    .mb-8 { margin-bottom: 8px; }
    .mb-12 { margin-bottom: 12px; }
    .mb-16 { margin-bottom: 16px; }
    .hidden { display: none !important; }

    /* === IMPORT DIALOG === */
    #importDialog {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5000;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    #importDialog.import-dialog--open {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .import-dialog {
      background: var(--color-surface);
      border-radius: var(--radius);
      width: 90%;
      max-width: 900px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .import-dialog__header {
      padding: 20px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .import-dialog__title {
      font-size: 18px;
      font-weight: 600;
      color: var(--color-text);
    }
    .import-dialog__close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--color-text-muted);
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .import-dialog__close:hover {
      color: var(--color-text);
    }
    .import-dialog__body {
      overflow-y: auto;
      flex: 1;
      padding: 20px;
    }
    .import-category {
      margin-bottom: 24px;
    }
    .import-category__header {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 12px 0;
      border-bottom: 1px solid var(--color-border);
      margin-bottom: 12px;
    }
    .import-category__toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      background: var(--color-surface-alt);
      border-radius: 4px;
      color: var(--color-text-muted);
      font-size: 12px;
      transition: all 0.2s;
    }
    .import-category__header.import-category--collapsed .import-category__toggle {
      transform: rotate(-90deg);
    }
    .import-category__title {
      font-size: 14px;
      font-weight: 600;
      color: var(--color-text);
      flex: 1;
    }
    .import-category__badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--color-accent);
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
    }
    .import-category__content {
      max-height: 1000px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .import-category--collapsed .import-category__content {
      max-height: 0;
    }
    .import-dataset {
      padding: 12px;
      background: var(--color-surface-alt);
      border-radius: var(--radius);
      margin-bottom: 12px;
      border: 1px solid var(--color-border);
      transition: all 0.2s;
    }
    .import-dataset:hover {
      border-color: var(--color-accent);
      background: var(--color-surface);
    }
    .import-dataset__header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 8px;
    }
    .import-dataset__info {
      flex: 1;
    }
    .import-dataset__name {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 2px;
    }
    .import-dataset__description {
      font-size: 12px;
      color: var(--color-text-muted);
      margin-bottom: 6px;
    }
    .import-dataset__meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .import-meta-item {
      font-size: 11px;
      color: var(--color-text-dim);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .import-meta-item strong {
      color: var(--color-text-muted);
    }
    .import-dataset__status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    .import-dataset__status.pending {
      background: rgba(168, 85, 247, 0.1);
      color: #a855f7;
    }
    .import-dataset__status.uploaded {
      background: rgba(34, 197, 94, 0.1);
      color: var(--color-success);
    }
    .import-dataset__status.error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-danger);
    }
    .import-dataset__upload {
      padding: 8px;
      background: var(--color-surface);
      border: 2px dashed var(--color-border);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      font-size: 12px;
      color: var(--color-text-muted);
    }
    .import-dataset__upload:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
      background: rgba(59, 130, 246, 0.05);
    }
    .import-dataset__upload.dragover {
      border-color: var(--color-accent);
      background: rgba(59, 130, 246, 0.1);
    }
    .import-dataset__input {
      display: none;
    }
    .import-dataset__columns {
      margin-top: 8px;
      padding: 8px 0;
      border-top: 1px solid var(--color-border);
      max-height: none;
      overflow-y: visible;
    }

    /* Kolom-mapping interface */
    .import-mapping {
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    .import-mapping__header {
      display: grid;
      grid-template-columns: 24px 1fr 30px 1fr 24px;
      gap: 8px;
      align-items: center;
      padding: 6px 8px;
      background: var(--color-surface);
      border-bottom: 2px solid var(--color-border);
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--color-text-muted);
    }
    .import-mapping__row {
      display: grid;
      grid-template-columns: 24px 1fr 30px 1fr 24px;
      gap: 8px;
      align-items: center;
      padding: 6px 8px;
      border-bottom: 1px solid var(--color-border);
      font-size: 12px;
      transition: background 0.15s;
    }
    .import-mapping__row:hover {
      background: rgba(59, 130, 246, 0.03);
    }
    .import-mapping__row.import-mapping__row--pc6 {
      background: rgba(59, 130, 246, 0.06);
      border-left: 3px solid var(--color-accent);
      padding-left: 5px;
    }
    .import-mapping__badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 4px;
      font-size: 9px;
      font-weight: 700;
    }
    .import-mapping__badge.required {
      background: rgba(239, 68, 68, 0.12);
      color: var(--color-danger);
    }
    .import-mapping__badge.optional {
      background: rgba(168, 85, 247, 0.1);
      color: #a855f7;
    }
    .import-mapping__target {
      display: flex;
      flex-direction: column;
      gap: 1px;
      min-width: 0;
    }
    .import-mapping__target-name {
      font-weight: 600;
      color: var(--color-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .import-mapping__target-desc {
      font-size: 10px;
      color: var(--color-text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .import-mapping__arrow {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-dim);
      font-size: 14px;
    }
    .import-mapping__select {
      width: 100%;
      padding: 5px 8px;
      font-size: 12px;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      background: var(--color-surface);
      color: var(--color-text);
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .import-mapping__select:focus {
      outline: none;
      border-color: var(--color-accent);
    }
    .import-mapping__select.mapped {
      border-color: var(--color-success);
      background: rgba(34, 197, 94, 0.05);
    }
    .import-mapping__select.unmapped-required {
      border-color: var(--color-danger);
      background: rgba(239, 68, 68, 0.05);
    }
    .import-mapping__status-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .import-mapping__actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--color-border);
    }
    .import-mapping__btn {
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    .import-mapping__btn--primary {
      background: var(--color-accent);
      color: white;
    }
    .import-mapping__btn--primary:hover {
      filter: brightness(1.1);
    }
    .import-mapping__btn--primary:disabled {
      background: var(--color-border);
      color: var(--color-text-dim);
      cursor: not-allowed;
    }
    .import-mapping__btn--secondary {
      background: var(--color-surface-alt);
      color: var(--color-text);
      border: 1px solid var(--color-border);
    }
    .import-mapping__btn--secondary:hover {
      background: var(--color-surface);
    }
    .import-mapping__summary {
      font-size: 11px;
      color: var(--color-text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
    }
    .import-mapping__auto-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      background: rgba(34, 197, 94, 0.1);
      color: var(--color-success);
    }
    .import-dataset__records {
      margin-top: 8px;
      font-size: 11px;
      color: var(--color-accent);
      font-family: var(--font-mono);
      font-weight: 500;
    }
    .import-dialog__footer {
      padding: 16px 20px;
      border-top: 1px solid var(--color-border);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* ==========================================
       STAKEHOLDER PANEL
       ========================================== */
    #stakeholderDialog {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5000;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    #stakeholderDialog.stakeholder-dialog--open {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .stakeholder-dialog {
      background: var(--color-surface);
      border-radius: var(--radius);
      width: 94%;
      max-width: 1100px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      position: relative;
      z-index: 5001;
    }
    .stakeholder-dialog__header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .stakeholder-dialog__title {
      font-size: 18px;
      font-weight: 600;
      color: var(--color-text);
    }
    .stakeholder-dialog__close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--color-text-muted);
      padding: 4px;
    }
    .stakeholder-dialog__close:hover { color: var(--color-text); }

    .stakeholder-dialog__toolbar {
      padding: 12px 20px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .stakeholder-dialog__search {
      flex: 1;
      min-width: 180px;
      padding: 8px 12px;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      font-size: 13px;
      background: var(--color-surface-alt);
      color: var(--color-text);
    }
    .stakeholder-dialog__search:focus {
      outline: none;
      border-color: var(--color-accent);
    }
    .stakeholder-dialog__filter-select {
      padding: 8px 12px;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      font-size: 12px;
      background: var(--color-surface-alt);
      color: var(--color-text);
      cursor: pointer;
    }
    .stakeholder-dialog__filter-select:focus {
      outline: none;
      border-color: var(--color-accent);
    }
    .stakeholder-dialog__count {
      font-size: 12px;
      color: var(--color-text-muted);
      margin-left: auto;
    }

    .stakeholder-dialog__body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
      align-content: start;
    }

    /* Actor cards */
    .actor-card {
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .actor-card:hover {
      border-color: var(--color-accent);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
      transform: translateY(-1px);
    }
    .actor-card--active {
      border-color: var(--color-accent);
      background: rgba(59, 130, 246, 0.05);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
    }
    .actor-card__header {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .actor-card__icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    .actor-card__icon--ondernemers { background: rgba(234, 179, 8, 0.15); }
    .actor-card__icon--vastgoed { background: rgba(139, 92, 246, 0.15); }
    .actor-card__icon--bewoners { background: rgba(34, 197, 94, 0.15); }
    .actor-card__icon--bezoekers { background: rgba(59, 130, 246, 0.15); }
    .actor-card__icon--overheid { background: rgba(239, 68, 68, 0.15); }
    .actor-card__icon--handhaving_veiligheid { background: rgba(249, 115, 22, 0.15); }
    .actor-card__icon--maatschappelijk { background: rgba(6, 182, 212, 0.15); }
    .actor-card__name {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text);
      line-height: 1.3;
    }
    .actor-card__category {
      font-size: 10px;
      color: var(--color-text-dim);
      text-transform: capitalize;
    }
    .actor-card__perspective {
      font-size: 11px;
      color: var(--color-text-muted);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .actor-card__tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .actor-card__tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 500;
    }
    .actor-card__tag--bias {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-danger);
    }
    .actor-card__tag--qual {
      background: rgba(34, 197, 94, 0.1);
      color: var(--color-success);
    }
    .actor-card__tag--risk {
      background: rgba(249, 115, 22, 0.1);
      color: #f97316;
    }

    /* Actor detail overlay */
    .actor-detail {
      grid-column: 1 / -1;
      background: var(--color-surface);
      border: 2px solid var(--color-accent);
      border-radius: var(--radius);
      padding: 20px;
      animation: slideDown 0.2s ease;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .actor-detail__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    .actor-detail__name {
      font-size: 18px;
      font-weight: 700;
      color: var(--color-text);
      margin-bottom: 4px;
    }
    .actor-detail__subtitle {
      font-size: 12px;
      color: var(--color-text-muted);
    }
    .actor-detail__close {
      background: none;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 12px;
      color: var(--color-text-muted);
    }
    .actor-detail__close:hover {
      background: var(--color-surface-alt);
      color: var(--color-text);
    }
    .actor-detail__sections {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .actor-detail__section {
      background: var(--color-surface-alt);
      border-radius: var(--radius);
      padding: 14px;
      border: 1px solid var(--color-border);
    }
    .actor-detail__section--full {
      grid-column: 1 / -1;
    }
    .actor-detail__section-title {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--color-text-muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .actor-detail__list {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .actor-detail__list li {
      font-size: 12px;
      color: var(--color-text);
      padding: 4px 0;
      padding-left: 12px;
      position: relative;
      line-height: 1.5;
    }
    .actor-detail__list li::before {
      content: '';
      position: absolute;
      left: 0;
      top: 10px;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--color-text-dim);
    }
    .actor-detail__list--bias li::before { background: var(--color-danger); }
    .actor-detail__list--qual li::before { background: var(--color-success); }
    .actor-detail__list--risk li::before { background: #f97316; }
    .actor-detail__list--comm li::before { background: var(--color-accent); }
    .actor-detail__framing {
      font-size: 12px;
      color: var(--color-text);
      line-height: 1.6;
      padding: 10px;
      background: var(--color-surface);
      border-left: 3px solid var(--color-accent);
      border-radius: 0 4px 4px 0;
      margin-top: 8px;
    }
    .actor-detail__collab {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .actor-detail__collab-group {
      flex: 1;
      min-width: 140px;
    }
    .actor-detail__collab-label {
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .actor-detail__collab-label--ally { color: var(--color-success); }
    .actor-detail__collab-label--opponent { color: var(--color-danger); }
    .actor-detail__collab-label--conditional { color: #f59e0b; }
    .actor-detail__collab-item {
      font-size: 11px;
      padding: 3px 8px;
      background: var(--color-surface);
      border-radius: 3px;
      margin-bottom: 3px;
      color: var(--color-text);
      cursor: pointer;
      transition: background 0.15s;
    }
    .actor-detail__collab-item:hover {
      background: rgba(59, 130, 246, 0.1);
    }
    .actor-detail__tensions {
      margin-top: 8px;
    }
    .actor-detail__tension {
      font-size: 11px;
      color: var(--color-text-muted);
      padding: 4px 0 4px 12px;
      border-left: 2px solid var(--color-warning, #f59e0b);
      margin-bottom: 6px;
      line-height: 1.5;
    }

    /* === STARTUP MODE SELECTOR === */
    .startup-overlay {
      position: fixed; inset: 0; z-index: 10000;
      background: var(--color-bg);
      display: flex; align-items: center; justify-content: center;
      transition: opacity 0.4s ease;
    }
    .startup-overlay--hidden { opacity: 0; pointer-events: none; }
    .startup-panel {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 16px;
      padding: 48px;
      max-width: 640px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    }
    .startup-panel__logo {
      width: 72px; height: 72px; border-radius: 16px;
      background: linear-gradient(135deg, var(--color-accent), #2563eb);
      color: #fff; font-size: 32px; font-weight: 800;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 24px;
      font-family: var(--font-mono);
    }
    .startup-panel__title {
      font-size: 28px; font-weight: 700; color: var(--color-text);
      margin-bottom: 8px;
    }
    .startup-panel__subtitle {
      font-size: 14px; color: var(--color-text-muted);
      margin-bottom: 32px;
    }
    .startup-panel__org {
      font-size: 12px; color: var(--color-accent);
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em;
      margin-bottom: 32px;
    }
    .startup-modes {
      display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
      margin-bottom: 24px;
    }
    .startup-mode {
      padding: 24px 20px;
      border: 2px solid var(--color-border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--color-surface);
      text-align: left;
    }
    .startup-mode:hover {
      border-color: var(--color-accent);
      background: var(--color-surface-alt);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }
    .startup-mode__icon {
      font-size: 28px; margin-bottom: 12px;
    }
    .startup-mode__title {
      font-size: 16px; font-weight: 700; color: var(--color-text);
      margin-bottom: 6px;
    }
    .startup-mode__desc {
      font-size: 12px; color: var(--color-text-muted); line-height: 1.5;
    }
    .startup-mode--demo { border-color: rgba(34,197,94,0.3); }
    .startup-mode--demo:hover { border-color: #22c55e; background: rgba(34,197,94,0.05); }
    .startup-mode--prod { border-color: rgba(59,130,246,0.3); }
    .startup-mode--prod:hover { border-color: #3b82f6; background: rgba(59,130,246,0.05); }
    .startup-panel__footer {
      font-size: 11px; color: var(--color-text-dim);
      margin-top: 16px; padding-top: 16px;
      border-top: 1px solid var(--color-border);
    }
    .startup-panel__version {
      display: inline-block; padding: 2px 8px;
      background: var(--color-surface-alt); border-radius: 4px;
      font-family: var(--font-mono); font-size: 10px;
      color: var(--color-text-muted); margin-top: 8px;
    }
  .launcher-screen{position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);display:flex;align-items:center;justify-content:center;z-index:20000}.launcher-box{background:white;border-radius:20px;padding:40px;max-width:900px;width:90%;box-shadow:0 25px 80px rgba(0,0,0,0.5)}.launcher-header{text-align:center;margin-bottom:30px}.launcher-header h1{font-size:2rem;color:#1e3a5f;margin:10px 0 5px 0}.launcher-header p{color:#666;font-size:1rem}.version-badge{display:inline-block;background:#8b5cf6;color:white;padding:4px 12px;border-radius:20px;font-size:0.75rem;font-weight:600;margin-top:10px}.launcher-options{display:grid;grid-template-columns:1fr 1fr;gap:25px;margin-bottom:30px}.launcher-option{border:2px solid #e0e0e0;border-radius:15px;padding:25px;cursor:pointer;transition:all 0.3s ease;position:relative}.launcher-option:hover{transform:translateY(-5px);box-shadow:0 10px 30px rgba(0,0,0,0.1)}.demo-option:hover{border-color:#27ae60;background:#f0fff4}.production-option:hover{border-color:#3498db;background:#f0f7ff}.option-icon{width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 15px;font-size:1.8rem}.demo-option .option-icon{background:#e8f5e9;color:#27ae60}.production-option .option-icon{background:#e3f2fd;color:#3498db}.launcher-option h3{text-align:center;margin:0 0 8px 0;color:#1e3a5f;font-size:1.2rem}.launcher-option>p{text-align:center;color:#666;font-size:0.9rem;margin-bottom:15px}.launcher-option ul{list-style:none;padding:0;margin:0 0 20px 0}.launcher-option li{padding:6px 0;color:#555;font-size:0.85rem;display:flex;align-items:center;gap:8px}.btn-demo,.btn-production{width:100%;padding:12px;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.3s}.btn-demo{background:linear-gradient(135deg,#27ae60,#2ecc71);color:white}.btn-demo:hover{background:linear-gradient(135deg,#219a52,#27ae60)}.btn-production{background:linear-gradient(135deg,#3498db,#2980b9);color:white}.btn-production:hover{background:linear-gradient(135deg,#2980b9,#1f6aa5)}.launcher-footer{text-align:center;color:#999;font-size:0.8rem;border-top:1px solid #eee;padding-top:20px}.demo-banner{position:fixed;top:0;left:0;right:0;background:linear-gradient(90deg,#e67e22,#f39c12);color:white;text-align:center;padding:8px;font-weight:600;z-index:9999;font-size:0.9rem}</style>
</head>
<body>

<!-- STARTUP MODE SELECTOR — getoond bij opstart voor keuze demo/productie -->
<div id="launcherScreen" class="launcher-screen"><div class="launcher-box"><div class="launcher-header"><div style="width:64px;height:64px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 15px;color:white;font-size:32px;font-weight:800">V</div><h1>Vitaliteitstool</h1><p>Analyseprogramma voor Dynamische Binnensteden</p><span class="version-badge">v1.0 — Proof of Concept</span></div><div class="launcher-options"><div class="launcher-option demo-option" onclick="Launcher.startDemo()"><div class="option-icon"><i style="font-style:normal;font-size:2rem">&#x1F5FA;&#xFE0F;</i></div><h3>Demo Modus</h3><p>Verken de tool met voorbeelddata</p><ul><li>&#x2705; Volledige functionaliteit</li><li>&#x2705; Gemeente Purmerend als voorbeeld</li><li>&#x2705; Geen licentie nodig</li><li>&#x26A0;&#xFE0F; Niet voor officieel gebruik</li></ul><button class="btn-demo" onclick="event.stopPropagation(); Launcher.startDemo()">&#x1F680; Start Demo</button></div><div class="launcher-option production-option" onclick="Launcher.startProduction()"><div class="option-icon"><i style="font-style:normal;font-size:2rem">&#x1F4CA;</i></div><h3>Productie Modus</h3><p>Beveiligde toegang met 2FA</p><ul><li>&#x2705; Wachtwoord verificatie</li><li>&#x2705; 2FA authenticatie</li><li>&#x2705; Volledige beveiliging</li><li>&#x2705; Officieel gebruik</li></ul><button class="btn-production" onclick="event.stopPropagation(); Launcher.startProduction()">&#x1F512; Inloggen</button></div></div><div class="launcher-footer"><p>&copy; 2025 Knowledge by Data B.V. | In opdracht van City Deal Dynamische Binnensteden</p><p style="font-size:0.7rem;margin-top:5px">Contact: 06-84 82 07 08 | info@knowledgebydata.nl</p></div></div></div><div style="display:none"><div id="btnStartDemo"></div><div id="btnStartProd"></div></div>

<!-- AUTH OVERLAY — wordt getoond vóór de applicatie als authenticatie vereist is -->
<div id="authOverlay" style="position:fixed;inset:0;z-index:9999;background:var(--color-bg);display:none;"></div>

<!-- HEADER -->
<header class="header">
  <div class="header__brand">
    <div class="header__logo">V</div>
    <div>
      <div class="header__title">Vitaliteitstool</div>
      <div class="header__subtitle">Analyseprogramma • Knowledge by Data B.V.</div>
    </div>
  </div>
  <div class="header__actions">
    <button class="theme-toggle" id="themeToggle" title="Wissel tussen licht en donker thema">
      <span id="themeIcon">☀️</span> <span id="themeLabel">Licht</span>
    </button>
    <button class="btn" data-action="branche-overview" title="Brancheoverzicht">
      🏪 Branches
    </button>
    <button class="btn" data-action="stakeholders" title="Stakeholder-actoren">
      👥 Stakeholders
    </button>
    <button class="btn" data-action="import" title="Data importeren">
      📂 Importeren
    </button>
    <button class="btn btn--primary" data-action="export" title="Exporteren naar JSON">
      💾 Exporteer JSON
    </button>
    <button class="btn btn--ghost" data-action="logout" title="Uitloggen" id="btnLogout" style="display:none">
      🔒 Uitloggen
    </button>
  </div>
</header>

<!-- MAIN LAYOUT -->
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <!-- Data Status -->
    <div class="sidebar__section">
      <div class="sidebar__section-title">Data Status</div>
      <div class="data-status data-status--empty" id="dataStatus">
        <div class="data-status__dot"></div>
        <span>Geen data geladen — gebruik demo of importeer</span>
      </div>
      <button class="btn btn--sm" data-action="load-demo" style="width:100%">▶ Laad demodata</button>
    </div>

    <!-- Search & Filters -->
    <div class="sidebar__section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="sidebar__section-title" style="margin-bottom:0">Zoeken &amp; Filteren</div>
        <div style="display:flex;gap:4px;align-items:center">
          <span class="filter-active-count" id="filterActiveCount" style="display:none">0</span>
          <button class="btn--ghost" id="btnToggleFilters" title="Filters tonen/verbergen">▼ Filters</button>
          <button class="filter-clear" id="btnClearFilters" style="display:none">Reset</button>
        </div>
      </div>
      <input type="text" class="search-input" id="branchSearch" placeholder="Zoek op branchenaam, code of groep...">

      <!-- Uitklapbaar filterpaneel -->
      <div class="filter-panel" id="filterPanel">
        <!-- Gebiedsfilters -->
        <div class="filter-group" style="margin-top:10px">
          <div class="filter-group__label">Winkelgebied</div>
          <select class="filter-select" id="filterShoppingArea">
            <option value="">Alle winkelgebieden</option>
            <option value="binnenstad_groot">Binnenstad (groot)</option>
            <option value="binnenstad_middelgroot">Binnenstad (middelgroot)</option>
            <option value="binnenstad_klein">Binnenstad (klein)</option>
            <option value="kernverzorgend">Kernverzorgend centrum</option>
            <option value="wijkcentrum">Wijkcentrum</option>
            <option value="buurtcentrum">Buurtcentrum</option>
            <option value="stadsdeelcentrum">Stadsdeelcentrum</option>
            <option value="perifeer">Perifeer</option>
            <option value="verspreide_bewinkeling">Verspreide bewinkeling</option>
          </select>
        </div>

        <div class="filter-group">
          <div class="filter-group__label">Hoofdbranche</div>
          <select class="filter-select" id="filterMainBranch">
            <option value="">Alle hoofdbranches</option>
            <!-- Gevuld door JS -->
          </select>
        </div>

        <div class="filter-group">
          <div class="filter-group__label">Postcode (PC6)</div>
          <input type="text" class="search-input" id="filterPC6" placeholder="Bijv. 1811AA" style="font-size:12px">
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div class="filter-group">
            <div class="filter-group__label">Straat</div>
            <select class="filter-select" id="filterStreet">
              <option value="">Alle straten</option>
            </select>
          </div>
          <div class="filter-group">
            <div class="filter-group__label">Buurt</div>
            <select class="filter-select" id="filterNeighborhood">
              <option value="">Alle buurten</option>
            </select>
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-group__label">Wijk</div>
          <select class="filter-select" id="filterDistrict">
            <option value="">Alle wijken</option>
          </select>
        </div>

        <!-- Score ranges -->
        <div class="filter-group">
          <div class="filter-group__label">Kwaliteitsscore</div>
          <div class="filter-range">
            <input type="number" class="filter-range__input" id="filterQualityMin" min="1" max="10" placeholder="1" value="">
            <span class="filter-range__sep">—</span>
            <input type="number" class="filter-range__input" id="filterQualityMax" min="1" max="10" placeholder="10" value="">
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-group__label">Kwetsbaarheidsscore</div>
          <div class="filter-range">
            <input type="number" class="filter-range__input" id="filterVulnMin" min="1" max="10" placeholder="1" value="">
            <span class="filter-range__sep">—</span>
            <input type="number" class="filter-range__input" id="filterVulnMax" min="1" max="10" placeholder="10" value="">
          </div>
        </div>

        <!-- Kwetsbaarheden chips -->
        <div class="filter-group">
          <div class="filter-group__label">Kwetsbaarheden</div>
          <div class="filter-chips" id="filterVulnChips">
            <!-- Gevuld door JS -->
          </div>
        </div>

        <!-- Kwaliteiten chips -->
        <div class="filter-group">
          <div class="filter-group__label">Kwaliteiten</div>
          <div class="filter-chips" id="filterQualityChips">
            <!-- Gevuld door JS -->
          </div>
        </div>

        <!-- Gelegenheidsstructuren chips (JenV) -->
        <div class="filter-group">
          <div class="filter-group__label">Gelegenheidsstructuren (JenV)</div>
          <div class="filter-chips" id="filterOppChips">
            <!-- Gevuld door JS -->
          </div>
        </div>

        <!-- Toggles -->
        <div class="filter-group">
          <div class="filter-toggle" id="filterMonoToggle">
            <span>Alleen monocultuurrisico</span>
            <div class="filter-toggle__switch"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dimension Weights -->
    <div class="sidebar__section">
      <div class="sidebar__section-title">Dimensiewegingen</div>
      <div class="weight-slider">
        <div class="weight-slider__label">
          <span class="weight-slider__name">Economische vitaliteit</span>
          <span class="weight-slider__value" id="wEconomicVal">25%</span>
        </div>
        <input type="range" min="0" max="50" value="25" id="wEconomic" data-dimension="economic">
      </div>
      <div class="weight-slider">
        <div class="weight-slider__label">
          <span class="weight-slider__name">Veiligheid</span>
          <span class="weight-slider__value" id="wSafetyVal">20%</span>
        </div>
        <input type="range" min="0" max="50" value="20" id="wSafety" data-dimension="safety">
      </div>
      <div class="weight-slider">
        <div class="weight-slider__label">
          <span class="weight-slider__name">Sociale vitaliteit</span>
          <span class="weight-slider__value" id="wSocialVal">20%</span>
        </div>
        <input type="range" min="0" max="50" value="20" id="wSocial" data-dimension="social">
      </div>
      <div class="weight-slider">
        <div class="weight-slider__label">
          <span class="weight-slider__name">Ruimtelijke kwaliteit</span>
          <span class="weight-slider__value" id="wSpatialVal">15%</span>
        </div>
        <input type="range" min="0" max="50" value="15" id="wSpatial" data-dimension="spatial">
      </div>
      <div class="weight-slider">
        <div class="weight-slider__label">
          <span class="weight-slider__name">Ondermijningsweerbaarheid</span>
          <span class="weight-slider__value" id="wUnderminingVal">20%</span>
        </div>
        <input type="range" min="0" max="50" value="20" id="wUndermining" data-dimension="undermining">
      </div>
    </div>

    <!-- Branch List & Scores -->
    <div class="sidebar__section" style="flex:1;display:flex;flex-direction:column;overflow:hidden;border-bottom:none">
      <div class="sidebar__section-title">Branches <span id="branchCount"></span></div>
      <div class="branch-list" id="branchList">
        <!-- Filled by JS -->
      </div>
    </div>
  </aside>

  <!-- MAP -->
  <div class="map-container">
    <div id="map"></div>
    <div class="map-overlay">
      <button class="btn btn--sm" data-action="toggle-heatmap">🌡 Heatmap</button>
      <button class="btn btn--sm" data-action="toggle-monoculture">⚠ Monocultuur</button>
    </div>
    <div class="map-legend">
      <div class="map-legend__title">Vitaliteitsindex</div>
      <div class="map-legend__item"><div class="map-legend__color bg-green"></div> 8–10 Vitaal</div>
      <div class="map-legend__item"><div class="map-legend__color bg-yellow"></div> 6–7 Aandacht</div>
      <div class="map-legend__item"><div class="map-legend__color bg-orange"></div> 4–5 Zorgelijk</div>
      <div class="map-legend__item"><div class="map-legend__color bg-red"></div> 1–3 Kritiek</div>
    </div>
  </div>

  <!-- DETAIL PANEL -->
  <aside class="detail-panel" id="detailPanel">
    <div class="detail-panel__header">
      <div class="detail-panel__title" id="detailTitle">Selecteer een gebied</div>
      <button class="btn btn--sm btn--icon" data-action="close-detail">✕</button>
    </div>
    <div class="detail-panel__content" id="detailContent">
      <!-- Filled by JS -->
    </div>
  </aside>

</div>

<!-- BRANCH DIALOG -->
<div class="dialog-overlay" id="branchDialog">
  <div class="dialog">
    <div class="dialog__header">
      <div>
        <div class="dialog__title" id="dialogTitle"></div>
        <div class="dialog__code" id="dialogCode"></div>
      </div>
      <button class="dialog__close" data-action="close-dialog">✕</button>
    </div>
    <div class="dialog__body" id="dialogBody">
      <!-- Filled by JS -->
    </div>
  </div>
</div>

<!-- IMPORT DIALOG -->
<div id="importDialog">
  <div class="import-dialog">
    <div class="import-dialog__header">
      <div class="import-dialog__title">📂 Datasets Importeren</div>
      <button class="import-dialog__close" id="importDialogClose">✕</button>
    </div>
    <div class="import-dialog__body" id="importDialogBody">
      <!-- Filled by JS -->
    </div>
    <div class="import-dialog__footer">
      <button class="btn" id="importDialogCloseBtn">Sluit</button>
    </div>
  </div>
</div>

<!-- STAKEHOLDER DIALOG -->
<div id="stakeholderDialog">
  <div class="stakeholder-dialog">
    <div class="stakeholder-dialog__header">
      <div class="stakeholder-dialog__title">👥 Stakeholder-actoren</div>
      <button class="stakeholder-dialog__close" id="stakeholderDialogClose">✕</button>
    </div>
    <div class="stakeholder-dialog__toolbar">
      <input type="text" class="stakeholder-dialog__search" id="stakeholderSearch" placeholder="Zoek op naam, categorie of perspectief...">
      <select class="stakeholder-dialog__filter-select" id="stakeholderCategoryFilter">
        <option value="">Alle categorieën</option>
        <option value="ondernemers">Ondernemers</option>
        <option value="vastgoed">Vastgoed</option>
        <option value="bewoners">Bewoners</option>
        <option value="bezoekers">Bezoekers</option>
        <option value="overheid">Overheid</option>
        <option value="handhaving_veiligheid">Handhaving &amp; Veiligheid</option>
        <option value="maatschappelijk">Maatschappelijk</option>
      </select>
      <select class="stakeholder-dialog__filter-select" id="stakeholderTopicFilter">
        <option value="">Alle thema's</option>
        <option value="leegstand">Leegstand</option>
        <option value="veiligheid">Veiligheid</option>
        <option value="bereikbaarheid">Bereikbaarheid</option>
        <option value="economie">Economie</option>
        <option value="sociale_cohesie">Sociale cohesie</option>
        <option value="transformatie">Transformatie</option>
        <option value="identiteit">Identiteit</option>
      </select>
      <span class="stakeholder-dialog__count" id="stakeholderCount">24 actoren</span>
    </div>
    <div class="stakeholder-dialog__body" id="stakeholderDialogBody">
      <!-- Filled by JS -->
    </div>
  </div>
</div>

<!-- BRANCHE OVERVIEW DIALOG -->
<div id="brancheOverviewDialog">
  <div class="branche-overview">
    <div class="branche-overview__header">
      <div class="branche-overview__title">🏪 Brancheoverzicht</div>
      <button class="branche-overview__close" id="brancheOverviewClose">✕</button>
    </div>
    <div class="branche-overview__toolbar">
      <input type="text" class="branche-overview__search" id="brancheOverviewSearch" placeholder="Zoek op branchenaam...">
      <select class="branche-overview__filter-select" id="brancheOverviewGroupFilter">
        <option value="">Alle groepen</option>
      </select>
      <select class="branche-overview__filter-select" id="brancheOverviewSortFilter">
        <option value="name">Sorteer: Naam</option>
        <option value="quality-desc">Kwaliteit ↓</option>
        <option value="quality-asc">Kwaliteit ↑</option>
        <option value="vuln-desc">Kwetsbaarheid ↓</option>
        <option value="vuln-asc">Kwetsbaarheid ↑</option>
        <option value="count-desc">Aantal ↓</option>
      </select>
      <span class="branche-overview__count" id="brancheOverviewCount">0 branches</span>
    </div>
    <div class="branche-overview__body" id="brancheOverviewBody">
      <!-- Filled by JS -->
    </div>
  </div>
</div>

<script src="libs/leaflet.min.js">
// === BIBOB-STYLE LAUNCHER ===
const Launcher = {
    startDemo: function() {
        document.getElementById('launcherScreen').style.display = 'none';
        this.addDemoBanner();
        // Trigger demo data loading
        var demoBtn = document.getElementById('btnStartDemo');
        if (demoBtn) demoBtn.click();
        console.log('[Vitaliteitstool] Demo modus gestart');
    },
    startProduction: function() {
        document.getElementById('launcherScreen').style.display = 'none';
        // Show auth overlay for production
        var authOverlay = document.getElementById('authOverlay');
        if (authOverlay) authOverlay.style.display = 'flex';
        // Also trigger production button if it exists
        var prodBtn = document.getElementById('btnStartProd');
        if (prodBtn) prodBtn.click();
        console.log('[Vitaliteitstool] Productie modus gestart');
    },
    addDemoBanner: function() {
        if (document.getElementById('demoBanner')) return;
        var banner = document.createElement('div');
        banner.id = 'demoBanner';
        banner.className = 'demo-banner';
        banner.innerHTML = '\u26A0\uFE0F DEMO MODUS - Niet voor officieel gebruik - Alleen voor demonstratiedoeleinden';
        document.body.insertBefore(banner, document.body.firstChild);
    }
};
window.Launcher = Launcher;
// === END LAUNCHER ===
</script>
<script src="libs/xlsx.full.min.js"></script>
<script src="branch-qualifications.js"></script>
<script src="import-specifications.js"></script>
<script src="stakeholder-actoren.js"></script>
<script src="auth-guard.js"></script>
<script>
'use strict';

// ============================================================
// THEME MANAGEMENT
// ============================================================
(function initTheme() {
  const THEME_KEY = 'vitaliteitstool-theme';
  const saved = localStorage.getItem(THEME_KEY);
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const theme = saved || (prefersDark ? 'dark' : 'light');
  document.documentElement.setAttribute('data-theme', theme);
})();

function toggleTheme() {
  const THEME_KEY = 'vitaliteitstool-theme';
  const current = document.documentElement.getAttribute('data-theme') || 'light';
  const next = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem(THEME_KEY, next);
  updateThemeButton();
}

function updateThemeButton() {
  const theme = document.documentElement.getAttribute('data-theme') || 'light';
  const icon = document.getElementById('themeIcon');
  const label = document.getElementById('themeLabel');
  if (icon && label) {
    icon.textContent = theme === 'dark' ? '🌙' : '☀️';
    label.textContent = theme === 'dark' ? 'Donker' : 'Licht';
  }
}

/* Branch qualifications geladen via extern bestand (branch-qualifications.js) */

/* === LEGACY COMPAT: QUALITY_TAGS etc. komen nu uit window.BranchQualifications === */
const {
  QUALITY_TAGS_COMPAT_CHECK: __bqCheck
} = { QUALITY_TAGS_COMPAT_CHECK: typeof QUALITY_TAGS !== 'undefined' };

/* Als QUALITY_TAGS niet beschikbaar is (zou niet moeten), fallback tonen */
if (typeof QUALITY_TAGS === 'undefined') {
  console.error('FATAAL: branch-qualifications.js niet geladen. Controleer of het bestand naast de HTML staat.');
}

// ============================================================
// APPLICATION STATE
// ============================================================
const AppState = {
  data: {
    loaded: false,
    pc6Areas: new Map(), // pc6 -> { lat, lng, street, neighborhood, district, municipality, branches: [], scores: {} }
    branchInstances: [],  // all branch instances with pc6 reference
    imports: new Map(),  // datasetId -> { data, records, columns, validated }
  },
  weights: {
    economic: 25,
    safety: 20,
    social: 20,
    spatial: 15,
    undermining: 20
  },
  filters: {
    searchQuery: '',
    shoppingArea: '',
    mainBranch: '',
    pc6: '',
    street: '',
    neighborhood: '',
    district: '',
    qualityMin: null,
    qualityMax: null,
    vulnMin: null,
    vulnMax: null,
    vulnerabilityTypes: [],
    qualityTags: [],
    opportunityFactors: [],
    monocultureRiskOnly: false
  },
  ui: {
    selectedPc6: null,
    selectedBranch: null,
    showHeatmap: false,
    showMonoculture: false,
    detailOpen: false,
    dialogOpen: false,
    searchQuery: '',
    filtersOpen: false,
    detailTab: 'scores' // scores | opportunity | environment | barrier
  },
  map: null,
  markers: [],
  circleMarkers: [],
  branchHighlight: null  // { code, name, highlightMarkers: [] }
};

// ============================================================
// SCORE UTILITIES
// ============================================================
function getScoreColor(score) {
  if (score >= 8) return 'var(--color-score-green)';
  if (score >= 6) return 'var(--color-score-yellow)';
  if (score >= 4) return 'var(--color-score-orange)';
  return 'var(--color-score-red)';
}

function getScoreClass(score) {
  if (score >= 8) return 'color-green';
  if (score >= 6) return 'color-yellow';
  if (score >= 4) return 'color-orange';
  return 'color-red';
}

function getScoreLabel(score) {
  if (score >= 8) return 'Vitaal';
  if (score >= 6) return 'Aandacht';
  if (score >= 4) return 'Zorgelijk';
  return 'Kritiek';
}

// ============================================================
// DEMO DATA GENERATOR — Hilversum (97 PC6-gebieden)
// ============================================================
function generateDemoData() {
  const BQ = window.BranchQualifications;
  const allBranches = BQ.getAllBranches();

  // Purmerend WIJKEN
  const WIJKEN = {
    'Centrum': { lat: 52.50657938, lng: 4.94944710 },
    'Gors': { lat: 52.49782671, lng: 4.95509840 },
    'Overwhere': { lat: 52.51864081, lng: 4.96580865 },
    'Wheermolen': { lat: 52.50837755, lng: 4.97102723 },
    'Purmer-Noord': { lat: 52.50731370, lng: 4.98875602 },
    'Purmer-Zuid': { lat: 52.49043645, lng: 4.96813784 },
    'Weidevenne': { lat: 52.49814550, lng: 4.93844825 },
    'Beemster': { lat: 52.54173584, lng: 4.91477432 }
  };

  // Real Purmerend addresses from JSON data
  const ADDRESSES = [
    // Winkelgebied 1: Purmerend Centrum / Eggert
    { pc6: '1441AD', straat: 'Hoornsebuurt', lat: 52.51045467, lng: 4.94891426, buurt: 'Binnenstad', wijk: 'Centrum' },
    { pc6: '1441AP', straat: 'Gedempte Singelgracht', lat: 52.51143955, lng: 4.94624246, buurt: 'Binnenstad', wijk: 'Centrum' },
    { pc6: '1441AT', straat: 'Westerstraat', lat: 52.50962545, lng: 4.94380278, buurt: 'Binnenstad', wijk: 'Centrum' },
    { pc6: '1441BL', straat: 'Kerkstraat', lat: 52.51036767, lng: 4.94695221, buurt: 'Binnenstad', wijk: 'Centrum' },
    { pc6: '1441CE', straat: 'Bultstraat', lat: 52.50922941, lng: 4.94754311, buurt: 'Binnenstad', wijk: 'Centrum' },
    { pc6: '1441CR', straat: 'Gouw', lat: 52.50790837, lng: 4.94494327, buurt: 'Binnenstad', wijk: 'Centrum' },
    { pc6: '1441CS', straat: 'Weeshuissteeg', lat: 52.50882811, lng: 4.94766104, buurt: 'Binnenstad', wijk: 'Centrum' },
    { pc6: '1441DH', straat: 'Achterdijk', lat: 52.50969385, lng: 4.94881292, buurt: 'Binnenstad', wijk: 'Centrum' },
    { pc6: '1441GX', straat: 'Neckerdijk', lat: 52.51053192, lng: 4.94390426, buurt: 'Binnenstad', wijk: 'Centrum' },
    // Winkelgebied 2: Stationsbuurt
    { pc6: '1441DN', straat: 'Wolthuissingel', lat: 52.50731688, lng: 4.95188146, buurt: 'Stationsbuurt', wijk: 'Centrum' },
    { pc6: '1441DW', straat: 'Brantjesoever', lat: 52.50763313, lng: 4.95370564, buurt: 'Stationsbuurt', wijk: 'Centrum' },
    { pc6: '1441DX', straat: 'De Burcht', lat: 52.50733765, lng: 4.95487416, buurt: 'Stationsbuurt', wijk: 'Centrum' },
    { pc6: '1441EH', straat: 'Kastanjelaan', lat: 52.50477251, lng: 4.95324555, buurt: 'Stationsbuurt', wijk: 'Centrum' },
    { pc6: '1441EZ', straat: 'Argonaut', lat: 52.5080996, lng: 4.95366496, buurt: 'Stationsbuurt', wijk: 'Centrum' },
    { pc6: '1441ZZ', straat: 'Robiniastate', lat: 52.50592605, lng: 4.95093024, buurt: 'Stationsbuurt', wijk: 'Centrum' },
    { pc6: '1442BZ', straat: 'Burgemeester D. Kooimanweg', lat: 52.50692048, lng: 4.95608798, buurt: 'Stationsbuurt', wijk: 'Centrum' },
    // Winkelgebied 3: Zuiderpolder
    { pc6: '1441DZ', straat: 'Dahliastraat', lat: 52.50490619, lng: 4.95011002, buurt: 'Zuiderpolder', wijk: 'Centrum' },
    { pc6: '1441EJ', straat: 'Stationsweg', lat: 52.50380347, lng: 4.95402086, buurt: 'Zuiderpolder', wijk: 'Centrum' },
    { pc6: '1441EL', straat: 'Wilhelminalaan', lat: 52.50541073, lng: 4.95006335, buurt: 'Zuiderpolder', wijk: 'Centrum' },
    { pc6: '1441ER', straat: 'Julianastraat', lat: 52.50599974, lng: 4.94833034, buurt: 'Zuiderpolder', wijk: 'Centrum' },
    { pc6: '1441GE', straat: 'Vooruitstraat', lat: 52.50708128, lng: 4.9447462, buurt: 'Zuiderpolder', wijk: 'Centrum' },
    { pc6: '1441HB', straat: 'Primulastraat', lat: 52.50395256, lng: 4.9526351, buurt: 'Zuiderpolder', wijk: 'Centrum' },
    { pc6: '1441HC', straat: 'Primulastraat', lat: 52.50281031, lng: 4.95080388, buurt: 'Zuiderpolder', wijk: 'Centrum' },
    { pc6: '1441HD', straat: 'Irisplein', lat: 52.50207521, lng: 4.9502172, buurt: 'Zuiderpolder', wijk: 'Centrum' },
    { pc6: '1441HK', straat: 'Anjelierenstraat', lat: 52.503391, lng: 4.95093474, buurt: 'Zuiderpolder', wijk: 'Centrum' },
    { pc6: '1441HM', straat: 'Jan van Egmondstraat', lat: 52.50476865, lng: 4.9500664, buurt: 'Zuiderpolder', wijk: 'Centrum' },
    { pc6: '1441HS', straat: 'Chrysanthenstraat', lat: 52.50294002, lng: 4.9482978, buurt: 'Zuiderpolder', wijk: 'Centrum' },
    { pc6: '1441JA', straat: 'Asterstraat', lat: 52.50370623, lng: 4.94788112, buurt: 'Zuiderpolder', wijk: 'Centrum' },
    { pc6: '1441JX', straat: 'Jasmijnstraat', lat: 52.5044841, lng: 4.94724939, buurt: 'Zuiderpolder', wijk: 'Centrum' },
    { pc6: '1441PA', straat: 'Jaagweg', lat: 52.50596666, lng: 4.9448902, buurt: 'Zuiderpolder', wijk: 'Centrum' },
    // Winkelgebied 4: Gors
    { pc6: '1441BW', straat: 'Beatrixplein', lat: 52.50382737, lng: 4.95571851, buurt: 'Gors-Noord', wijk: 'Gors' },
    { pc6: '1441BX', straat: 'Beatrixplein', lat: 52.50379431, lng: 4.95604759, buurt: 'Gors-Noord', wijk: 'Gors' },
    { pc6: '1441RD', straat: 'De Oeverlanden', lat: 52.50650382, lng: 4.9576097, buurt: 'Gors-Zuid', wijk: 'Gors' },
    { pc6: '1441RK', straat: 'Pinksterbloem', lat: 52.49620193, lng: 4.95090142, buurt: 'Gors-Zuid', wijk: 'Gors' },
    { pc6: '1441SX', straat: 'Reigersbek', lat: 52.4970939, lng: 4.95354858, buurt: 'Gors-Zuid', wijk: 'Gors' },
    { pc6: '1441VM', straat: 'Hoefblad', lat: 52.49341997, lng: 4.95696655, buurt: 'Gors-Noord', wijk: 'Gors' },
    { pc6: '1441WB', straat: 'Beemdgras', lat: 52.49074268, lng: 4.95688836, buurt: 'Gors-Zuid', wijk: 'Gors' },
    { pc6: '1441XC', straat: 'Speenkruid', lat: 52.49291436, lng: 4.94972888, buurt: 'Gors-Noord', wijk: 'Gors' },
    { pc6: '1441XE', straat: 'Herikkruid', lat: 52.48997796, lng: 4.95255024, buurt: 'Gors-Noord', wijk: 'Gors' },
    { pc6: '1441ZC', straat: 'Markerkade', lat: 52.50379081, lng: 4.9610242, buurt: 'Gors-Noord', wijk: 'Gors' },
    // Winkelgebied 5: Overwhere
    { pc6: '1442RH', straat: 'Waalstraat', lat: 52.5149734, lng: 4.95779478, buurt: 'Overwhere-Zuid', wijk: 'Overwhere' },
    { pc6: '1442TL', straat: 'Kolfstraat', lat: 52.51754384, lng: 4.96637347, buurt: 'Overwhere-Zuid', wijk: 'Overwhere' },
    { pc6: '1442WJ', straat: 'Hooft Hasselaarstraat', lat: 52.51332626, lng: 4.96466944, buurt: 'Overwhere-Zuid', wijk: 'Overwhere' },
    { pc6: '1442WR', straat: 'Tutein Noltheniusplein', lat: 52.51274171, lng: 4.96079125, buurt: 'Overwhere-Nord', wijk: 'Overwhere' },
    { pc6: '1444GH', straat: 'Paltrokmolen', lat: 52.52062409, lng: 4.97259404, buurt: 'Molenkoog', wijk: 'Overwhere' },
    { pc6: '1444GW', straat: 'Stellingmolen', lat: 52.52124888, lng: 4.97424912, buurt: 'Molenkoog', wijk: 'Overwhere' },
    { pc6: '1444GZ', straat: 'Wipmolen', lat: 52.52036527, lng: 4.97568802, buurt: 'Molenkoog', wijk: 'Overwhere' },
    { pc6: '1444HM', straat: 'Gebr. Conijnstraat', lat: 52.52184453, lng: 4.96582361, buurt: 'Overwhere-Zuid', wijk: 'Overwhere' },
    { pc6: '1444TG', straat: 'Rietgorsplein', lat: 52.52038848, lng: 4.96240252, buurt: 'Overwhere-Nord', wijk: 'Overwhere' },
    { pc6: '1444VP', straat: 'Aalscholverstraat', lat: 52.52335161, lng: 4.95770029, buurt: 'Molenkoog', wijk: 'Overwhere' },
    // Winkelgebied 6: Wheelmolen
    { pc6: '1443BT', straat: 'Aurigapark', lat: 52.50786031, lng: 4.96339942, buurt: 'Wheelmolen-West', wijk: 'Wheelmolen' },
    { pc6: '1443EC', straat: 'John F. Kennedyplein', lat: 52.50835911, lng: 4.96863196, buurt: 'Wheelmolen-Oost', wijk: 'Wheelmolen' },
    { pc6: '1443EK', straat: 'Boeierstraat', lat: 52.51128821, lng: 4.97013425, buurt: 'Wheelmolen-West', wijk: 'Wheelmolen' },
    { pc6: '1443HV', straat: 'Anne Franklaan', lat: 52.51169486, lng: 4.97452174, buurt: 'Wheelmolen-Oost', wijk: 'Wheelmolen' },
    { pc6: '1443JL', straat: 'Tjalkstraat', lat: 52.51031325, lng: 4.97534392, buurt: 'Wheelmolen-West', wijk: 'Wheelmolen' },
    { pc6: '1443KD', straat: 'Gouwzeestraat', lat: 52.50850454, lng: 4.97795391, buurt: 'Wheelmolen-Oost', wijk: 'Wheelmolen' },
    { pc6: '1443LR', straat: 'Johan Wagenaarstraat', lat: 52.50521018, lng: 4.96965751, buurt: 'Wheelmolen-West', wijk: 'Wheelmolen' },
    { pc6: '1443LS', straat: 'Johan Wagenaarstraat', lat: 52.50556702, lng: 4.96704097, buurt: 'Wheelmolen-Oost', wijk: 'Wheelmolen' },
    { pc6: '1443VM', straat: 'Mercuriusweg', lat: 52.50754563, lng: 4.967038, buurt: 'Wheelmolen-Oost', wijk: 'Wheelmolen' },
    { pc6: '1443XM', straat: 'Citerstraat', lat: 52.50743244, lng: 4.97655058, buurt: 'Wheelmolen-West', wijk: 'Wheelmolen' },
    // Winkelgebied 7: Purmer-Noord
    { pc6: '1445JR', straat: 'Etserstraat', lat: 52.50211666, lng: 4.97993892, buurt: 'Werktuigenbuurt', wijk: 'Purmer-Noord' },
    { pc6: '1445KJ', straat: 'Zuivelpad', lat: 52.50059365, lng: 4.98335174, buurt: 'Maten- en Zuivelbuurt', wijk: 'Purmer-Noord' },
    { pc6: '1445MJ', straat: 'Zuivelstraat', lat: 52.49881787, lng: 4.98255989, buurt: 'Maten- en Zuivelbuurt', wijk: 'Purmer-Noord' },
    { pc6: '1445NM', straat: 'Jachtwagenstraat', lat: 52.49931627, lng: 4.97720162, buurt: 'Maten- en Zuivelbuurt', wijk: 'Purmer-Noord' },
    { pc6: '1445SL', straat: 'Lamoenstraat', lat: 52.50793668, lng: 4.98043885, buurt: 'Werktuigenbuurt', wijk: 'Purmer-Noord' },
    { pc6: '1445SN', straat: 'Lamoenstraat', lat: 52.50833826, lng: 4.98045677, buurt: 'Werktuigenbuurt', wijk: 'Purmer-Noord' },
    { pc6: '1446AT', straat: 'Fuikstraat', lat: 52.51833264, lng: 5.01088596, buurt: 'Baanstee en omgeving', wijk: 'Purmer-Noord' },
    { pc6: '1446HZ', straat: 'Grotenhuysweg', lat: 52.51198331, lng: 4.99328205, buurt: 'De Graeffweg en omgeving', wijk: 'Purmer-Noord' },
    { pc6: '1446VS', straat: 'Newtonstraat', lat: 52.51404745, lng: 4.99588056, buurt: 'Baanstee en omgeving', wijk: 'Purmer-Noord' },
    { pc6: '1446WJ', straat: 'Volume', lat: 52.51165425, lng: 5.00356384, buurt: 'Baanstee en omgeving', wijk: 'Purmer-Noord' },
    // Winkelgebied 8: Purmer-Zuid
    { pc6: '1447GK', straat: 'Cornelis Edelmanstraat', lat: 52.49131779, lng: 4.96220534, buurt: 'Purmer-Zuid/Noord', wijk: 'Purmer-Zuid' },
    { pc6: '1447JJ', straat: 'Kinselmeer', lat: 52.49542571, lng: 4.97084097, buurt: 'Purmer-Zuid/Noord', wijk: 'Purmer-Zuid' },
    { pc6: '1447KE', straat: 'Meerland', lat: 52.49353697, lng: 4.97247023, buurt: 'Purmer-Zuid/Noord', wijk: 'Purmer-Zuid' },
    { pc6: '1447NG', straat: 'Monteverdistraat', lat: 52.49124706, lng: 4.96889146, buurt: 'Purmer-Zuid/Zuid', wijk: 'Purmer-Zuid' },
    { pc6: '1447NN', straat: 'Da Palestrinastraat', lat: 52.48992712, lng: 4.97083933, buurt: 'Purmer-Zuid/Zuid', wijk: 'Purmer-Zuid' },
    { pc6: '1447NX', straat: 'Da Palestrinastraat', lat: 52.48982858, lng: 4.96931861, buurt: 'Purmer-Zuid/Zuid', wijk: 'Purmer-Zuid' },
    { pc6: '1447RH', straat: 'Brahmsstraat', lat: 52.4880529, lng: 4.96616666, buurt: 'Purmer-Zuid/Noord', wijk: 'Purmer-Zuid' },
    { pc6: '1447TJ', straat: 'Speulderbos', lat: 52.4917737, lng: 4.9761784, buurt: 'Purmer-Zuid/Noord', wijk: 'Purmer-Zuid' },
    { pc6: '1447WX', straat: 'Malibongwestraat', lat: 52.48822206, lng: 4.95804917, buurt: 'Purmer-Zuid/Zuid', wijk: 'Purmer-Zuid' },
    { pc6: '1447ZK', straat: 'Dom Helder Camarastraat', lat: 52.48503256, lng: 4.96641821, buurt: 'Purmer-Zuid/Zuid', wijk: 'Purmer-Zuid' },
    // Winkelgebied 9: Weidevenne
    { pc6: '1441LC', straat: 'Kanaaldijk', lat: 52.51208397, lng: 4.94148069, buurt: 'Hazepolder', wijk: 'Weidevenne' },
    { pc6: '1448AL', straat: 'Bali', lat: 52.49630479, lng: 4.94128562, buurt: 'Azië', wijk: 'Weidevenne' },
    { pc6: '1448DA', straat: 'Indusstraat', lat: 52.49315871, lng: 4.9428635, buurt: 'Azië', wijk: 'Weidevenne' },
    { pc6: '1448GC', straat: 'Borghesepark', lat: 52.49935352, lng: 4.94332228, buurt: 'Europa', wijk: 'Weidevenne' },
    { pc6: '1448KG', straat: 'Piraeushaven', lat: 52.50659779, lng: 4.93980048, buurt: 'Afrika', wijk: 'Weidevenne' },
    { pc6: '1448KL', straat: 'Marseillehaven', lat: 52.5054717, lng: 4.9406096, buurt: 'Afrika', wijk: 'Weidevenne' },
    { pc6: '1448MG', straat: 'Masaistraat', lat: 52.49251393, lng: 4.93183351, buurt: 'Azië', wijk: 'Weidevenne' },
    { pc6: '1448MT', straat: 'Port Saidweg', lat: 52.49302237, lng: 4.92943517, buurt: 'Europa', wijk: 'Weidevenne' },
    { pc6: '1448PE', straat: 'Woestijnstraat', lat: 52.49232993, lng: 4.93758373, buurt: 'Hazepolder', wijk: 'Weidevenne' },
    { pc6: '1448RE', straat: 'Bloemfontein', lat: 52.49061832, lng: 4.93626795, buurt: 'Afrika', wijk: 'Weidevenne' },
    // Winkelgebied 10: Beemster
    { pc6: '1461AR', straat: 'Gerrit Köhnestraat', lat: 52.5152778, lng: 4.93792644, buurt: 'Westbeemster', wijk: 'Beemster' },
    { pc6: '1461DW', straat: 'Kwadijkerweg', lat: 52.53463021, lng: 4.9548548, buurt: 'Middenbeemster', wijk: 'Beemster' },
    { pc6: '1461GK', straat: 'Zuiderweg', lat: 52.51770251, lng: 4.92519541, buurt: 'Zuidoostbeemster', wijk: 'Beemster' },
    { pc6: '1462EC', straat: 'Loeffendijk', lat: 52.54945413, lng: 4.92163714, buurt: 'Westbeemster', wijk: 'Beemster' },
    { pc6: '1462GK', straat: 'De Lijnbaan', lat: 52.55002222, lng: 4.91888011, buurt: 'Westbeemster', wijk: 'Beemster' },
    { pc6: '1462HM', straat: 'Middenweg', lat: 52.54342917, lng: 4.90923788, buurt: 'Middenbeemster', wijk: 'Beemster' },
    { pc6: '1462KD', straat: 'Fabritiusstraat', lat: 52.55035219, lng: 4.9107406, buurt: 'Zuidoostbeemster', wijk: 'Beemster' },
    { pc6: '1462NL', straat: 'Belvliet', lat: 52.54787719, lng: 4.91560091, buurt: 'Westbeemster', wijk: 'Beemster' },
    { pc6: '1464LH', straat: 'Hobrederweg', lat: 52.5698074, lng: 4.89543021, buurt: 'Middenbeemster', wijk: 'Beemster' },
    { pc6: '1464NC', straat: 'Wormerweg', lat: 52.5388056, lng: 4.85823968, buurt: 'Westbeemster', wijk: 'Beemster' }
  ];

  // Winkelgebieden configuration with real addresses
  const WINKELGEBIEDEN = [
    {
      naam: 'Purmerend Centrum / Eggert',
      type: 'binnenstad_middelgroot',
      addresses: ADDRESSES.filter(a => ['1441AD','1441AP','1441AT','1441BL','1441CE','1441CR','1441CS','1441DH','1441GX'].includes(a.pc6)),
      profiel: ['47.150.200','47.190.200','47.520.200','47.300.200','47.420.200','47.640.200','56.300.200','95.110.100','47.610.100','47.750.200'],
      range: [12, 18]
    },
    {
      naam: 'Stationsbuurt',
      type: 'kernverzorgend',
      addresses: ADDRESSES.filter(a => ['1441DN','1441DW','1441DX','1441EH','1441EZ','1441ZZ','1442BZ'].includes(a.pc6)),
      profiel: ['11.010.111','47.520.200','95.110.100','56.300.200','47.640.200','59.210.215','47.760.100'],
      range: [6, 12]
    },
    {
      naam: 'Zuiderpolder',
      type: 'buurtcentrum',
      addresses: ADDRESSES.filter(a => ['1441DZ','1441EJ','1441EL','1441ER','1441GE','1441HB','1441HC','1441HD','1441HK','1441HM','1441HS','1441JA','1441JX','1441PA'].includes(a.pc6)),
      profiel: ['11.010.111','11.010.005','95.110.100','96.020.200','56.300.200','47.640.200','65.260.230'],
      range: [3, 7]
    },
    {
      naam: 'Gors',
      type: 'buurtcentrum',
      addresses: ADDRESSES.filter(a => ['1441BW','1441BX','1441RD','1441RK','1441SX','1441VM','1441WB','1441XC','1441XE','1441ZC'].includes(a.pc6)),
      profiel: ['11.010.111','96.020.200','47.640.200','56.300.200','95.110.100'],
      range: [3, 7]
    },
    {
      naam: 'Overwhere',
      type: 'wijkcentrum',
      addresses: ADDRESSES.filter(a => ['1442RH','1442TL','1442WJ','1442WR','1444GH','1444GW','1444GZ','1444HM','1444TG','1444VP'].includes(a.pc6)),
      profiel: ['47.150.200','47.520.200','11.010.111','56.300.200','47.640.200','95.110.100','47.300.200','47.410.200'],
      range: [6, 12]
    },
    {
      naam: 'Wheelmolen',
      type: 'wijkcentrum',
      addresses: ADDRESSES.filter(a => ['1443BT','1443EC','1443EK','1443HV','1443JL','1443KD','1443LR','1443LS','1443VM','1443XM'].includes(a.pc6)),
      profiel: ['47.150.200','47.520.200','47.640.200','47.300.200','56.300.200','95.110.100','65.260.230'],
      range: [6, 14],
      monoculture: true // Special monoculture clusters for Wheelmolen
    },
    {
      naam: 'Purmer-Noord',
      type: 'verspreide_bewinkeling',
      addresses: ADDRESSES.filter(a => ['1445JR','1445KJ','1445MJ','1445NM','1445SL','1445SN','1446AT','1446HZ','1446VS','1446WJ'].includes(a.pc6)),
      profiel: ['47.520.200','45.110.100','45.200.300','11.010.111','95.110.100'],
      range: [2, 5],
      vulnerableAreas: ['1446AT','1446VS','1446WJ'] // Baanstee area with vulnerable branches
    },
    {
      naam: 'Purmer-Zuid',
      type: 'buurtcentrum',
      addresses: ADDRESSES.filter(a => ['1447GK','1447JJ','1447KE','1447NG','1447NN','1447NX','1447RH','1447TJ','1447WX','1447ZK'].includes(a.pc6)),
      profiel: ['11.010.111','11.010.005','47.520.200','96.020.200','56.300.200','47.750.200'],
      range: [3, 7]
    },
    {
      naam: 'Weidevenne',
      type: 'verspreide_bewinkeling',
      addresses: ADDRESSES.filter(a => ['1441LC','1448AL','1448DA','1448GC','1448KG','1448KL','1448MG','1448MT','1448PE','1448RE'].includes(a.pc6)),
      profiel: ['11.010.111','95.110.100','56.300.200','47.520.200'],
      range: [2, 5]
    },
    {
      naam: 'Beemster',
      type: 'verspreide_bewinkeling',
      addresses: ADDRESSES.filter(a => ['1461AR','1461DW','1461GK','1462EC','1462GK','1462HM','1462KD','1462NL','1464LH','1464NC'].includes(a.pc6)),
      profiel: ['11.010.111','47.520.200'],
      range: [1, 3]
    }
  ];

  const pc6Areas = new Map();
  const branchInstances = [];

  for (const wg of WINKELGEBIEDEN) {
    for (const addr of wg.addresses) {
      const pc6 = addr.pc6;
      const lat = addr.lat + (Math.random() - 0.5) * 0.0008;
      const lng = addr.lng + (Math.random() - 0.5) * 0.0008;
      const straat = addr.straat;
      const buurt = addr.buurt;
      const wijk = addr.wijk;

      const [minB, maxB] = wg.range;
      const numB = minB + Math.floor(Math.random() * (maxB - minB + 1));
      const codes = [];

      // Add regular branches
      for (let j = 0; j < numB; j++) {
        const code = wg.profiel[Math.floor(Math.random() * wg.profiel.length)];
        codes.push(code);
        const br = allBranches.find(b => b.code === code);
        branchInstances.push({ pc6, branchCode: code, branchName: br ? br.name : code, address: `${straat} ${1 + Math.floor(Math.random() * 100)}` });
      }

      // Add monoculture clusters for specific areas
      if (wg.monoculture && addr.pc6 === '1443EC') {
        // John F. Kennedyplein: 4x kapper cluster
        for (let k = 0; k < 4; k++) {
          codes.push('65.260.230');
          branchInstances.push({ pc6, branchCode: '65.260.230', branchName: 'Kapper', address: `${straat} ${100+k}` });
        }
      }
      if (wg.monoculture && addr.pc6 === '1443VM') {
        // Mercuriusweg: 4x telecom cluster
        for (let k = 0; k < 4; k++) {
          codes.push('47.640.200');
          const tb = allBranches.find(b => b.code === '47.640.200');
          branchInstances.push({ pc6, branchCode: '47.640.200', branchName: tb ? tb.name : 'Telecom', address: `${straat} ${100+k}` });
        }
      }

      // Add vulnerable branches for Purmer-Noord Baanstee area
      if (wg.vulnerableAreas && wg.vulnerableAreas.includes(addr.pc6)) {
        if (Math.random() > 0.4) {
          codes.push('66.000.150');
          branchInstances.push({ pc6, branchCode: '66.000.150', branchName: 'Geldtransfer', address: `${straat} ${200}` });
        }
        if (Math.random() > 0.6) {
          codes.push('00.000.000');
          branchInstances.push({ pc6, branchCode: '00.000.000', branchName: 'Leegstand', address: `${straat} ${201}` });
        }
      }

      // Calculate scores
      const areaScores = BQ.calculateAreaScores(codes);
      const monoIndex = BQ.calculateMonocultureIndex(codes);
      const monoClusters = BQ.detectMonocultureClusters(codes);
      const opportunityProfile = BQ.calculateAreaOpportunityProfile(codes);
      const areaContext = {
        leegstandsPercentage: codes.filter(c => c === '00.000.000').length / codes.length * 100,
        avondeconomie: wg.type === 'binnenstad_middelgroot',
        nabijheidSnelweg: false,
        nabijheidGrens: false,
        vervoersknooppunt: wijk === 'Centrum',
        woonfunctieAandeel: wg.type === 'verspreide_bewinkeling' ? 30 : (wg.type === 'binnenstad_middelgroot' ? 25 : 35 + Math.random() * 25)
      };
      const environmentalRisk = BQ.calculateEnvironmentalRisk(codes, areaContext);
      const barrierProfile = BQ.generateBarrierProfile(codes);

      // Score modifiers per type
      let typeBonus = 0;
      if (wg.type === 'binnenstad_middelgroot') typeBonus = 1.2;
      else if (wg.type === 'kernverzorgend') typeBonus = 0.5;
      else if (wg.type === 'wijkcentrum') typeBonus = 0.8;
      else if (wg.type === 'verspreide_bewinkeling') typeBonus = -0.5;

      // Smaller noise for more consistent scoring
      const noise = (Math.random() - 0.5) * 0.8;

      const eco = Math.max(1, Math.min(10, areaScores.qualityScore + typeBonus + noise));
      const saf = Math.max(1, Math.min(10, 10 - areaScores.vulnerabilityScore * 0.7 + (Math.random() - 0.5) * 0.8));
      const soc = Math.max(1, Math.min(10, 5 + typeBonus * 0.5 + (Math.random() - 0.5) * 0.8));
      const spa = Math.max(1, Math.min(10, 5.5 + typeBonus + (Math.random() - 0.5) * 0.8));
      const und = Math.max(1, Math.min(10, 10 - areaScores.vulnerabilityScore * 0.8 + (Math.random() - 0.5) * 0.8));

      const w = AppState.weights;
      const tw = w.economic + w.safety + w.social + w.spatial + w.undermining;
      const vi = (eco * w.economic + saf * w.safety + soc * w.social + spa * w.spatial + und * w.undermining) / tw;

      pc6Areas.set(pc6, {
        pc6, lat, lng, street: straat, neighborhood: buurt, district: wijk, municipality: 'Purmerend',
        winkelgebied: wg.naam, shoppingAreaType: wg.type,
        branches: codes, branchCount: codes.length, areaContext,
        scores: {
          economic: Math.round(eco * 10) / 10,
          safety: Math.round(saf * 10) / 10,
          social: Math.round(soc * 10) / 10,
          spatial: Math.round(spa * 10) / 10,
          undermining: Math.round(und * 10) / 10,
          vitalityIndex: Math.round(vi * 10) / 10,
          qualityAvg: areaScores.qualityScore,
          vulnerabilityAvg: areaScores.vulnerabilityScore,
          monocultureIndex: monoIndex,
          monocultureClusters: monoClusters,
          opportunityProfile,
          environmentalRisk,
          barrierProfile
        },
        additionalData: {
          leegstand: { count: codes.filter(c => c === '00.000.000').length, percentage: Math.round(codes.filter(c => c === '00.000.000').length / codes.length * 100) },
          brpInwoners: 80 + Math.floor(Math.random() * 350),
          milieucontroles: { count: Math.floor(Math.random() * 4), overtredingen: Math.floor(Math.random() * 2) },
          vergunningenLopend: Math.floor(Math.random() * 4),
          schouwScoreGemiddeld: Math.round((5 + Math.random() * 4) * 10) / 10,
          pandScoreGemiddeld: Math.round((4.5 + Math.random() * 4.5) * 10) / 10,
          kvkRegistraties: 3 + Math.floor(Math.random() * 40),
          lisaVestigingen: 2 + Math.floor(Math.random() * 25),
          criminaliteitsIndex: Math.round((1.5 + Math.random() * 6) * 10) / 10,
          interventiesOndermijning: Math.floor(Math.random() * 3)
        }
      });
    }
  }

  AppState.data.pc6Areas = pc6Areas;
  AppState.data.branchInstances = branchInstances;
  AppState.data.loaded = true;

  updateDataStatus();
  populateLocationFilters();
  renderMap();
  renderBranchList();
}

// ============================================================
// MAP
// ============================================================
function initMap() {
  AppState.map = L.map('map', {
    center: [52.5075, 4.9530], // Purmerend Centrum
    zoom: 14,
    zoomControl: true
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap',
    maxZoom: 19
  }).addTo(AppState.map);
}

function renderMap() {
  // Wis eventuele branch-highlight bij het opnieuw renderen
  if (AppState.branchHighlight) {
    AppState.branchHighlight.highlightMarkers.forEach(m => m.remove());
    AppState.branchHighlight = null;
    const banner = document.querySelector('.branch-highlight-banner');
    if (banner) banner.remove();
  }

  const BQ = window.BranchQualifications;
  // Clear existing markers
  AppState.circleMarkers.forEach(m => m.remove());
  AppState.circleMarkers = [];

  if (!AppState.data.loaded) return;

  AppState.data.pc6Areas.forEach((area, pc6) => {
    // Filter op gebiedsniveau
    const f = AppState.filters;
    if (f.pc6 && !pc6.toUpperCase().startsWith(f.pc6)) return;
    if (f.street && area.street !== f.street) return;
    if (f.neighborhood && area.neighborhood !== f.neighborhood) return;
    if (f.district && area.district !== f.district) return;
    if (f.shoppingArea && area.winkelgebied !== f.shoppingArea) return;

    // Hoofdbranche filter op gebiedsniveau
    if (f.mainBranch) {
      const areaHasBranch = area.branches.some(code => code.startsWith(f.mainBranch));
      if (!areaHasBranch) return;
    }

    // Kwetsbaarheden chip-filter: toon alleen gebieden met branches die geselecteerde kwetsbaarheden bevatten
    if (f.vulnerabilityTypes.length > 0) {
      const areaHasVuln = area.branches.some(code => {
        const br = BQ.findBranchByCode(code);
        return br && f.vulnerabilityTypes.some(vt => br.vulnerabilityTypes.includes(vt));
      });
      if (!areaHasVuln) return;
    }

    // Kwaliteiten chip-filter: toon alleen gebieden met branches die geselecteerde kwaliteiten bevatten
    if (f.qualityTags.length > 0) {
      const areaHasQual = area.branches.some(code => {
        const br = BQ.findBranchByCode(code);
        return br && f.qualityTags.some(qt => br.qualityTags.includes(qt));
      });
      if (!areaHasQual) return;
    }

    // Gelegenheidsstructuren chip-filter (JenV): toon alleen gebieden met branches die geselecteerde factoren bevatten
    if (f.opportunityFactors.length > 0) {
      const areaHasOpp = area.branches.some(code => {
        const br = BQ.findBranchByCode(code);
        return br && f.opportunityFactors.some(of => br.opportunityFactors.includes(of));
      });
      if (!areaHasOpp) return;
    }

    // Monocultuurrisico filter op gebiedsniveau
    if (f.monocultureRiskOnly) {
      const hasMono = area.scores.monocultureClusters && area.scores.monocultureClusters.length > 0;
      if (!hasMono) return;
    }

    // Kwaliteitsscore-bereik op gebiedsniveau
    if (f.qualityMin !== null && area.scores.qualityAvg < f.qualityMin) return;
    if (f.qualityMax !== null && area.scores.qualityAvg > f.qualityMax) return;

    // Kwetsbaarheidsscore-bereik op gebiedsniveau
    if (f.vulnMin !== null && area.scores.vulnerabilityAvg < f.vulnMin) return;
    if (f.vulnMax !== null && area.scores.vulnerabilityAvg > f.vulnMax) return;

    const score = area.scores.vitalityIndex;
    const color = getScoreColor(score);
    const isMono = area.scores.monocultureClusters && area.scores.monocultureClusters.length > 0;

    const radius = AppState.ui.showMonoculture && isMono ? 30 : 20;
    const borderColor = AppState.ui.showMonoculture && isMono ? 'var(--color-warning)' : color;

    const marker = L.circleMarker([area.lat, area.lng], {
      radius: radius / 2,
      fillColor: color,
      color: borderColor,
      weight: AppState.ui.showMonoculture && isMono ? 3 : 1,
      opacity: 0.9,
      fillOpacity: 0.7
    }).addTo(AppState.map);

    // Top 3 branches met namen
    const branchCounts = {};
    area.branches.forEach(code => { branchCounts[code] = (branchCounts[code] || 0) + 1; });
    const topBranches = Object.entries(branchCounts)
      .sort((a, b) => b[1] - a[1]).slice(0, 3)
      .map(([code, cnt]) => { const br = BQ.findBranchByCode(code); return `${br ? br.name : code} (${cnt}×)`; })
      .join(', ');

    marker.bindTooltip(`
      <strong>${pc6}</strong> — ${area.street}<br>
      ${area.winkelgebied || ''}<br>
      Vitaliteitsindex: <strong>${score}</strong><br>
      ${area.branchCount} vestigingen: ${topBranches}
      ${isMono ? '<br>⚠ Monocultuur gedetecteerd' : ''}
    `, { direction: 'top', className: '' });

    marker.on('click', () => selectArea(pc6));

    AppState.circleMarkers.push(marker);
  });

  // Fit bounds
  if (AppState.circleMarkers.length > 0) {
    const group = L.featureGroup(AppState.circleMarkers);
    AppState.map.fitBounds(group.getBounds().pad(0.1));
  }
}

function highlightBranchOnMap(branchCode) {
  // Verwijder bestaande highlight
  clearBranchHighlight();

  const BQ = window.BranchQualifications;
  const branchInfo = BQ ? BQ.findBranchByCode(branchCode) : null;
  const branchName = branchInfo ? branchInfo.name : branchCode;

  const matchingAreas = [];
  const highlightMarkers = [];

  AppState.data.pc6Areas.forEach((area, pc6) => {
    if (area.branches && area.branches.includes(branchCode)) {
      matchingAreas.push({ pc6, area });
    }
  });

  if (matchingAreas.length === 0) return;

  // Dim all existing markers
  AppState.circleMarkers.forEach(m => {
    m.setStyle({ fillOpacity: 0.15, opacity: 0.2 });
  });

  // Add highlight markers for matching areas
  matchingAreas.forEach(({ pc6, area }) => {
    const marker = L.circleMarker([area.lat, area.lng], {
      radius: 14,
      fillColor: '#3b82f6',
      color: '#1d4ed8',
      weight: 3,
      opacity: 1,
      fillOpacity: 0.8
    }).addTo(AppState.map);

    const count = area.branches.filter(c => c === branchCode).length;
    marker.bindTooltip(`<strong>${pc6}</strong> — ${area.street}<br>${branchName}: ${count}× aanwezig`, { direction: 'top' });
    marker.on('click', () => selectArea(pc6));

    highlightMarkers.push(marker);
  });

  AppState.branchHighlight = { code: branchCode, name: branchName, highlightMarkers };

  // Fit map to highlighted areas
  if (highlightMarkers.length > 0) {
    const group = L.featureGroup(highlightMarkers);
    AppState.map.fitBounds(group.getBounds().pad(0.2));
  }

  // Show banner
  showBranchHighlightBanner(branchName, matchingAreas.length);
}

function clearBranchHighlight() {
  if (!AppState.branchHighlight) return;

  // Remove highlight markers
  AppState.branchHighlight.highlightMarkers.forEach(m => m.remove());

  // Restore original markers
  AppState.circleMarkers.forEach(m => {
    m.setStyle({ fillOpacity: 0.7, opacity: 0.9 });
  });

  AppState.branchHighlight = null;

  // Remove banner
  const banner = document.querySelector('.branch-highlight-banner');
  if (banner) banner.remove();
}

function showBranchHighlightBanner(branchName, count) {
  // Remove existing banner
  const existing = document.querySelector('.branch-highlight-banner');
  if (existing) existing.remove();

  const mapContainer = document.querySelector('.map-container');
  if (!mapContainer) return;

  const banner = document.createElement('div');
  banner.className = 'branch-highlight-banner';
  banner.innerHTML = `
    <span class="branch-highlight-banner__count">${count}</span>
    <span>locatie${count !== 1 ? 's' : ''} met <strong>${branchName}</strong></span>
    <button class="branch-highlight-banner__close" title="Wis markering">✕</button>
  `;

  banner.querySelector('.branch-highlight-banner__close').addEventListener('click', clearBranchHighlight);
  mapContainer.appendChild(banner);
}

function selectArea(pc6) {
  clearBranchHighlight();
  AppState.ui.selectedPc6 = pc6;
  AppState.ui.detailOpen = true;
  const panel = document.getElementById('detailPanel');
  panel.classList.add('detail-panel--open');
  renderDetailPanel(pc6);
}

// ============================================================
// DETAIL PANEL
// ============================================================
function renderDetailPanel(pc6) {
  const area = AppState.data.pc6Areas.get(pc6);
  if (!area) return;

  const BQ = window.BranchQualifications;
  const s = area.scores;

  document.getElementById('detailTitle').textContent = `${pc6} — ${area.street}`;

  const branchDetails = area.branches.map(code => BQ.findBranchByCode(code)).filter(Boolean);

  document.getElementById('detailContent').innerHTML = `
    <div class="stats-grid">
      <div class="stat-box">
        <div class="stat-box__value ${getScoreClass(s.vitalityIndex)}">${s.vitalityIndex}</div>
        <div class="stat-box__label">Vitaliteitsindex</div>
      </div>
      <div class="stat-box">
        <div class="stat-box__value">${area.branchCount}</div>
        <div class="stat-box__label">Branches</div>
      </div>
      <div class="stat-box">
        <div class="stat-box__value ${getScoreClass(s.undermining)}">${s.undermining}</div>
        <div class="stat-box__label">Weerbaarheid</div>
      </div>
      <div class="stat-box">
        <div class="stat-box__value ${s.monocultureIndex >= 6 ? 'color-orange' : 'color-green'}">${s.monocultureIndex}</div>
        <div class="stat-box__label">Monocultuur</div>
      </div>
      <div class="stat-box">
        <div class="stat-box__value ${getScoreClass(10 - (s.opportunityProfile?.averageOpportunityScore || 5))}">${s.opportunityProfile?.averageOpportunityScore || '—'}</div>
        <div class="stat-box__label">Gelegenheid (JenV)</div>
      </div>
      <div class="stat-box">
        <div class="stat-box__value ${getScoreClass(10 - (s.environmentalRisk?.riskScore || 5))}">${s.environmentalRisk?.riskScore || '—'}</div>
        <div class="stat-box__label">Omgeving (CCV)</div>
      </div>
    </div>

    <!-- Dimension Scores -->
    <div class="sidebar__section-title mb-8">Dimensiescores</div>
    ${renderScoreBar('Economisch', s.economic)}
    ${renderScoreBar('Veiligheid', s.safety)}
    ${renderScoreBar('Sociaal', s.social)}
    ${renderScoreBar('Ruimtelijk', s.spatial)}
    ${renderScoreBar('Ondermijning', s.undermining)}

    <!-- Score Explanation -->
    ${renderScoreExplanation(area)}

    <!-- Tabs -->
    <div class="section-tabs">
      <div class="section-tab section-tab--active" data-detail-tab="scores">Scores</div>
      <div class="section-tab" data-detail-tab="opportunity">Gelegenheid</div>
      <div class="section-tab" data-detail-tab="environment">Omgeving</div>
      <div class="section-tab" data-detail-tab="barrier">Barrière</div>
    </div>

    <!-- Tab: Scores -->
    <div class="tab-content tab-content--active" id="tabScores">
      <!-- Monoculture Alerts -->
      ${s.monocultureClusters && s.monocultureClusters.length > 0 ? `
        <div class="sidebar__section-title mb-8">⚠ Monocultuur</div>
        ${s.monocultureClusters.map(c => `
          <div class="mono-alert">
            <div class="mono-alert__title">${c.category.replace(/_/g, ' ')} (${c.count}×)</div>
            <div class="mono-alert__text">Clustering van ${c.count} gelijksoortige branches gedetecteerd. Nader onderzoek aanbevolen.</div>
          </div>
        `).join('')}
      ` : ''}

      <!-- Branch List -->
      <div class="sidebar__section-title mb-8" style="margin-top:16px">Branches in gebied</div>
      ${branchDetails.map(b => `
        <div class="branch-item" data-branch-code="${b.code}">
          <div class="branch-item__dot" style="background:${getScoreColor(b.qualityScore)}"></div>
          <div class="branch-item__name">${b.name}</div>
          <div class="branch-item__scores">
            <span class="branch-item__quality">K${b.qualityScore}</span>
            <span class="branch-item__vulnerability">V${b.vulnerabilityScore}</span>
          </div>
        </div>
      `).join('')}
    </div>

    <!-- Tab: Gelegenheidsstructuren (JenV) -->
    <div class="tab-content" id="tabOpportunity">
      <div class="sidebar__section-title mb-8">Gelegenheidsstructuurprofiel (JenV)</div>
      <div class="stat-box" style="margin-bottom:12px">
        <div class="stat-box__value ${getScoreClass(10 - (s.opportunityProfile?.averageOpportunityScore || 5))}">${s.opportunityProfile?.averageOpportunityScore || '—'}</div>
        <div class="stat-box__label">Gem. gelegenheidsscore</div>
      </div>
      ${s.opportunityProfile?.dominantFactors?.length > 0 ? `
        <div style="font-size:11px;font-weight:600;color:var(--color-text-dim);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em">Dominante factoren</div>
        <div style="margin-bottom:12px">
          ${s.opportunityProfile.dominantFactors.map(f => {
            const isSocial = ['gesloten_gemeenschap','familienetwerken','informele_economie','arbeidsafhankelijkheid','vertrouwensmisbruik'].includes(f.factor);
            return `<span class="opp-badge ${isSocial ? 'opp-badge--social' : 'opp-badge--situation'}">${f.factor.replace(/_/g, ' ')} (${f.frequency}×)</span>`;
          }).join('')}
        </div>
        <div style="font-size:12px;color:var(--color-text-muted);margin-bottom:8px">
          Concentratie-index: <strong style="color:var(--color-text)">${s.opportunityProfile.concentrationIndex}</strong>
          — ${s.opportunityProfile.uniqueFactorCount} unieke factoren, ${s.opportunityProfile.totalFactorInstances} totaal
        </div>
      ` : '<div style="font-size:12px;color:var(--color-text-muted)">Geen significante gelegenheidsstructuren gedetecteerd.</div>'}
      <div style="margin-top:12px;padding:10px;background:var(--color-surface-alt);border-radius:var(--radius);font-size:11px;color:var(--color-text-muted)">
        <strong style="color:var(--color-text)">Bron:</strong> Ministerie van Justitie en Veiligheid — Kader criminogene gelegenheidsstructuren. Situationele en sociale factoren die criminele activiteiten in commerciële omgevingen faciliteren.
      </div>
    </div>

    <!-- Tab: Omgevingsrisico's (CCV) -->
    <div class="tab-content" id="tabEnvironment">
      <div class="sidebar__section-title mb-8">Omgevingsrisicoprofiel (CCV)</div>
      <div class="stats-grid" style="margin-bottom:12px">
        <div class="stat-box">
          <div class="stat-box__value ${getScoreClass(10 - (s.environmentalRisk?.riskScore || 5))}">${s.environmentalRisk?.riskScore || '—'}</div>
          <div class="stat-box__label">Omgevingsrisico</div>
        </div>
        <div class="stat-box">
          <div class="stat-box__value">${s.environmentalRisk?.vulnerableBranchRatio || 0}%</div>
          <div class="stat-box__label">Kwetsbaar aandeel</div>
        </div>
      </div>
      ${s.environmentalRisk?.riskFactors?.length > 0 ? `
        <div style="font-size:11px;font-weight:600;color:var(--color-text-dim);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em">Omgevingsfactoren</div>
        <div style="margin-bottom:12px">
          ${s.environmentalRisk.riskFactors.map(f => `<span class="env-badge">${f.replace(/_/g, ' ')}</span>`).join('')}
        </div>
      ` : ''}
      <div style="font-size:11px;font-weight:600;color:var(--color-text-dim);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em">Gebiedscontext</div>
      <div style="font-size:12px;color:var(--color-text-muted)">
        ${area.areaContext ? `
          Leegstand: ${Math.round(area.areaContext.leegstandsPercentage)}%<br>
          Woonfunctie: ${Math.round(area.areaContext.woonfunctieAandeel)}%<br>
          Avondeconomie: ${area.areaContext.avondeconomie ? 'Ja' : 'Nee'}<br>
          Vervoersknooppunt: ${area.areaContext.vervoersknooppunt ? 'Ja' : 'Nee'}<br>
          Nabijheid snelweg: ${area.areaContext.nabijheidSnelweg ? 'Ja' : 'Nee'}
        ` : 'Geen contextdata beschikbaar'}
      </div>
      <div style="margin-top:12px;padding:10px;background:var(--color-surface-alt);border-radius:var(--radius);font-size:11px;color:var(--color-text-muted)">
        <strong style="color:var(--color-text)">Bron:</strong> CCV — Centrum voor Criminaliteitspreventie en Veiligheid. CPTED-analyse gecombineerd met situationele criminaliteitspreventie en Keurmerk Veilig Ondernemen methodiek.
      </div>
    </div>

    <!-- Tab: Barrièremodel (CCV) -->
    <div class="tab-content" id="tabBarrier">
      <div class="sidebar__section-title mb-8">Barrièremodel (CCV)</div>
      ${s.barrierProfile?.activePhases?.length > 0 ? `
        <div style="font-size:12px;color:var(--color-text-muted);margin-bottom:10px">
          ${s.barrierProfile.activePhases.length} actieve fasen geïdentificeerd.
          Totale blootstelling: ${s.barrierProfile.totalPhaseExposure} branch-fase combinaties.
        </div>
        ${s.barrierProfile.activePhases.map(phase => `
          <div class="barrier-phase">
            <div class="barrier-phase__name">${phase.name}</div>
            <div class="barrier-phase__desc">${phase.description}</div>
            <div class="barrier-phase__count">${phase.branchCount} branches betrokken</div>
          </div>
        `).join('')}
        ${s.barrierProfile.mostVulnerablePhase ? `
          <div style="margin-top:8px;padding:8px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:var(--radius);font-size:12px">
            <strong>Meest kwetsbare fase:</strong> ${s.barrierProfile.mostVulnerablePhase.name}
            (${s.barrierProfile.mostVulnerablePhase.branchCount} branches)
          </div>
        ` : ''}
      ` : '<div style="font-size:12px;color:var(--color-text-muted)">Geen significante barrièremodel-blootstelling gedetecteerd.</div>'}
      <div style="margin-top:12px;padding:10px;background:var(--color-surface-alt);border-radius:var(--radius);font-size:11px;color:var(--color-text-muted)">
        <strong style="color:var(--color-text)">Bron:</strong> CCV Barrièremodel — Fasering van het criminele proces met identificatie van gelegenheden, signalen, faciliteerders en barrières per fase.
      </div>
    </div>

    <!-- Location Info -->
    <div class="sidebar__section-title mb-8" style="margin-top:16px">Locatie</div>
    <div style="font-size:12px;color:var(--color-text-muted)">
      Straat: ${area.street}<br>
      Buurt: ${area.neighborhood}<br>
      Wijk: ${area.district}<br>
      Gemeente: ${area.municipality}<br>
      Winkelgebied: ${(area.shoppingAreaType || 'onbekend').replace(/_/g, ' ')}<br>
      Coördinaten: ${area.lat.toFixed(4)}, ${area.lng.toFixed(4)}
    </div>
  `;

  // Attach click handlers to branch items
  document.querySelectorAll('#detailContent .branch-item').forEach(item => {
    item.addEventListener('click', () => {
      const code = item.dataset.branchCode;
      highlightBranchOnMap(code);
    });
    // Dubbelklik opent het branchedialoog
    item.addEventListener('dblclick', () => {
      const code = item.dataset.branchCode;
      openBranchDialog(code);
    });
  });
}

function renderScoreBar(name, score) {
  return `
    <div class="score-card" style="cursor:default">
      <div class="score-card__header">
        <span class="score-card__name">${name}</span>
        <span class="score-card__score ${getScoreClass(score)}">${score}</span>
      </div>
      <div class="score-card__bar">
        <div class="score-card__bar-fill" style="width:${score * 10}%;background:${getScoreColor(score)}"></div>
      </div>
    </div>
  `;
}

// ============================================================
// SCORE EXPLANATION
// ============================================================
function renderScoreExplanation(area) {
  const s = area.scores;
  const w = AppState.weights;
  const tw = w.economic + w.safety + w.social + w.spatial + w.undermining;

  const dimensions = [
    { key: 'economic', name: 'Economische vitaliteit', score: s.economic, weight: w.economic,
      explain: buildEconomicExplanation(area) },
    { key: 'safety', name: 'Veiligheid', score: s.safety, weight: w.safety,
      explain: buildSafetyExplanation(area) },
    { key: 'social', name: 'Sociale vitaliteit', score: s.social, weight: w.social,
      explain: buildSocialExplanation(area) },
    { key: 'spatial', name: 'Ruimtelijke kwaliteit', score: s.spatial, weight: w.spatial,
      explain: buildSpatialExplanation(area) },
    { key: 'undermining', name: 'Ondermijningsweerbaarheid', score: s.undermining, weight: w.undermining,
      explain: buildUnderminingExplanation(area) }
  ];

  const contributions = dimensions.map(d => ({
    ...d,
    weightPct: tw > 0 ? Math.round(d.weight / tw * 100) : 0,
    contrib: tw > 0 ? Math.round(d.score * d.weight / tw * 100) / 100 : 0
  }));

  const calculatedVI = tw > 0
    ? Math.round(contributions.reduce((sum, c) => sum + c.score * c.weight, 0) / tw * 10) / 10
    : 0;

  const formulaParts = contributions.map(c =>
    `${c.score} × ${c.weightPct}%`
  ).join(' + ');

  return `
    <div class="score-explain" id="scoreExplainBlock">
      <div class="score-explain__toggle" onclick="document.getElementById('scoreExplainBlock').classList.toggle('score-explain--open')">
        <span class="score-explain__toggle-label">ℹ️ Hoe komt deze score tot stand?</span>
        <span class="score-explain__toggle-icon">▼</span>
      </div>
      <div class="score-explain__body">
        <div style="font-size:11px;font-weight:600;color:var(--color-text-dim);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em">Berekeningsformule</div>
        <div class="score-explain__formula">
          Vitaliteitsindex = Σ (dimensiescore × gewicht) / Σ gewichten<br>
          = (${formulaParts}) / 100<br>
          = <strong>${calculatedVI}</strong>
        </div>

        <div style="font-size:11px;font-weight:600;color:var(--color-text-dim);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em">Bijdrage per dimensie</div>
        <div style="margin-bottom:4px;display:flex;align-items:center;justify-content:space-between;font-size:10px;color:var(--color-text-dim);padding:0 0 4px;border-bottom:1px solid var(--color-border)">
          <span style="flex:1">Dimensie</span>
          <span style="width:36px;text-align:right">Score</span>
          <span style="width:40px;text-align:right">Gewicht</span>
          <span style="width:48px;text-align:right">Bijdrage</span>
          <span style="width:68px;text-align:right">Aandeel</span>
        </div>
        ${contributions.map(c => `
          <div class="score-explain__row">
            <span class="score-explain__dim-name">${c.name}</span>
            <span class="score-explain__dim-score" style="color:${getScoreColor(c.score)}">${c.score}</span>
            <span class="score-explain__dim-weight">${c.weightPct}%</span>
            <span class="score-explain__dim-contrib">${c.contrib.toFixed(2)}</span>
            <div class="score-explain__dim-bar">
              <div class="score-explain__dim-bar-fill" style="width:${Math.min(100, c.contrib / calculatedVI * 100)}%;background:${getScoreColor(c.score)}"></div>
            </div>
          </div>
        `).join('')}

        <div class="score-explain__total">
          <span class="score-explain__total-label">Vitaliteitsindex</span>
          <span class="score-explain__total-value" style="color:${getScoreColor(calculatedVI)}">${calculatedVI}</span>
        </div>

        <!-- Per-dimension explanations -->
        <div style="margin-top:16px;font-size:11px;font-weight:600;color:var(--color-text-dim);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em">Toelichting per dimensie</div>
        ${contributions.map(c => `
          <div style="margin-bottom:10px;padding:8px 12px;border-left:3px solid ${getScoreColor(c.score)};background:var(--color-surface-alt);border-radius:0 var(--radius) var(--radius) 0">
            <div style="font-size:12px;font-weight:600;margin-bottom:4px;color:var(--color-text)">${c.name} — ${c.score}</div>
            <div style="font-size:11px;color:var(--color-text-muted);line-height:1.5">${c.explain}</div>
          </div>
        `).join('')}

        <div class="score-explain__note">
          <strong style="color:var(--color-text)">Methode:</strong> De vitaliteitsindex is een gewogen gemiddelde van vijf dimensies.
          Elke dimensie wordt gescoord op een schaal van 1 (zeer laag) tot 10 (zeer hoog).
          De gewichten zijn instelbaar via het paneel "Dimensiewegingen" in de zijbalk.
          <ul class="score-explain__source-list">
            <li><strong>Economisch:</strong> gebaseerd op kwaliteitsscores van aanwezige branches (Locatus-classificatie) en gebiedstype</li>
            <li><strong>Veiligheid:</strong> afgeleid van kwetsbaarheidsscores van branches — hoe meer kwetsbare branches, hoe lager de veiligheid</li>
            <li><strong>Sociaal:</strong> inschatting op basis van gebiedstype, voorzieningen en diversiteit van functies</li>
            <li><strong>Ruimtelijk:</strong> gebaseerd op gebiedstype, leegstand en functiebalans</li>
            <li><strong>Ondermijning:</strong> gewogen op basis van kwetsbaarheidsscores en ondermijningsgerelateerde indicatoren per branche</li>
          </ul>
        </div>
      </div>
    </div>
  `;
}

function buildEconomicExplanation(area) {
  const s = area.scores;
  const BQ = window.BranchQualifications;
  const branchDetails = area.branches.map(code => BQ.findBranchByCode(code)).filter(Boolean);
  const avgQuality = branchDetails.length > 0
    ? Math.round(branchDetails.reduce((sum, b) => sum + b.qualityScore, 0) / branchDetails.length * 10) / 10
    : 0;
  const leegstand = area.additionalData?.leegstand?.percentage || 0;
  const typeBonus = area.shoppingAreaType === 'binnenstad_middelgroot' ? '+1.2 (binnenstad)'
    : area.shoppingAreaType === 'perifeer' ? '-1.0 (perifeer)'
    : area.shoppingAreaType === 'verspreide_bewinkeling' ? '-0.5 (verspreide bewinkeling)'
    : '+0 (neutraal)';

  return `Gemiddelde kwaliteitsscore van ${branchDetails.length} branches: <strong>${avgQuality}</strong>. `
    + `Gebiedstypebonus: ${typeBonus}. `
    + `Leegstandspercentage: ${leegstand}%. `
    + (leegstand > 15 ? 'Hoge leegstand drukt de economische vitaliteit.' : '')
    + (avgQuality >= 7 ? ' Sterke branchekwaliteit draagt positief bij.' : '');
}

function buildSafetyExplanation(area) {
  const s = area.scores;
  const BQ = window.BranchQualifications;
  const branchDetails = area.branches.map(code => BQ.findBranchByCode(code)).filter(Boolean);
  const avgVuln = branchDetails.length > 0
    ? Math.round(branchDetails.reduce((sum, b) => sum + b.vulnerabilityScore, 0) / branchDetails.length * 10) / 10
    : 0;
  const vulnBranches = branchDetails.filter(b => b.vulnerabilityScore >= 7);

  return `Gemiddelde kwetsbaarheidsscore: <strong>${avgVuln}</strong> (lager = veiliger). `
    + `Berekening: 10 − (kwetsbaarheid × 0.7) ± variatie. `
    + (vulnBranches.length > 0
      ? `${vulnBranches.length} branch(es) met hoog risico (≥7): ${vulnBranches.slice(0, 3).map(b => b.name).join(', ')}${vulnBranches.length > 3 ? ' en meer' : ''}.`
      : 'Geen branches met hoog kwetsbaarheidsrisico (≥7).');
}

function buildSocialExplanation(area) {
  const branchCount = area.branchCount || 0;
  const typeLabel = (area.shoppingAreaType || 'onbekend').replace(/_/g, ' ');
  const BQ = window.BranchQualifications;
  const branchDetails = area.branches.map(code => BQ.findBranchByCode(code)).filter(Boolean);
  const socialTags = ['dagelijkse_behoeften', 'gezondheid', 'sociale_cohesie', 'gezinsvriendelijk', 'voorziening'];
  const socialBranches = branchDetails.filter(b => b.qualityTags && b.qualityTags.some(t => socialTags.includes(t)));

  return `Gebiedstype "${typeLabel}" geeft een basisniveau voor sociale vitaliteit. `
    + `${socialBranches.length} van ${branchDetails.length} branches dragen bij aan sociale functies `
    + `(dagelijkse behoeften, gezondheid, sociale cohesie). `
    + (socialBranches.length >= 3 ? 'Goede sociale mix aanwezig.' : 'Beperkt sociaal aanbod.');
}

function buildSpatialExplanation(area) {
  const typeLabel = (area.shoppingAreaType || 'onbekend').replace(/_/g, ' ');
  const leegstand = area.additionalData?.leegstand?.percentage || 0;
  const woonfunctie = area.areaContext?.woonfunctieAandeel || 0;
  const typeBonus = area.shoppingAreaType === 'binnenstad_middelgroot' ? '+1.0'
    : area.shoppingAreaType === 'perifeer' ? '-1.0'
    : '+0';

  return `Gebiedstype "${typeLabel}" (bonus: ${typeBonus}). `
    + `Leegstand: ${leegstand}%. Woonfunctieaandeel: ${Math.round(woonfunctie)}%. `
    + (leegstand > 20 ? 'Hoge leegstand heeft negatieve ruimtelijke impact. ' : '')
    + (woonfunctie > 50 ? 'Hoog aandeel woonfunctie beperkt commerciële dynamiek.' : '');
}

function buildUnderminingExplanation(area) {
  const s = area.scores;
  const BQ = window.BranchQualifications;
  const branchDetails = area.branches.map(code => BQ.findBranchByCode(code)).filter(Boolean);
  const avgVuln = branchDetails.length > 0
    ? Math.round(branchDetails.reduce((sum, b) => sum + b.vulnerabilityScore, 0) / branchDetails.length * 10) / 10
    : 0;
  const ondermijnBranches = branchDetails.filter(b => b.vulnerabilityScore >= 6);
  const vulnTypes = new Set();
  ondermijnBranches.forEach(b => { if (b.vulnerabilityTypes) b.vulnerabilityTypes.forEach(v => vulnTypes.add(v)); });

  return `Berekening: 10 − (kwetsbaarheid × 0.8) ± variatie. Gemiddelde kwetsbaarheid: <strong>${avgVuln}</strong>. `
    + `${ondermijnBranches.length} branch(es) met ondermijningsrisico (≥6). `
    + (vulnTypes.size > 0
      ? `Aanwezige risicotypen: ${Array.from(vulnTypes).slice(0, 4).map(v => v.replace(/_/g, ' ')).join(', ')}${vulnTypes.size > 4 ? ' en meer' : ''}.`
      : 'Geen significante ondermijningsrisicotypen gedetecteerd.');
}

// ============================================================
// BRANCH DIALOG
// ============================================================
function openBranchDialog(code) {
  const BQ = window.BranchQualifications;
  const branch = BQ.findBranchByCode(code);
  if (!branch) return;

  AppState.ui.dialogOpen = true;
  AppState.ui.selectedBranch = code;

  document.getElementById('dialogTitle').textContent = branch.name;
  document.getElementById('dialogCode').textContent = `${branch.groupName} • ${branch.code}`;

  const qualityTagLabels = {
    toerisme: '🗺 Toerisme', avondleven: '🌙 Avondleven', cultuur: '🎭 Cultuur',
    dagelijkse_behoeften: '🛒 Dagelijks', winkelplezier: '🛍 Winkelen', gezinsvriendelijk: '👨‍👩‍👧 Gezin',
    werkgelegenheid: '💼 Werk', passantenflow: '🚶 Passanten', gebiedsidentiteit: '📍 Identiteit',
    sociale_cohesie: '🤝 Sociaal', gezondheid: '❤️ Gezondheid', dienstverlening: '🔧 Diensten',
    vrije_tijd: '🎮 Vrije Tijd', ankerfunctie: '⚓ Anker', voorziening: '🏛 Voorziening'
  };

  const vulnTypeLabels = {
    witwassen: '💰 Witwassen', drugshandel: '💊 Drugshandel', mensenhandel: '👤 Mensenhandel',
    uitbuiting: '⛓ Uitbuiting', belastingfraude: '📊 Belastingfraude', illegaal_gokken: '🎰 Illegaal gokken',
    heling: '📦 Heling', dekmantelonderneming: '🎭 Dekmantel', contant_geld_intensief: '💵 Contant geld',
    lage_toetredingsdrempel: '🚪 Lage drempel', ondoorzichtige_omzet: '🔍 Ondoorzichtig', arbeidsuitbuiting: '👷 Arbeidsuitbuiting'
  };

  const actionTypeLabels = {
    bibob_screening: '🔍 Bibob-screening', monitoring: '👁 Monitoring', handhaving: '⚖ Handhaving',
    samenwerking: '🤝 Samenwerking', vergunningplicht: '📋 Vergunningplicht',
    controle: '🔎 Controle', geen_actie_nodig: '✅ Geen actie nodig'
  };

  document.getElementById('dialogBody').innerHTML = `
    <!-- Scores -->
    <div class="dialog__scores">
      <div class="dialog__score-block">
        <div class="dialog__score-value" style="color:${getScoreColor(branch.qualityScore)}">${branch.qualityScore}</div>
        <div class="dialog__score-label">Kwaliteit</div>
      </div>
      <div class="dialog__score-block">
        <div class="dialog__score-value" style="color:${getScoreColor(10 - branch.vulnerabilityScore)}">${branch.vulnerabilityScore}</div>
        <div class="dialog__score-label">Kwetsbaarheid</div>
      </div>
    </div>

    <!-- Kwaliteiten -->
    <div class="dialog__section">
      <div class="dialog__section-title dialog__section-title--quality">Kwaliteiten</div>
      <div class="dialog__text">${branch.qualityDescription}</div>
      <div class="dialog__tags">
        ${branch.qualityTags.map(t => `<span class="dialog__tag dialog__tag--quality">${qualityTagLabels[t] || t}</span>`).join('')}
      </div>
    </div>

    <!-- Kwetsbaarheden -->
    <div class="dialog__section">
      <div class="dialog__section-title dialog__section-title--vulnerability">Kwetsbaarheden (ondermijning)</div>
      <div class="dialog__text">${branch.vulnerabilityDescription}</div>
      <div class="dialog__tags">
        ${branch.vulnerabilityTypes.map(t => `<span class="dialog__tag dialog__tag--vulnerability">${vulnTypeLabels[t] || t}</span>`).join('')}
      </div>
    </div>

    <!-- Handelingsperspectief -->
    <div class="dialog__section">
      <div class="dialog__section-title dialog__section-title--action">Handelingsperspectief</div>
      <div class="dialog__text">${branch.actionPerspective}</div>
      <div class="dialog__tags">
        ${branch.actionTypes.map(t => `<span class="dialog__tag dialog__tag--action">${actionTypeLabels[t] || t}</span>`).join('')}
      </div>
    </div>

    <!-- Gelegenheidsstructuren (JenV) -->
    <div class="dialog__section">
      <div class="dialog__section-title" style="color:#f59e0b">Gelegenheidsstructuren (JenV)</div>
      <div style="display:flex;gap:16px;margin-bottom:8px">
        <div>
          <div style="font-size:24px;font-weight:700;color:${getScoreColor(10 - branch.opportunityScore)}">${branch.opportunityScore}</div>
          <div style="font-size:11px;color:var(--color-text-muted)">Gelegenheidsscore</div>
        </div>
        <div>
          <div style="font-size:24px;font-weight:700;color:${getScoreColor(10 - branch.environmentalSensitivity)}">${branch.environmentalSensitivity}</div>
          <div style="font-size:11px;color:var(--color-text-muted)">Omgevingsgevoeligheid</div>
        </div>
      </div>
      <div class="dialog__tags">
        ${branch.opportunityFactors.map(f => {
          const isSocial = ['gesloten_gemeenschap','familienetwerken','informele_economie','arbeidsafhankelijkheid','vertrouwensmisbruik'].includes(f);
          return `<span class="opp-badge ${isSocial ? 'opp-badge--social' : 'opp-badge--situation'}">${f.replace(/_/g, ' ')}</span>`;
        }).join('') || '<span style="font-size:12px;color:var(--color-text-muted)">Geen significante gelegenheidsstructuren</span>'}
      </div>
      ${branch.barrierModelPhases.length > 0 ? `
        <div style="margin-top:8px;font-size:11px;color:var(--color-text-muted)">
          <strong>Barrièremodel:</strong> Kwetsbaar in fasen: ${branch.barrierModelPhases.map(p => p.replace(/_/g, ' ')).join(', ')}
        </div>
      ` : ''}
    </div>

    <!-- Monocultuurrisico -->
    <div class="dialog__section">
      <div class="dialog__section-title">Monocultuurrisico</div>
      ${branch.monocultureRisk
        ? `<div class="dialog__monoculture-badge dialog__monoculture-badge--yes">⚠ Ja — clustering van deze branche is een risicosignaal (categorie: ${branch.monocultureCategory.replace(/_/g, ' ')})</div>`
        : `<div class="dialog__monoculture-badge dialog__monoculture-badge--no">✓ Nee — clustering vormt geen bijzonder risico</div>`
      }
    </div>
  `;

  document.getElementById('branchDialog').classList.add('dialog-overlay--open');
}

function closeBranchDialog() {
  AppState.ui.dialogOpen = false;
  AppState.ui.selectedBranch = null;
  document.getElementById('branchDialog').classList.remove('dialog-overlay--open');
}

// ============================================================
// BRANCH LIST (sidebar)
// ============================================================
function renderBranchList() {
  const BQ = window.BranchQualifications;
  const f = AppState.filters;

  const filtered = BQ.getFilteredBranches({
    searchQuery: f.searchQuery || AppState.ui.searchQuery,
    groupCode: f.mainBranch || undefined,
    minQuality: f.qualityMin || undefined,
    maxQuality: f.qualityMax || undefined,
    minVulnerability: f.vulnMin || undefined,
    maxVulnerability: f.vulnMax || undefined,
    qualityTags: f.qualityTags.length > 0 ? f.qualityTags : undefined,
    vulnerabilityTypes: f.vulnerabilityTypes.length > 0 ? f.vulnerabilityTypes : undefined,
    monocultureRiskOnly: f.monocultureRiskOnly || undefined,
    opportunityFactors: f.opportunityFactors.length > 0 ? f.opportunityFactors : undefined
  });

  const sorted = filtered.sort((a, b) => b.vulnerabilityScore - a.vulnerabilityScore);

  // Update filter count indicator
  const activeFilterCount = countActiveFilters();
  const countEl = document.getElementById('filterActiveCount');
  const clearBtn = document.getElementById('btnClearFilters');
  if (activeFilterCount > 0) {
    countEl.textContent = activeFilterCount;
    countEl.style.display = 'inline-flex';
    clearBtn.style.display = 'inline';
  } else {
    countEl.style.display = 'none';
    clearBtn.style.display = 'none';
  }

  document.getElementById('branchCount').textContent = `(${sorted.length})`;

  const list = document.getElementById('branchList');
  list.innerHTML = sorted.map(b => `
    <div class="branch-item" data-branch-code="${b.code}">
      <div class="branch-item__dot" style="background:${getScoreColor(b.qualityScore)}"></div>
      <div class="branch-item__name">${b.name}</div>
      <div class="branch-item__scores">
        <span class="branch-item__quality">K${b.qualityScore}</span>
        <span class="branch-item__vulnerability">V${b.vulnerabilityScore}</span>
      </div>
    </div>
  `).join('');

  list.querySelectorAll('.branch-item').forEach(item => {
    item.addEventListener('click', () => openBranchDialog(item.dataset.branchCode));
  });
}

// ============================================================
// DATA STATUS
// ============================================================
function updateDataStatus() {
  const el = document.getElementById('dataStatus');
  if (AppState.data.loaded) {
    const areaCount = AppState.data.pc6Areas.size;
    const branchCount = AppState.data.branchInstances.length;
    el.className = 'data-status data-status--loaded';
    el.innerHTML = `<div class="data-status__dot"></div><span>${areaCount} PC6-gebieden • ${branchCount} branches</span>`;
  } else {
    el.className = 'data-status data-status--empty';
    el.innerHTML = `<div class="data-status__dot"></div><span>Geen data geladen</span>`;
  }
}

// ============================================================
// EXPORT
// ============================================================
function exportToJson() {
  if (!AppState.data.loaded) {
    alert('Geen data om te exporteren. Laad eerst data.');
    return;
  }

  const exportData = {
    meta: {
      tool: 'Vitaliteitstool',
      version: '1.0.0',
      producer: 'Knowledge by Data B.V.',
      exportDate: new Date().toISOString(),
      weights: { ...AppState.weights }
    },
    areas: [],
    summary: {
      totalAreas: AppState.data.pc6Areas.size,
      totalBranches: AppState.data.branchInstances.length,
      averageVitality: 0,
      criticalAreas: 0,
      monocultureAlerts: 0
    }
  };

  let totalVitality = 0;

  AppState.data.pc6Areas.forEach((area, pc6) => {
    totalVitality += area.scores.vitalityIndex;
    if (area.scores.vitalityIndex < 4) exportData.summary.criticalAreas++;
    if (area.scores.monocultureClusters?.length > 0) exportData.summary.monocultureAlerts++;

    exportData.areas.push({
      pc6,
      location: {
        lat: area.lat,
        lng: area.lng,
        street: area.street,
        neighborhood: area.neighborhood,
        district: area.district,
        municipality: area.municipality
      },
      winkelgebied: area.winkelgebied || null,
      shoppingAreaType: area.shoppingAreaType || null,
      branches: area.branches,
      branchCount: area.branchCount,
      scores: { ...area.scores },
      additionalData: area.additionalData || null
    });
  });

  exportData.summary.averageVitality = Math.round(
    (totalVitality / AppState.data.pc6Areas.size) * 10
  ) / 10;

  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `vitaliteitstool-export-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

// ============================================================
// WEIGHT SLIDERS
// ============================================================
function initWeightSliders() {
  const sliders = document.querySelectorAll('.weight-slider input[type="range"]');
  sliders.forEach(slider => {
    slider.addEventListener('input', () => {
      const dimension = slider.dataset.dimension;
      const value = parseInt(slider.value, 10);
      AppState.weights[dimension] = value;
      document.getElementById(`w${dimension.charAt(0).toUpperCase() + dimension.slice(1)}Val`).textContent = `${value}%`;

      // Recalculate if data loaded
      if (AppState.data.loaded) {
        recalculateScores();
        renderMap();
        if (AppState.ui.selectedPc6) {
          renderDetailPanel(AppState.ui.selectedPc6);
        }
      }
    });
  });
}

function recalculateScores() {
  const w = AppState.weights;
  const totalWeight = w.economic + w.safety + w.social + w.spatial + w.undermining;

  AppState.data.pc6Areas.forEach((area, pc6) => {
    const s = area.scores;
    s.vitalityIndex = Math.round(((
      s.economic * w.economic +
      s.safety * w.safety +
      s.social * w.social +
      s.spatial * w.spatial +
      s.undermining * w.undermining
    ) / (totalWeight || 1)) * 10) / 10;
  });
}

// ============================================================
// IMPORT DIALOG
// ============================================================
function openImportDialog() {
  const body = document.getElementById('importDialogBody');
  const specs = window.ImportSpecifications;

  if (!specs || !specs.DATASET_DEFINITIONS) {
    body.innerHTML = '<p style="color: var(--color-danger);">Error: Import specifications not loaded</p>';
    document.getElementById('importDialog').classList.add('import-dialog--open');
    return;
  }

  // Group datasets by category type (EXTERN, INTERN, EMBEDDED)
  const grouped = {};
  specs.DATASET_DEFINITIONS.forEach(dataset => {
    const category = dataset.category || 'onbekend';
    if (!grouped[category]) {
      grouped[category] = [];
    }
    grouped[category].push(dataset);
  });

  // Create category map for display
  const categoryNames = {
    'extern': 'Externe Data',
    'intern': 'Interne Data',
    'embedded': 'Ingebouwde Data'
  };

  let html = '';

  Object.keys(grouped).sort().forEach(category => {
    const datasets = grouped[category];
    const categoryName = categoryNames[category] || category;

    html += `
      <div class="import-category" data-category="${category}">
        <div class="import-category__header import-category--collapsed" onclick="toggleImportCategory(this)">
          <div class="import-category__toggle">▼</div>
          <div class="import-category__title">${categoryName}</div>
          <div class="import-category__badge">${datasets.length}</div>
        </div>
        <div class="import-category__content">
    `;

    datasets.forEach(dataset => {
      const status = AppState.data.imports.get(dataset.id);
      const statusClass = status ? (status.error ? 'error' : 'uploaded') : 'pending';
      const statusText = status ? (status.error ? '❌ Fout' : '✅ Geüpload') : '⏳ Wachten';

      html += `
        <div class="import-dataset" data-dataset-id="${dataset.id}">
          <div class="import-dataset__header">
            <div class="import-dataset__info">
              <div class="import-dataset__name">${escapeHtml(dataset.name)}</div>
              <div class="import-dataset__description">${escapeHtml(dataset.description || '')}</div>
              <div class="import-dataset__meta">
                <div class="import-meta-item">
                  <strong>Bron:</strong> ${escapeHtml(dataset.source || '-')}
                </div>
                <div class="import-meta-item">
                  <strong>Type:</strong> ${dataset.fileType || 'Excel'}
                </div>
                <div class="import-meta-item">
                  <strong>DPIA:</strong> ${dataset.dpiaStatus || 'Onbekend'}
                </div>
              </div>
            </div>
            <div class="import-dataset__status ${statusClass}">${statusText}</div>
          </div>

          <div class="import-dataset__upload" onclick="selectImportFile(this)" data-dataset-id="${dataset.id}">
            📥 Klik of sleep bestand hier heen
          </div>
          <input type="file" class="import-dataset__input" accept="${dataset.fileType === 'JSON' ? '.json' : '.xlsx,.xls,.csv'}" data-dataset-id="${dataset.id}" onchange="handleImportFileSelect(event)">

          <div class="import-dataset__columns" id="cols-${dataset.id}"></div>
          ${status && status.records ? `<div class="import-dataset__records">${status.records.toLocaleString('nl-NL')} records</div>` : ''}
        </div>
      `;
    });

    html += `
        </div>
      </div>
    `;
  });

  body.innerHTML = html;
  document.getElementById('importDialog').classList.add('import-dialog--open');

  // Add close button handlers
  document.getElementById('importDialogClose').addEventListener('click', closeImportDialog);
  document.getElementById('importDialogCloseBtn').addEventListener('click', closeImportDialog);

  // Klik op overlay = sluiten
  document.getElementById('importDialog').addEventListener('click', (e) => {
    if (e.target === document.getElementById('importDialog')) {
      closeImportDialog();
    }
  });

  // Voorkom Leaflet event propagation (CRUCIAAL voor vastloop-fix)
  const importInner = document.getElementById('importDialog').querySelector('.import-dialog');
  if (importInner && window.L && L.DomEvent) {
    L.DomEvent.disableClickPropagation(importInner);
    L.DomEvent.disableScrollPropagation(importInner);
  }

  // Add drag and drop support
  document.querySelectorAll('.import-dataset__upload').forEach(uploadZone => {
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const input = uploadZone.nextElementSibling;
        input.files = files;
        const event = new Event('change', { bubbles: true });
        input.dispatchEvent(event);
      }
    });
  });
}

function toggleImportCategory(header) {
  const category = header.closest('.import-category');
  category.classList.toggle('import-category--collapsed');
}

function selectImportFile(element) {
  const input = element.nextElementSibling;
  input.click();
}

/**
 * Fuzzy match score tussen bron- en doelkolomnaam (0-1)
 * Gebruikt genormaliseerde string vergelijking met woord-overlap
 */
function columnMatchScore(target, source) {
  if (!target || !source) return 0;

  const normalize = (s) => s.toLowerCase().replace(/[^a-z0-9àáâãäåæçèéêëìíîïðñòóôõöùúûüý]/g, '');
  const t = normalize(target);
  const s = normalize(source);

  // Exacte match
  if (t === s) return 1.0;

  // Bevat-match
  if (s.includes(t) || t.includes(s)) return 0.8;

  // Woord-overlap
  const splitWords = (str) => str.toLowerCase().split(/[\s_\-\/()]+/).filter(w => w.length > 1);
  const tWords = splitWords(target);
  const sWords = splitWords(source);

  if (tWords.length === 0 || sWords.length === 0) return 0;

  let overlapCount = 0;
  tWords.forEach(tw => {
    if (sWords.some(sw => sw.includes(tw) || tw.includes(sw))) {
      overlapCount++;
    }
  });

  if (overlapCount > 0) {
    return 0.3 + (0.5 * overlapCount / Math.max(tWords.length, sWords.length));
  }

  return 0;
}

/**
 * Vind de beste match voor een doelkolom in de bronheaders
 */
function findBestColumnMatch(targetHeader, sourceHeaders) {
  let bestScore = 0;
  let bestMatch = null;

  sourceHeaders.forEach(header => {
    if (typeof header !== 'string') return;
    const score = columnMatchScore(targetHeader, header);
    if (score > bestScore) {
      bestScore = score;
      bestMatch = header;
    }
  });

  return bestScore >= 0.3 ? { header: bestMatch, score: bestScore } : null;
}

/**
 * Controleer of een kolom een PC6-variant is (postcode 6)
 */
function isPC6Column(col) {
  if (!col) return false;
  const key = (col.key || '').toLowerCase();
  const header = (col.excelHeader || '').toLowerCase();
  return key.includes('postcode6') || key.includes('pc6') ||
         header.includes('postcode 6') || header.includes('postcode6') || header === 'pc6';
}

/**
 * Bestand geselecteerd: parse en toon kolom-mapping interface
 */
function handleImportFileSelect(event) {
  const input = event.target;
  const file = input.files[0];
  if (!file) return;

  const datasetId = input.dataset.datasetId;
  const specs = window.ImportSpecifications;
  const dataset = specs.DATASET_DEFINITIONS.find(d => d.id === datasetId);

  if (!dataset) return;

  const isJsonFile = file.name.toLowerCase().endsWith('.json') || dataset.fileType === 'JSON';

  if (isJsonFile) {
    handleJsonImport(file, datasetId, dataset);
  } else {
    handleExcelImport(file, datasetId, dataset);
  }
}

/**
 * Verwerk JSON-bestandimport (voor schouwplaatsen en andere JSON-datasets)
 * Ondersteunt zowel array-of-objects als object-with-data-array formats
 */
function handleJsonImport(file, datasetId, dataset) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const jsonText = e.target.result;
      let parsed = JSON.parse(jsonText);

      // Ondersteun meerdere JSON-structuren
      let records = [];
      if (Array.isArray(parsed)) {
        // Direct array van objecten: [ {field: value}, ... ]
        records = parsed;
      } else if (parsed && typeof parsed === 'object') {
        // Object met data-property: { data: [...], metadata: {...} }
        if (Array.isArray(parsed.data)) {
          records = parsed.data;
        } else if (Array.isArray(parsed.records)) {
          records = parsed.records;
        } else if (Array.isArray(parsed.schouwplaatsen)) {
          records = parsed.schouwplaatsen;
        } else if (Array.isArray(parsed.inspections)) {
          records = parsed.inspections;
        } else {
          // Enkel object — behandel als array van 1
          records = [parsed];
        }
      }

      if (records.length === 0) {
        showImportError(datasetId, 'Geen records gevonden in JSON-bestand');
        return;
      }

      // Extraheer headers uit de sleutels van het eerste record
      const allKeys = new Set();
      records.forEach(r => { if (r && typeof r === 'object') Object.keys(r).forEach(k => allKeys.add(k)); });
      const headers = Array.from(allKeys);

      // Converteer objecten naar arrays (zelfde format als Excel-rijen)
      const dataRows = records.map(r => headers.map(h => r[h] !== undefined ? r[h] : null));

      AppState.data.imports.set(datasetId, {
        rawData: dataRows,
        rawHeaders: headers,
        records: dataRows.length,
        validated: false,
        error: null,
        sourceFormat: 'json'
      });

      // Toon kolom-mapping interface (hergebruik Excel mapping)
      showColumnMapping(datasetId, dataset, headers, dataRows.length);

      // Toon succesmelding
      const statusEl = document.querySelector(`.import-dataset[data-dataset-id="${datasetId}"] .import-dataset__status`);
      if (statusEl) {
        statusEl.className = 'import-dataset__status uploaded';
        statusEl.textContent = `📋 ${records.length} JSON records`;
      }

    } catch (error) {
      showImportError(datasetId, `JSON-fout: ${error.message}`);
      console.error('JSON import error:', error);
    }
  };
  reader.readAsText(file, 'UTF-8');
}

/**
 * Verwerk Excel/CSV-bestandimport (bestaande functionaliteit)
 */
function handleExcelImport(file, datasetId, dataset) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = e.target.result;
      const workbook = XLSX.read(data, { type: 'array', header: 1 });

      if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
        showImportError(datasetId, 'Geen gegevens gevonden in bestand');
        return;
      }

      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      if (rows.length < 2) {
        showImportError(datasetId, 'Het bestand bevat niet genoeg gegevens');
        return;
      }

      // Eerste rij = headers, rest = data
      const headers = rows[0].map(h => (h != null ? String(h).trim() : ''));
      const dataRows = rows.slice(1);

      // Sla ruwe data tijdelijk op voor mapping-bevestiging
      AppState.data.imports.set(datasetId, {
        rawData: dataRows,
        rawHeaders: headers,
        records: dataRows.length,
        validated: false,
        error: null,
        sourceFormat: 'excel'
      });

      // Toon kolom-mapping interface
      showColumnMapping(datasetId, dataset, headers, dataRows.length);

    } catch (error) {
      showImportError(datasetId, `Fout bij verwerking: ${error.message}`);
      console.error('Import error:', error);
    }
  };

  reader.readAsArrayBuffer(file);
}

/**
 * Toon de interactieve kolom-mapping interface
 * Bron-kolommen (uit Excel) ↔ Doel-kolommen (uit import specificatie)
 */
function showColumnMapping(datasetId, dataset, sourceHeaders, recordCount) {
  const container = document.getElementById(`cols-${datasetId}`);
  if (!container) return;

  // Bouw doelkolommen lijst, PC6 altijd bovenaan en verplicht
  const targetColumns = [];
  const specColumns = dataset.requiredColumns || [];
  let hasPC6 = false;

  // Eerst: zoek of PC6 al in de specificatie zit
  specColumns.forEach(col => {
    if (isPC6Column(col)) {
      hasPC6 = true;
      targetColumns.unshift({ ...col, required: true, isPC6: true });
    } else {
      targetColumns.push({ ...col, isPC6: false });
    }
  });

  // PC6 altijd toevoegen als die nog niet in de spec zit
  if (!hasPC6) {
    targetColumns.unshift({
      key: 'postcode6',
      excelHeader: 'Postcode 6',
      type: 'string',
      required: true,
      isPC6: true,
      description: '6-positie postcode (verplichte koppelsleutel)'
    });
  }

  // Auto-match: vind beste bronkolom voor elke doelkolom
  const autoMappings = new Map();
  const usedSourceColumns = new Set();

  targetColumns.forEach(col => {
    const match = findBestColumnMatch(col.excelHeader, sourceHeaders.filter(h => !usedSourceColumns.has(h)));
    if (match) {
      autoMappings.set(col.key, match.header);
      usedSourceColumns.add(match.header);
    }
  });

  // Tel auto-matches
  const autoMatchCount = autoMappings.size;

  // Bouw mapping HTML
  let html = `
    <div class="import-mapping" data-dataset-id="${datasetId}">
      <div class="import-mapping__header">
        <span></span>
        <span>Doelkolom (specificatie)</span>
        <span></span>
        <span>Bronkolom (uw bestand)</span>
        <span></span>
      </div>
  `;

  targetColumns.forEach(col => {
    const isRequired = col.required || col.isPC6;
    const autoMatch = autoMappings.get(col.key) || '';
    const rowClass = col.isPC6 ? 'import-mapping__row import-mapping__row--pc6' : 'import-mapping__row';

    html += `
      <div class="${rowClass}" data-col-key="${col.key}">
        <span class="import-mapping__badge ${isRequired ? 'required' : 'optional'}" title="${isRequired ? 'Verplicht' : 'Optioneel'}">
          ${isRequired ? 'V' : 'O'}
        </span>
        <div class="import-mapping__target">
          <span class="import-mapping__target-name">${escapeHtml(col.excelHeader)}${col.isPC6 ? ' (koppelsleutel)' : ''}</span>
          <span class="import-mapping__target-desc">${escapeHtml(col.description || '')}</span>
        </div>
        <span class="import-mapping__arrow">→</span>
        <select class="import-mapping__select ${autoMatch ? 'mapped' : (isRequired ? 'unmapped-required' : '')}"
                data-col-key="${col.key}"
                data-required="${isRequired ? 'true' : 'false'}"
                onchange="updateMappingStatus('${datasetId}', this)">
          <option value="">(niet geselecteerd)</option>
          ${sourceHeaders.map(h => `<option value="${escapeHtml(h)}" ${h === autoMatch ? 'selected' : ''}>${escapeHtml(h)}</option>`).join('')}
        </select>
        <span class="import-mapping__status-icon">${autoMatch ? '✅' : (isRequired ? '⚠️' : '➖')}</span>
      </div>
    `;
  });

  html += `
      <div class="import-mapping__summary">
        <span>${recordCount.toLocaleString('nl-NL')} records gevonden</span>
        ${autoMatchCount > 0 ? `<span class="import-mapping__auto-badge">⚡ ${autoMatchCount} automatisch gematcht</span>` : ''}
      </div>
      <div class="import-mapping__actions">
        <button class="import-mapping__btn import-mapping__btn--primary"
                id="confirmMapping-${datasetId}"
                onclick="confirmColumnMapping('${datasetId}')">
          Bevestig mapping
        </button>
        <button class="import-mapping__btn import-mapping__btn--secondary"
                onclick="resetColumnMapping('${datasetId}')">
          Reset
        </button>
      </div>
    </div>
  `;

  container.innerHTML = html;

  // Valideer initiële mapping status
  validateMappingCompleteness(datasetId);
}

/**
 * Update mapping status wanneer een dropdown verandert
 */
function updateMappingStatus(datasetId, selectEl) {
  const key = selectEl.dataset.colKey;
  const isRequired = selectEl.dataset.required === 'true';
  const value = selectEl.value;
  const statusIcon = selectEl.closest('.import-mapping__row').querySelector('.import-mapping__status-icon');

  if (value) {
    selectEl.className = 'import-mapping__select mapped';
    statusIcon.textContent = '✅';
  } else {
    selectEl.className = `import-mapping__select ${isRequired ? 'unmapped-required' : ''}`;
    statusIcon.textContent = isRequired ? '⚠️' : '➖';
  }

  // Check op dubbele bron-kolom selecties
  const allSelects = selectEl.closest('.import-mapping').querySelectorAll('.import-mapping__select');
  const selectedValues = new Map();
  const duplicates = new Set();

  allSelects.forEach(sel => {
    if (sel.value) {
      if (selectedValues.has(sel.value)) {
        duplicates.add(sel.value);
      }
      selectedValues.set(sel.value, (selectedValues.get(sel.value) || 0) + 1);
    }
  });

  // Markeer duplicaten
  allSelects.forEach(sel => {
    if (sel.value && duplicates.has(sel.value)) {
      sel.style.borderColor = 'var(--color-warning, #f59e0b)';
      sel.title = 'Let op: deze bronkolom is meerdere keren geselecteerd';
    } else {
      sel.style.borderColor = '';
      sel.title = '';
    }
  });

  validateMappingCompleteness(datasetId);
}

/**
 * Controleer of alle verplichte kolommen gemapt zijn
 */
function validateMappingCompleteness(datasetId) {
  const container = document.querySelector(`.import-mapping[data-dataset-id="${datasetId}"]`);
  if (!container) return;

  const confirmBtn = document.getElementById(`confirmMapping-${datasetId}`);
  if (!confirmBtn) return;

  const requiredSelects = container.querySelectorAll('.import-mapping__select[data-required="true"]');
  let allMapped = true;

  requiredSelects.forEach(sel => {
    if (!sel.value) {
      allMapped = false;
    }
  });

  confirmBtn.disabled = !allMapped;

  if (!allMapped) {
    confirmBtn.title = 'Alle verplichte kolommen (V) moeten gemapt zijn';
  } else {
    confirmBtn.title = '';
  }
}

/**
 * Bevestig de kolom-mapping en sla gemapte data op
 */
function confirmColumnMapping(datasetId) {
  const container = document.querySelector(`.import-mapping[data-dataset-id="${datasetId}"]`);
  if (!container) return;

  const importData = AppState.data.imports.get(datasetId);
  if (!importData || !importData.rawData || !importData.rawHeaders) {
    showImportError(datasetId, 'Geen ruwe data beschikbaar voor mapping');
    return;
  }

  const rawHeaders = importData.rawHeaders;
  const rawData = importData.rawData;

  // Verzamel mapping: doelkolom-key → bronkolom-header
  const mapping = {};
  const selects = container.querySelectorAll('.import-mapping__select');
  selects.forEach(sel => {
    if (sel.value) {
      mapping[sel.dataset.colKey] = sel.value;
    }
  });

  // Bouw kolomindex: bronkolom-header → index in rawHeaders
  const headerIndex = {};
  rawHeaders.forEach((header, idx) => {
    headerIndex[header] = idx;
  });

  // Remap data: gebruik mapping om kolommen te hernoemen
  const mappedHeaders = [];
  const mappedColIndices = [];

  Object.entries(mapping).forEach(([targetKey, sourceHeader]) => {
    const idx = headerIndex[sourceHeader];
    if (idx !== undefined) {
      mappedHeaders.push(targetKey);
      mappedColIndices.push(idx);
    }
  });

  // Remap elke rij
  const mappedData = rawData.map(row => {
    const mappedRow = {};
    mappedHeaders.forEach((header, i) => {
      const sourceIdx = mappedColIndices[i];
      mappedRow[header] = row[sourceIdx] !== undefined ? row[sourceIdx] : null;
    });
    return mappedRow;
  });

  // Sla gemapte data op
  AppState.data.imports.set(datasetId, {
    data: mappedData,
    mapping: mapping,
    records: mappedData.length,
    columns: mappedHeaders,
    originalHeaders: rawHeaders,
    validated: true,
    error: null
  });

  // Update UI
  showImportSuccess(datasetId, mappedData.length);

  // Update kolom container: toon compacte mapping samenvatting
  const colContainer = document.getElementById(`cols-${datasetId}`);
  if (colContainer) {
    const mappedCount = Object.keys(mapping).length;
    colContainer.innerHTML = `
      <div class="import-mapping__summary" style="margin-top: 0;">
        <span>✅ ${mappedCount} kolommen gemapt | ${mappedData.length.toLocaleString('nl-NL')} records</span>
        <button class="import-mapping__btn import-mapping__btn--secondary" style="margin-left: auto; padding: 4px 8px; font-size: 10px;"
                onclick="reopenColumnMapping('${datasetId}')">
          Mapping wijzigen
        </button>
      </div>
    `;
  }
}

/**
 * Heropen de kolom-mapping voor aanpassing
 */
function reopenColumnMapping(datasetId) {
  const specs = window.ImportSpecifications;
  const dataset = specs.DATASET_DEFINITIONS.find(d => d.id === datasetId);
  const importData = AppState.data.imports.get(datasetId);

  if (!dataset || !importData) return;

  // Gebruik originele headers als beschikbaar, anders gemapte data
  const headers = importData.originalHeaders || importData.rawHeaders || importData.columns || [];
  const records = importData.records || 0;

  showColumnMapping(datasetId, dataset, headers, records);
}

/**
 * Reset kolom-mapping naar automatische suggesties
 */
function resetColumnMapping(datasetId) {
  const specs = window.ImportSpecifications;
  const dataset = specs.DATASET_DEFINITIONS.find(d => d.id === datasetId);
  const importData = AppState.data.imports.get(datasetId);

  if (!dataset || !importData) return;

  const headers = importData.rawHeaders || importData.originalHeaders || [];
  const records = importData.records || 0;

  showColumnMapping(datasetId, dataset, headers, records);
}

function showImportSuccess(datasetId, recordCount) {
  const dataset = document.querySelector(`[data-dataset-id="${datasetId}"]`);
  if (!dataset) return;

  const statusEl = dataset.querySelector('.import-dataset__status');
  if (statusEl) {
    statusEl.textContent = '✅ Geüpload';
    statusEl.className = 'import-dataset__status uploaded';
  }

  const recordsEl = dataset.querySelector('.import-dataset__records');
  if (recordsEl) {
    recordsEl.textContent = `${recordCount.toLocaleString('nl-NL')} records`;
  } else {
    const newEl = document.createElement('div');
    newEl.className = 'import-dataset__records';
    newEl.textContent = `${recordCount.toLocaleString('nl-NL')} records`;
    dataset.appendChild(newEl);
  }
}

function showImportError(datasetId, errorMsg) {
  const dataset = document.querySelector(`[data-dataset-id="${datasetId}"]`);
  if (!dataset) return;

  const statusEl = dataset.querySelector('.import-dataset__status');
  if (statusEl) {
    statusEl.textContent = '❌ Fout';
    statusEl.className = 'import-dataset__status error';
    statusEl.title = errorMsg;
  }

  AppState.data.imports.set(datasetId, {
    error: errorMsg,
    records: 0,
    validated: false
  });
}

function closeImportDialog() {
  document.getElementById('importDialog').classList.remove('import-dialog--open');
}

// ============================================================
// STAKEHOLDER MODULE
// ============================================================

const ACTOR_ICONS = {
  'WINKELIER': '🏪',
  'HORECA_ONDERNEMER': '🍽️',
  'AMBACHTELIJK_ONDERNEMER': '🔧',
  'DIENSTVERLENER': '💼',
  'MARKTKOOPMAN': '🎪',
  'WINKELIERSVERENIGING': '🤝',
  'CENTRUMMANAGER': '📋',
  'KLEINE_VASTGOEDONDERNEMER': '🏠',
  'GROTE_VASTGOEDBELEGGER': '🏢',
  'PROJECTONTWIKKELAAR': '🏗️',
  'BEWONER_BINNENSTAD': '🏡',
  'BEWONER_RANDGEBIED': '🌳',
  'WIJKRAAD_BUURTVERENIGING': '🏘️',
  'DAGJESTOERIST': '🚶',
  'TOERIST_INTERNATIONAAL': '✈️',
  'WETHOUDER_ECONOMIE': '🏛️',
  'WETHOUDER_VEILIGHEID': '⚖️',
  'AMBTENAAR_ECONOMIE': '📊',
  'AMBTENAAR_RUIMTE': '📐',
  'AMBTENAAR_SOCIAAL': '🫂',
  'AMBTENAAR_OOV': '🔐',
  'POLITIE': '👮',
  'BOA': '🦺',
  'RIEC_LIEC': '🕵️',
  'AANDEELHOUDER_INVESTEERDER': '📈'
};

const CATEGORY_LABELS = {
  'ondernemers': 'Ondernemers',
  'vastgoed': 'Vastgoed',
  'bewoners': 'Bewoners',
  'bezoekers': 'Bezoekers',
  'overheid': 'Overheid',
  'handhaving_veiligheid': 'Handhaving & Veiligheid',
  'maatschappelijk': 'Maatschappelijk'
};

let stakeholderState = {
  searchTerm: '',
  categoryFilter: '',
  topicFilter: '',
  activeActorId: null
};

let stakeholderListenersAttached = false;

function openStakeholderDialog() {
  const SA = window.StakeholderActoren;
  if (!SA || !SA.ACTORS) {
    console.error('StakeholderActoren module niet geladen');
    return;
  }

  renderStakeholderCards();

  const dialog = document.getElementById('stakeholderDialog');
  dialog.classList.add('stakeholder-dialog--open');

  // Event listeners (eenmalig)
  if (!stakeholderListenersAttached) {
    document.getElementById('stakeholderDialogClose').addEventListener('click', closeStakeholderDialog);
    document.getElementById('stakeholderSearch').addEventListener('input', (e) => {
      stakeholderState.searchTerm = e.target.value.toLowerCase();
      renderStakeholderCards();
    });
    document.getElementById('stakeholderCategoryFilter').addEventListener('change', (e) => {
      stakeholderState.categoryFilter = e.target.value;
      renderStakeholderCards();
    });
    document.getElementById('stakeholderTopicFilter').addEventListener('change', (e) => {
      stakeholderState.topicFilter = e.target.value;
      stakeholderState.activeActorId = null;
      renderStakeholderCards();
    });

    // Klik op overlay = sluiten
    dialog.addEventListener('click', (e) => {
      if (e.target === dialog) {
        closeStakeholderDialog();
      }
    });

    // Voorkom Leaflet event propagation (CRUCIAAL voor vastloop-fix)
    const inner = dialog.querySelector('.stakeholder-dialog');
    if (inner && window.L && L.DomEvent) {
      L.DomEvent.disableClickPropagation(inner);
      L.DomEvent.disableScrollPropagation(inner);
    }

    stakeholderListenersAttached = true;
  }
}

function closeStakeholderDialog() {
  document.getElementById('stakeholderDialog').classList.remove('stakeholder-dialog--open');
  stakeholderState.activeActorId = null;
}

function getFilteredActors() {
  const SA = window.StakeholderActoren;
  let actors = [...SA.ACTORS];

  // Topic filter: alleen relevante actoren tonen
  if (stakeholderState.topicFilter) {
    const topicActors = SA.getActorsForTopic(stakeholderState.topicFilter);
    const topicActorIds = new Set(topicActors.map(a => a.id));
    actors = actors.filter(a => topicActorIds.has(a.id));
  }

  // Categorie filter
  if (stakeholderState.categoryFilter) {
    actors = actors.filter(a => a.category === stakeholderState.categoryFilter);
  }

  // Zoekterm
  if (stakeholderState.searchTerm) {
    const term = stakeholderState.searchTerm;
    actors = actors.filter(a => {
      const haystack = [
        a.name,
        a.category,
        a.perspective?.primary || '',
        a.perspective?.description || '',
        ...(a.perspectives || []),
        ...(a.biases || []),
        ...(a.qualifications || [])
      ].join(' ').toLowerCase();
      return haystack.includes(term);
    });
  }

  return actors;
}

function renderStakeholderCards() {
  const body = document.getElementById('stakeholderDialogBody');
  const actors = getFilteredActors();

  document.getElementById('stakeholderCount').textContent = `${actors.length} actor${actors.length !== 1 ? 'en' : ''}`;

  let html = '';

  actors.forEach(actor => {
    const icon = ACTOR_ICONS[actor.id] || '👤';
    const isActive = stakeholderState.activeActorId === actor.id;
    const biasCount = actor.biases ? actor.biases.length : 0;
    const qualCount = actor.qualifications ? actor.qualifications.length : 0;
    const riskCount = actor.riskFactors ? actor.riskFactors.length : 0;

    html += `
      <div class="actor-card ${isActive ? 'actor-card--active' : ''}"
           onclick="toggleActorDetail('${actor.id}')"
           data-actor-id="${actor.id}">
        <div class="actor-card__header">
          <div class="actor-card__icon actor-card__icon--${actor.category}">
            ${icon}
          </div>
          <div>
            <div class="actor-card__name">${escapeHtml(actor.name)}</div>
            <div class="actor-card__category">${CATEGORY_LABELS[actor.category] || actor.category}</div>
          </div>
        </div>
        <div class="actor-card__perspective">${escapeHtml(actor.perspective?.primary || '')}</div>
        <div class="actor-card__tags">
          ${biasCount > 0 ? `<span class="actor-card__tag actor-card__tag--bias">${biasCount} biases</span>` : ''}
          ${qualCount > 0 ? `<span class="actor-card__tag actor-card__tag--qual">${qualCount} kwalificaties</span>` : ''}
          ${riskCount > 0 ? `<span class="actor-card__tag actor-card__tag--risk">${riskCount} risico's</span>` : ''}
        </div>
      </div>
    `;

    // Detail panel direct na actieve kaart
    if (isActive) {
      html += renderActorDetail(actor);
    }
  });

  if (actors.length === 0) {
    html = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--color-text-muted);">Geen actoren gevonden met deze filters.</div>';
  }

  body.innerHTML = html;
}

function renderActorDetail(actor) {
  const SA = window.StakeholderActoren;
  const guide = actor.communicationGuide;
  const collab = actor.collaborationMatrix;
  const icon = ACTOR_ICONS[actor.id] || '👤';

  // Resolve actor IDs naar namen voor samenwerkingsmatrix
  const resolveNames = (ids) => (ids || []).map(id => {
    const a = SA.getActorById(id);
    return a ? { id, name: a.name, icon: ACTOR_ICONS[id] || '👤' } : null;
  }).filter(Boolean);

  const allies = resolveNames(collab?.allies);
  const opponents = resolveNames(collab?.opponents);
  const conditional = resolveNames(collab?.conditional);

  return `
    <div class="actor-detail">
      <div class="actor-detail__header">
        <div>
          <div class="actor-detail__name">${icon} ${escapeHtml(actor.name)}</div>
          <div class="actor-detail__subtitle">${CATEGORY_LABELS[actor.category] || actor.category} • ${escapeHtml(actor.perspective?.primary || '')}</div>
        </div>
        <button class="actor-detail__close" onclick="closeActorDetail(event)">Sluiten</button>
      </div>

      <!-- Perspectief -->
      <div class="actor-detail__section actor-detail__section--full" style="margin-bottom:16px">
        <div class="actor-detail__section-title">📌 Perspectief</div>
        <div style="font-size:12px;color:var(--color-text);line-height:1.6;margin-bottom:8px">
          ${escapeHtml(actor.perspective?.description || '')}
        </div>
        <ul class="actor-detail__list">
          ${(actor.perspectives || []).map(p => `<li>${escapeHtml(p)}</li>`).join('')}
        </ul>
      </div>

      <div class="actor-detail__sections">
        <!-- Biases / Blinde vlekken -->
        <div class="actor-detail__section">
          <div class="actor-detail__section-title">⚠️ Biases / Blinde vlekken</div>
          <ul class="actor-detail__list actor-detail__list--bias">
            ${(actor.biases || []).map(b => `<li>${escapeHtml(b)}</li>`).join('')}
          </ul>
        </div>

        <!-- Kwalificaties -->
        <div class="actor-detail__section">
          <div class="actor-detail__section-title">✅ Kwalificaties / Expertise</div>
          <ul class="actor-detail__list actor-detail__list--qual">
            ${(actor.qualifications || []).map(q => `<li>${escapeHtml(q)}</li>`).join('')}
          </ul>
        </div>

        <!-- Risicofactoren -->
        <div class="actor-detail__section">
          <div class="actor-detail__section-title">🚨 Risicofactoren</div>
          <ul class="actor-detail__list actor-detail__list--risk">
            ${(actor.riskFactors || []).map(r => `<li>${escapeHtml(r)}</li>`).join('')}
          </ul>
        </div>

        <!-- Communicatiehandleiding -->
        <div class="actor-detail__section">
          <div class="actor-detail__section-title">💬 Communicatiehandleiding</div>
          <ul class="actor-detail__list actor-detail__list--comm">
            <li><strong>Aanpak:</strong> ${escapeHtml(guide?.approach || '')}</li>
            <li><strong>Taal:</strong> ${escapeHtml(guide?.language || '')}</li>
            <li><strong>Kanalen:</strong> ${(guide?.channels || []).join(', ')}</li>
          </ul>
          <div style="margin-top:8px">
            <div style="font-size:11px;font-weight:600;color:var(--color-text-muted);margin-bottom:4px">Kernboodschappen:</div>
            <ul class="actor-detail__list actor-detail__list--comm">
              ${(guide?.keyMessages || []).map(m => `<li>${escapeHtml(m)}</li>`).join('')}
            </ul>
          </div>
          <div style="margin-top:8px">
            <div style="font-size:11px;font-weight:600;color:var(--color-danger);margin-bottom:4px">Te vermijden:</div>
            <ul class="actor-detail__list actor-detail__list--bias">
              ${(guide?.whatToAvoid || []).map(m => `<li>${escapeHtml(m)}</li>`).join('')}
            </ul>
          </div>
          ${guide?.recommendedFraming ? `
            <div class="actor-detail__framing">
              <strong>Framing:</strong> ${escapeHtml(guide.recommendedFraming)}
            </div>
          ` : ''}
        </div>

        <!-- Samenwerkingsmatrix -->
        <div class="actor-detail__section actor-detail__section--full">
          <div class="actor-detail__section-title">🤝 Samenwerkingsmatrix</div>
          <div class="actor-detail__collab">
            <div class="actor-detail__collab-group">
              <div class="actor-detail__collab-label actor-detail__collab-label--ally">Bondgenoten</div>
              ${allies.length > 0 ? allies.map(a =>
                `<div class="actor-detail__collab-item" onclick="navigateToActor('${a.id}', event)">${a.icon} ${escapeHtml(a.name)}</div>`
              ).join('') : '<div style="font-size:11px;color:var(--color-text-dim);">Geen</div>'}
            </div>
            <div class="actor-detail__collab-group">
              <div class="actor-detail__collab-label actor-detail__collab-label--opponent">Tegenstanders</div>
              ${opponents.length > 0 ? opponents.map(a =>
                `<div class="actor-detail__collab-item" onclick="navigateToActor('${a.id}', event)">${a.icon} ${escapeHtml(a.name)}</div>`
              ).join('') : '<div style="font-size:11px;color:var(--color-text-dim);">Geen</div>'}
            </div>
            <div class="actor-detail__collab-group">
              <div class="actor-detail__collab-label actor-detail__collab-label--conditional">Voorwaardelijke partners</div>
              ${conditional.length > 0 ? conditional.map(a =>
                `<div class="actor-detail__collab-item" onclick="navigateToActor('${a.id}', event)">${a.icon} ${escapeHtml(a.name)}</div>`
              ).join('') : '<div style="font-size:11px;color:var(--color-text-dim);">Geen</div>'}
            </div>
          </div>
          ${collab?.tensions && collab.tensions.length > 0 ? `
            <div class="actor-detail__tensions">
              <div style="font-size:11px;font-weight:600;color:var(--color-text-muted);margin-bottom:6px">Spanningsvelden:</div>
              ${collab.tensions.map(t => `<div class="actor-detail__tension">${escapeHtml(t)}</div>`).join('')}
            </div>
          ` : ''}
        </div>
      </div>
    </div>
  `;
}

function toggleActorDetail(actorId) {
  if (stakeholderState.activeActorId === actorId) {
    stakeholderState.activeActorId = null;
  } else {
    stakeholderState.activeActorId = actorId;
  }
  renderStakeholderCards();

  // Scroll naar het detail panel als geopend
  if (stakeholderState.activeActorId) {
    requestAnimationFrame(() => {
      const detail = document.querySelector('.actor-detail');
      if (detail) {
        detail.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    });
  }
}

function closeActorDetail(event) {
  event.stopPropagation();
  stakeholderState.activeActorId = null;
  renderStakeholderCards();
}

function navigateToActor(actorId, event) {
  event.stopPropagation();
  // Reset filters zodat de actor zichtbaar is
  stakeholderState.categoryFilter = '';
  stakeholderState.topicFilter = '';
  stakeholderState.searchTerm = '';
  document.getElementById('stakeholderSearch').value = '';
  document.getElementById('stakeholderCategoryFilter').value = '';
  document.getElementById('stakeholderTopicFilter').value = '';
  // Open detail van de aangeklikte actor
  stakeholderState.activeActorId = actorId;
  renderStakeholderCards();

  requestAnimationFrame(() => {
    const detail = document.querySelector('.actor-detail');
    if (detail) {
      detail.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ============================================================
// BRANCHE OVERVIEW DIALOG
// ============================================================
let brancheOverviewState = {
  searchTerm: '',
  groupFilter: '',
  sortBy: 'name',
  activeCode: null,
  listenersAttached: false
};

const QUALITY_TAG_LABELS = {
  toerisme: '🗺 Toerisme', avondleven: '🌙 Avondleven', cultuur: '🎭 Cultuur',
  dagelijkse_behoeften: '🛒 Dagelijks', winkelplezier: '🛍 Winkelen', gezinsvriendelijk: '👨‍👩‍👧 Gezin',
  werkgelegenheid: '💼 Werk', passantenflow: '🚶 Passanten', gebiedsidentiteit: '📍 Identiteit',
  sociale_cohesie: '🤝 Sociaal', gezondheid: '❤️ Gezondheid', dienstverlening: '🔧 Diensten',
  vrije_tijd: '🎮 Vrije Tijd', ankerfunctie: '⚓ Anker', voorziening: '🏛 Voorziening'
};

const VULN_TYPE_LABELS = {
  witwassen: '💰 Witwassen', drugshandel: '💊 Drugshandel', mensenhandel: '👤 Mensenhandel',
  uitbuiting: '⛓ Uitbuiting', belastingfraude: '📊 Belastingfraude', illegaal_gokken: '🎰 Illegaal gokken',
  heling: '📦 Heling', dekmantelonderneming: '🎭 Dekmantel', contant_geld_intensief: '💵 Contant geld',
  lage_toetredingsdrempel: '🚪 Lage drempel', ondoorzichtige_omzet: '🔍 Ondoorzichtig', arbeidsuitbuiting: '👷 Arbeidsuitbuiting'
};

const ACTION_TYPE_LABELS = {
  bibob_screening: '🔍 Bibob-screening', monitoring: '👁 Monitoring', handhaving: '⚖ Handhaving',
  samenwerking: '🤝 Samenwerking', vergunningplicht: '📋 Vergunningplicht',
  controle: '🔎 Controle', geen_actie_nodig: '✅ Geen actie nodig'
};

function openBrancheOverview() {
  const BQ = window.BranchQualifications;
  if (!BQ) {
    console.error('BranchQualifications module niet geladen');
    return;
  }

  // Groepen dropdown vullen (eenmalig)
  const groupSelect = document.getElementById('brancheOverviewGroupFilter');
  if (groupSelect.options.length <= 1) {
    BQ.BRANCH_GROUPS.forEach(g => {
      const opt = document.createElement('option');
      opt.value = g.code;
      opt.textContent = `${g.code} — ${g.name}`;
      groupSelect.appendChild(opt);
    });
  }

  renderBrancheOverviewCards();

  const dialog = document.getElementById('brancheOverviewDialog');
  dialog.classList.add('branche-overview--open');

  // Event listeners (eenmalig)
  if (!brancheOverviewState.listenersAttached) {
    document.getElementById('brancheOverviewClose').addEventListener('click', closeBrancheOverview);

    document.getElementById('brancheOverviewSearch').addEventListener('input', (e) => {
      brancheOverviewState.searchTerm = e.target.value.toLowerCase().trim();
      renderBrancheOverviewCards();
    });

    document.getElementById('brancheOverviewGroupFilter').addEventListener('change', (e) => {
      brancheOverviewState.groupFilter = e.target.value;
      brancheOverviewState.activeCode = null;
      renderBrancheOverviewCards();
    });

    document.getElementById('brancheOverviewSortFilter').addEventListener('change', (e) => {
      brancheOverviewState.sortBy = e.target.value;
      renderBrancheOverviewCards();
    });

    // Klik op overlay = sluiten
    dialog.addEventListener('click', (e) => {
      if (e.target === dialog) {
        closeBrancheOverview();
      }
    });

    // Voorkom Leaflet event propagation
    const inner = dialog.querySelector('.branche-overview');
    if (inner && window.L && L.DomEvent) {
      L.DomEvent.disableClickPropagation(inner);
      L.DomEvent.disableScrollPropagation(inner);
    }

    brancheOverviewState.listenersAttached = true;
  }
}

function closeBrancheOverview() {
  document.getElementById('brancheOverviewDialog').classList.remove('branche-overview--open');
  brancheOverviewState.activeCode = null;
}

function countBranchOccurrences(branchCode) {
  const instances = AppState.data.branchInstances;
  if (!instances || instances.length === 0) {
    return { total: 0, perPc6: new Map(), perWinkelgebied: new Map() };
  }

  const perPc6 = new Map();
  const perWinkelgebied = new Map();
  let total = 0;

  for (const inst of instances) {
    if (inst.branchCode !== branchCode) continue;
    total++;

    perPc6.set(inst.pc6, (perPc6.get(inst.pc6) || 0) + 1);

    const area = AppState.data.pc6Areas.get(inst.pc6);
    if (area && area.winkelgebied) {
      perWinkelgebied.set(area.winkelgebied, (perWinkelgebied.get(area.winkelgebied) || 0) + 1);
    }
  }

  return { total, perPc6, perWinkelgebied };
}

function getFilteredBranchesForOverview() {
  const BQ = window.BranchQualifications;
  let branches = BQ.getAllBranches();

  // Groepfilter
  if (brancheOverviewState.groupFilter) {
    branches = branches.filter(b => b.groupCode === brancheOverviewState.groupFilter);
  }

  // Zoekterm (op naam)
  if (brancheOverviewState.searchTerm) {
    const term = brancheOverviewState.searchTerm;
    branches = branches.filter(b => {
      const haystack = [
        b.name,
        b.groupName,
        b.qualityDescription,
        b.vulnerabilityDescription,
        ...(b.qualityTags || []),
        ...(b.vulnerabilityTypes || [])
      ].join(' ').toLowerCase();
      return haystack.includes(term);
    });
  }

  // Sorteren
  const sort = brancheOverviewState.sortBy;
  if (sort === 'name') {
    branches.sort((a, b) => a.name.localeCompare(b.name, 'nl'));
  } else if (sort === 'quality-desc') {
    branches.sort((a, b) => b.qualityScore - a.qualityScore || a.name.localeCompare(b.name, 'nl'));
  } else if (sort === 'quality-asc') {
    branches.sort((a, b) => a.qualityScore - b.qualityScore || a.name.localeCompare(b.name, 'nl'));
  } else if (sort === 'vuln-desc') {
    branches.sort((a, b) => b.vulnerabilityScore - a.vulnerabilityScore || a.name.localeCompare(b.name, 'nl'));
  } else if (sort === 'vuln-asc') {
    branches.sort((a, b) => a.vulnerabilityScore - b.vulnerabilityScore || a.name.localeCompare(b.name, 'nl'));
  } else if (sort === 'count-desc') {
    // Sorteer op aantal voorkomens in data (aflopend)
    branches.sort((a, b) => {
      const countA = countBranchOccurrences(a.code).total;
      const countB = countBranchOccurrences(b.code).total;
      return countB - countA || a.name.localeCompare(b.name, 'nl');
    });
  }

  return branches;
}

function renderBrancheOverviewCards() {
  const branches = getFilteredBranchesForOverview();
  const body = document.getElementById('brancheOverviewBody');
  const countEl = document.getElementById('brancheOverviewCount');

  countEl.textContent = `${branches.length} branche${branches.length !== 1 ? 's' : ''}`;

  if (branches.length === 0) {
    body.innerHTML = '<div style="text-align:center;padding:40px;color:var(--color-text-muted)">Geen branches gevonden</div>';
    return;
  }

  let html = '<div class="branche-overview__grid">';

  for (const branch of branches) {
    const isActive = brancheOverviewState.activeCode === branch.code;
    const occ = countBranchOccurrences(branch.code);
    const topTags = (branch.qualityTags || []).slice(0, 3);

    html += `
      <div class="branche-card ${isActive ? 'branche-card--active' : ''}"
           onclick="toggleBrancheDetail('${branch.code}')">
        <div class="branche-card__header">
          <div>
            <div class="branche-card__name">${escapeHtml(branch.name)}</div>
            <div class="branche-card__group">${escapeHtml(branch.groupName)}</div>
          </div>
          <div class="branche-card__scores">
            <span class="branche-card__score branche-card__score--quality" title="Kwaliteitsscore">✦ ${branch.qualityScore}</span>
            <span class="branche-card__score branche-card__score--vuln" title="Kwetsbaarheidsscore">⚠ ${branch.vulnerabilityScore}</span>
          </div>
        </div>
        <div class="branche-card__tags">
          ${topTags.map(t => `<span class="branche-card__tag">${(QUALITY_TAG_LABELS[t] || t).replace(/^[^ ]+ /, '')}</span>`).join('')}
          <span class="branche-card__count-badge ${occ.total === 0 ? 'branche-card__count-badge--zero' : ''}"
                title="Aantal voorkomens in geladen data">
            ${occ.total}× in data
          </span>
        </div>
      </div>
    `;

    // Detail inline renderen als actief
    if (isActive) {
      html += renderBrancheDetailContent(branch);
    }
  }

  html += '</div>';
  body.innerHTML = html;
}

function renderBrancheDetailContent(branch) {
  const occ = countBranchOccurrences(branch.code);

  // Sorteer winkelgebieden aflopend op aantal
  const wgEntries = [...occ.perWinkelgebied.entries()].sort((a, b) => b[1] - a[1]);
  // Sorteer PC6 aflopend op aantal, max 15 tonen
  const pc6Entries = [...occ.perPc6.entries()].sort((a, b) => b[1] - a[1]).slice(0, 15);
  const pc6Hidden = occ.perPc6.size - pc6Entries.length;

  let html = `
    <div class="branche-detail">
      <div class="branche-detail__header">
        <div>
          <div class="branche-detail__name">${escapeHtml(branch.name)}</div>
          <div class="branche-detail__meta">${escapeHtml(branch.groupName)} • ${branch.code}</div>
        </div>
        <button class="branche-detail__close" onclick="closeBrancheDetail(event)">✕ Sluiten</button>
      </div>

      <div class="branche-detail__scores-row">
        <div class="branche-detail__score-box">
          <div class="branche-detail__score-num" style="color:${getScoreColor(branch.qualityScore)}">${branch.qualityScore}</div>
          <div class="branche-detail__score-lbl">Kwaliteit</div>
        </div>
        <div class="branche-detail__score-box">
          <div class="branche-detail__score-num" style="color:${getScoreColor(10 - branch.vulnerabilityScore)}">${branch.vulnerabilityScore}</div>
          <div class="branche-detail__score-lbl">Kwetsbaarheid</div>
        </div>
        <div class="branche-detail__score-box">
          <div class="branche-detail__score-num" style="color:${getScoreColor(10 - branch.opportunityScore)}">${branch.opportunityScore}</div>
          <div class="branche-detail__score-lbl">Gelegenheidsscore</div>
        </div>
      </div>

      <div class="branche-detail__sections">
        <!-- Kwaliteiten -->
        <div class="branche-detail__section">
          <div class="branche-detail__section-title branche-detail__section-title--quality">Kwaliteiten</div>
          <div class="branche-detail__text">${escapeHtml(branch.qualityDescription)}</div>
          <div class="branche-detail__tags">
            ${(branch.qualityTags || []).map(t => `<span class="dialog__tag dialog__tag--quality">${QUALITY_TAG_LABELS[t] || t}</span>`).join('') || '<span style="font-size:12px;color:var(--color-text-dim)">Geen kwaliteitslabels</span>'}
          </div>
        </div>

        <!-- Kwetsbaarheden -->
        <div class="branche-detail__section">
          <div class="branche-detail__section-title branche-detail__section-title--vuln">Kwetsbaarheden (ondermijning)</div>
          <div class="branche-detail__text">${escapeHtml(branch.vulnerabilityDescription)}</div>
          <div class="branche-detail__tags">
            ${(branch.vulnerabilityTypes || []).map(t => `<span class="dialog__tag dialog__tag--vulnerability">${VULN_TYPE_LABELS[t] || t}</span>`).join('') || '<span style="font-size:12px;color:var(--color-text-dim)">Geen kwetsbaarheidslabels</span>'}
          </div>
        </div>

        <!-- Handelingsperspectief (full width) -->
        <div class="branche-detail__section branche-detail__section--full">
          <div class="branche-detail__section-title branche-detail__section-title--action">Handelingsperspectief</div>
          <div class="branche-detail__text">${escapeHtml(branch.actionPerspective)}</div>
          <div class="branche-detail__tags">
            ${(branch.actionTypes || []).map(t => `<span class="dialog__tag dialog__tag--action">${ACTION_TYPE_LABELS[t] || t}</span>`).join('')}
          </div>
        </div>

        <!-- Voorkomens in data (full width) -->
        <div class="branche-detail__section branche-detail__section--full">
          <div class="branche-detail__section-title branche-detail__section-title--count">Voorkomens in geladen data</div>
          ${occ.total === 0
            ? '<div class="branche-detail__occ-none">Deze branche komt niet voor in de huidige dataset. Laad demodata of importeer een dataset.</div>'
            : `
              <div class="branche-detail__occ-summary">
                <div class="branche-detail__occ-stat">
                  <div class="branche-detail__occ-stat-num">${occ.total}</div>
                  <div class="branche-detail__occ-stat-lbl">Totaal</div>
                </div>
                <div class="branche-detail__occ-stat">
                  <div class="branche-detail__occ-stat-num">${occ.perPc6.size}</div>
                  <div class="branche-detail__occ-stat-lbl">PC6-gebieden</div>
                </div>
                <div class="branche-detail__occ-stat">
                  <div class="branche-detail__occ-stat-num">${occ.perWinkelgebied.size}</div>
                  <div class="branche-detail__occ-stat-lbl">Winkelgebieden</div>
                </div>
              </div>

              ${wgEntries.length > 0 ? `
                <div style="margin-bottom:12px">
                  <div style="font-size:11px;font-weight:600;color:var(--color-text-dim);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.04em">Per winkelgebied</div>
                  <table class="branche-detail__occ-table">
                    <thead><tr><th>Winkelgebied</th><th style="text-align:right">Aantal</th></tr></thead>
                    <tbody>
                      ${wgEntries.map(([naam, count]) => `<tr><td>${escapeHtml(naam)}</td><td>${count}</td></tr>`).join('')}
                    </tbody>
                  </table>
                </div>
              ` : ''}

              ${pc6Entries.length > 0 ? `
                <div>
                  <div style="font-size:11px;font-weight:600;color:var(--color-text-dim);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.04em">Per postcodegebied${pc6Hidden > 0 ? ` (top ${pc6Entries.length} van ${occ.perPc6.size})` : ''}</div>
                  <table class="branche-detail__occ-table">
                    <thead><tr><th>PC6</th><th style="text-align:right">Aantal</th></tr></thead>
                    <tbody>
                      ${pc6Entries.map(([pc6, count]) => {
                        const area = AppState.data.pc6Areas.get(pc6);
                        const label = area ? `${pc6} — ${area.street}, ${area.neighborhood}` : pc6;
                        return `<tr><td>${escapeHtml(label)}</td><td>${count}</td></tr>`;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
              ` : ''}
            `
          }
        </div>

        <!-- Monocultuurrisico -->
        <div class="branche-detail__section">
          <div class="branche-detail__section-title">Monocultuurrisico</div>
          ${branch.monocultureRisk
            ? `<div class="dialog__monoculture-badge dialog__monoculture-badge--yes">⚠ Ja — clustering is risicosignaal (${(branch.monocultureCategory || '').replace(/_/g, ' ')})</div>`
            : '<div class="dialog__monoculture-badge dialog__monoculture-badge--no">✓ Nee — clustering vormt geen bijzonder risico</div>'
          }
        </div>

        <!-- Gelegenheidsstructuren -->
        <div class="branche-detail__section">
          <div class="branche-detail__section-title" style="color:#f59e0b">Gelegenheidsstructuren (JenV)</div>
          <div class="branche-detail__tags">
            ${(branch.opportunityFactors || []).map(f => {
              const isSocial = ['gesloten_gemeenschap','familienetwerken','informele_economie','arbeidsafhankelijkheid','vertrouwensmisbruik'].includes(f);
              return `<span class="opp-badge ${isSocial ? 'opp-badge--social' : 'opp-badge--situation'}">${f.replace(/_/g, ' ')}</span>`;
            }).join('') || '<span style="font-size:12px;color:var(--color-text-dim)">Geen significante gelegenheidsstructuren</span>'}
          </div>
          ${(branch.barrierModelPhases || []).length > 0 ? `
            <div style="margin-top:8px;font-size:11px;color:var(--color-text-muted)">
              <strong>Barrièremodel:</strong> Kwetsbaar in fasen: ${branch.barrierModelPhases.map(p => p.replace(/_/g, ' ')).join(', ')}
            </div>
          ` : ''}
        </div>
      </div>
    </div>
  `;

  return html;
}

function toggleBrancheDetail(code) {
  if (brancheOverviewState.activeCode === code) {
    brancheOverviewState.activeCode = null;
  } else {
    brancheOverviewState.activeCode = code;
  }
  renderBrancheOverviewCards();

  // Scroll naar detail
  if (brancheOverviewState.activeCode) {
    requestAnimationFrame(() => {
      const detail = document.querySelector('.branche-detail');
      if (detail) {
        detail.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    });
  }
}

function closeBrancheDetail(event) {
  if (event) {
    event.stopPropagation();
  }
  brancheOverviewState.activeCode = null;
  renderBrancheOverviewCards();
}

// ============================================================
// EVENT HANDLERS
// ============================================================
function initEventHandlers() {
  // Theme toggle
  document.getElementById('themeToggle').addEventListener('click', toggleTheme);
  updateThemeButton();

  // Action buttons (delegated)
  document.addEventListener('click', (e) => {
    const action = e.target.closest('[data-action]');
    if (!action) return;

    const actionName = action.dataset.action;

    switch (actionName) {
      case 'load-demo':
        generateDemoData();
        break;
      case 'export':
        exportToJson();
        break;
      case 'close-detail':
        AppState.ui.detailOpen = false;
        AppState.ui.selectedPc6 = null;
        document.getElementById('detailPanel').classList.remove('detail-panel--open');
        break;
      case 'close-dialog':
        closeBranchDialog();
        break;
      case 'import':
        openImportDialog();
        break;
      case 'stakeholders':
        openStakeholderDialog();
        break;
      case 'branche-overview':
        openBrancheOverview();
        break;
      case 'toggle-monoculture':
        AppState.ui.showMonoculture = !AppState.ui.showMonoculture;
        action.classList.toggle('btn--primary', AppState.ui.showMonoculture);
        renderMap();
        break;
      case 'toggle-heatmap':
        AppState.ui.showHeatmap = !AppState.ui.showHeatmap;
        action.classList.toggle('btn--primary', AppState.ui.showHeatmap);
        break;
      case 'logout':
        if (window.AuthGuard) {
          AuthGuard.logout();
          location.reload();
        }
        break;
    }
  });

  // Branch search
  document.getElementById('branchSearch').addEventListener('input', (e) => {
    AppState.filters.searchQuery = e.target.value;
    AppState.ui.searchQuery = e.target.value;
    renderBranchList();
    renderMap();
  });

  // Filter panel toggle
  document.getElementById('btnToggleFilters').addEventListener('click', () => {
    AppState.ui.filtersOpen = !AppState.ui.filtersOpen;
    const panel = document.getElementById('filterPanel');
    const btn = document.getElementById('btnToggleFilters');
    panel.classList.toggle('filter-panel--open', AppState.ui.filtersOpen);
    btn.textContent = AppState.ui.filtersOpen ? '▲ Filters' : '▼ Filters';
  });

  // Clear all filters
  document.getElementById('btnClearFilters').addEventListener('click', () => {
    clearAllFilters();
  });

  // Filter selects
  const filterSelects = ['filterShoppingArea', 'filterMainBranch', 'filterStreet', 'filterNeighborhood', 'filterDistrict'];
  filterSelects.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('change', () => {
        updateFiltersFromUI();
        renderBranchList();
        renderMap();
      });
    }
  });

  // Filter PC6 input
  document.getElementById('filterPC6').addEventListener('input', (e) => {
    AppState.filters.pc6 = e.target.value.trim().toUpperCase();
    renderMap();
  });

  // Filter range inputs
  ['filterQualityMin', 'filterQualityMax', 'filterVulnMin', 'filterVulnMax'].forEach(id => {
    document.getElementById(id).addEventListener('input', () => {
      updateFiltersFromUI();
      renderBranchList();
      renderMap();
    });
  });

  // Monoculture toggle
  document.getElementById('filterMonoToggle').addEventListener('click', () => {
    AppState.filters.monocultureRiskOnly = !AppState.filters.monocultureRiskOnly;
    document.getElementById('filterMonoToggle').classList.toggle('filter-toggle--active', AppState.filters.monocultureRiskOnly);
    renderBranchList();
    renderMap();
  });

  // Detail panel tab switching (delegated)
  document.getElementById('detailContent').addEventListener('click', (e) => {
    const tab = e.target.closest('[data-detail-tab]');
    if (!tab) return;
    const tabName = tab.dataset.detailTab;
    const tabMap = { scores: 'tabScores', opportunity: 'tabOpportunity', environment: 'tabEnvironment', barrier: 'tabBarrier' };

    document.querySelectorAll('#detailContent .section-tab').forEach(t => t.classList.remove('section-tab--active'));
    document.querySelectorAll('#detailContent .tab-content').forEach(t => t.classList.remove('tab-content--active'));
    tab.classList.add('section-tab--active');
    const targetTab = document.getElementById(tabMap[tabName]);
    if (targetTab) targetTab.classList.add('tab-content--active');
  });

  // Dialog overlay click
  const branchDialogEl = document.getElementById('branchDialog');
  branchDialogEl.addEventListener('click', (e) => {
    if (e.target === branchDialogEl) {
      closeBranchDialog();
    }
  });

  // Voorkom Leaflet event propagation op alle dialogen
  const branchDialogInner = branchDialogEl.querySelector('.dialog');
  if (branchDialogInner && window.L && L.DomEvent) {
    L.DomEvent.disableClickPropagation(branchDialogInner);
    L.DomEvent.disableScrollPropagation(branchDialogInner);
  }

  // Keyboard
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      // Branche overview
      const brancheDialog = document.getElementById('brancheOverviewDialog');
      if (brancheDialog && brancheDialog.classList.contains('branche-overview--open')) {
        closeBrancheOverview();
        return;
      }
      // Stakeholders
      const stakeholderDialog = document.getElementById('stakeholderDialog');
      if (stakeholderDialog && stakeholderDialog.classList.contains('stakeholder-dialog--open')) {
        closeStakeholderDialog();
        return;
      }
      // Import
      const importDialog = document.getElementById('importDialog');
      if (importDialog && importDialog.classList.contains('import-dialog--open')) {
        closeImportDialog();
      } else if (AppState.ui.dialogOpen) {
        closeBranchDialog();
      } else if (AppState.ui.detailOpen) {
        AppState.ui.detailOpen = false;
        document.getElementById('detailPanel').classList.remove('detail-panel--open');
      }
    }
  });
}

// ============================================================
// FILTER LOGIC
// ============================================================
function initFilterChips() {
  const BQ = window.BranchQualifications;

  // Hoofdbranche select vullen
  const mainBranchSelect = document.getElementById('filterMainBranch');
  const groups = BQ.BRANCH_GROUPS;
  groups.forEach(g => {
    const opt = document.createElement('option');
    opt.value = g.code;
    opt.textContent = `${g.code} — ${g.name}`;
    mainBranchSelect.appendChild(opt);
  });

  // Kwetsbaarheden chips
  const vulnContainer = document.getElementById('filterVulnChips');
  const vulnLabels = {
    witwassen: 'Witwassen', drugshandel: 'Drugshandel', mensenhandel: 'Mensenhandel',
    uitbuiting: 'Uitbuiting', belastingfraude: 'Belastingfraude', illegaal_gokken: 'Illegaal gokken',
    heling: 'Heling', dekmantelonderneming: 'Dekmantel', contant_geld_intensief: 'Contant geld',
    lage_toetredingsdrempel: 'Lage drempel', ondoorzichtige_omzet: 'Ondoorzichtig', arbeidsuitbuiting: 'Arbeidsuitbuiting'
  };
  Object.entries(BQ.VULNERABILITY_TYPES).forEach(([, value]) => {
    const chip = document.createElement('span');
    chip.className = 'filter-chip filter-chip--vuln';
    chip.textContent = vulnLabels[value] || value;
    chip.dataset.filterType = 'vulnerability';
    chip.dataset.filterValue = value;
    chip.addEventListener('click', () => toggleFilterChip(chip, 'vulnerabilityTypes', value));
    vulnContainer.appendChild(chip);
  });

  // Kwaliteiten chips
  const qualContainer = document.getElementById('filterQualityChips');
  const qualLabels = {
    toerisme: 'Toerisme', avondleven: 'Avondleven', cultuur: 'Cultuur',
    dagelijkse_behoeften: 'Dagelijks', winkelplezier: 'Winkelen', gezinsvriendelijk: 'Gezin',
    werkgelegenheid: 'Werk', passantenflow: 'Passanten', gebiedsidentiteit: 'Identiteit',
    sociale_cohesie: 'Sociaal', gezondheid: 'Gezondheid', dienstverlening: 'Diensten',
    vrije_tijd: 'Vrije Tijd', ankerfunctie: 'Anker', voorziening: 'Voorziening'
  };
  Object.entries(BQ.QUALITY_TAGS).forEach(([, value]) => {
    const chip = document.createElement('span');
    chip.className = 'filter-chip filter-chip--quality';
    chip.textContent = qualLabels[value] || value;
    chip.dataset.filterType = 'quality';
    chip.dataset.filterValue = value;
    chip.addEventListener('click', () => toggleFilterChip(chip, 'qualityTags', value));
    qualContainer.appendChild(chip);
  });

  // Gelegenheidsstructuren chips (JenV)
  const oppContainer = document.getElementById('filterOppChips');
  const oppLabels = {
    cashflow_ondoorzichtigheid: 'Cashflow', lage_toetredingsdrempel: 'Lage drempel',
    zwakke_administratie: 'Zwakke admin', hoge_waarde_goederen: 'Hoge waarde',
    anonieme_klanten: 'Anoniem', flexibele_prijszetting: 'Flex. prijs',
    seizoensgebonden_patronen: 'Seizoens', ruime_openingstijden: 'Ruime uren',
    grensoverschrijdend: 'Grensoverschr.', complexe_toeleveringsketen: 'Complexe keten',
    gesloten_gemeenschap: 'Gesloten gem.', familienetwerken: 'Familie',
    informele_economie: 'Informeel', arbeidsafhankelijkheid: 'Arbeidsafh.',
    vertrouwensmisbruik: 'Vertrouwen'
  };
  Object.entries(BQ.OPPORTUNITY_FACTORS).forEach(([, value]) => {
    const chip = document.createElement('span');
    chip.className = 'filter-chip filter-chip--opp';
    chip.textContent = oppLabels[value] || value;
    chip.dataset.filterType = 'opportunity';
    chip.dataset.filterValue = value;
    chip.addEventListener('click', () => toggleFilterChip(chip, 'opportunityFactors', value));
    oppContainer.appendChild(chip);
  });
}

function toggleFilterChip(chip, filterArrayName, value) {
  const arr = AppState.filters[filterArrayName];
  const idx = arr.indexOf(value);
  if (idx >= 0) {
    arr.splice(idx, 1);
    chip.classList.remove('filter-chip--active');
  } else {
    arr.push(value);
    chip.classList.add('filter-chip--active');
  }
  renderBranchList();
  renderMap();
}

function updateFiltersFromUI() {
  const f = AppState.filters;
  f.shoppingArea = document.getElementById('filterShoppingArea').value;
  f.mainBranch = document.getElementById('filterMainBranch').value;
  f.street = document.getElementById('filterStreet').value;
  f.neighborhood = document.getElementById('filterNeighborhood').value;
  f.district = document.getElementById('filterDistrict').value;

  const qMin = document.getElementById('filterQualityMin').value;
  const qMax = document.getElementById('filterQualityMax').value;
  const vMin = document.getElementById('filterVulnMin').value;
  const vMax = document.getElementById('filterVulnMax').value;
  f.qualityMin = qMin ? parseInt(qMin, 10) : null;
  f.qualityMax = qMax ? parseInt(qMax, 10) : null;
  f.vulnMin = vMin ? parseInt(vMin, 10) : null;
  f.vulnMax = vMax ? parseInt(vMax, 10) : null;
}

function populateLocationFilters() {
  if (!AppState.data.loaded) return;

  const streets = new Set();
  const neighborhoods = new Set();
  const districts = new Set();

  AppState.data.pc6Areas.forEach(area => {
    if (area.street) streets.add(area.street);
    if (area.neighborhood) neighborhoods.add(area.neighborhood);
    if (area.district) districts.add(area.district);
  });

  const winkelgebieden = new Map();
  AppState.data.pc6Areas.forEach(area => {
    if (area.winkelgebied) winkelgebieden.set(area.winkelgebied, area.shoppingAreaType);
  });

  const fillSelect = (id, values) => {
    const el = document.getElementById(id);
    if (!el) return;
    const current = el.value;
    while (el.options.length > 1) el.remove(1);
    [...values].sort().forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      el.appendChild(opt);
    });
    el.value = current;
  };

  // Winkelgebied select vullen met namen
  const wgSelect = document.getElementById('filterShoppingArea');
  if (wgSelect) {
    const current = wgSelect.value;
    while (wgSelect.options.length > 1) wgSelect.remove(1);
    [...winkelgebieden.keys()].sort().forEach(naam => {
      const opt = document.createElement('option');
      opt.value = naam;
      opt.textContent = naam;
      wgSelect.appendChild(opt);
    });
    wgSelect.value = current;
  }

  fillSelect('filterStreet', streets);
  fillSelect('filterNeighborhood', neighborhoods);
  fillSelect('filterDistrict', districts);
}

function countActiveFilters() {
  const f = AppState.filters;
  let count = 0;
  if (f.shoppingArea) count++;
  if (f.mainBranch) count++;
  if (f.pc6) count++;
  if (f.street) count++;
  if (f.neighborhood) count++;
  if (f.district) count++;
  if (f.qualityMin !== null) count++;
  if (f.qualityMax !== null) count++;
  if (f.vulnMin !== null) count++;
  if (f.vulnMax !== null) count++;
  count += f.vulnerabilityTypes.length;
  count += f.qualityTags.length;
  count += f.opportunityFactors.length;
  if (f.monocultureRiskOnly) count++;
  return count;
}

function clearAllFilters() {
  const f = AppState.filters;
  f.searchQuery = '';
  f.shoppingArea = '';
  f.mainBranch = '';
  f.pc6 = '';
  f.street = '';
  f.neighborhood = '';
  f.district = '';
  f.qualityMin = null;
  f.qualityMax = null;
  f.vulnMin = null;
  f.vulnMax = null;
  f.vulnerabilityTypes = [];
  f.qualityTags = [];
  f.opportunityFactors = [];
  f.monocultureRiskOnly = false;

  // Reset UI
  document.getElementById('branchSearch').value = '';
  document.getElementById('filterShoppingArea').value = '';
  document.getElementById('filterMainBranch').value = '';
  document.getElementById('filterPC6').value = '';
  document.getElementById('filterStreet').value = '';
  document.getElementById('filterNeighborhood').value = '';
  document.getElementById('filterDistrict').value = '';
  document.getElementById('filterQualityMin').value = '';
  document.getElementById('filterQualityMax').value = '';
  document.getElementById('filterVulnMin').value = '';
  document.getElementById('filterVulnMax').value = '';
  document.getElementById('filterMonoToggle').classList.remove('filter-toggle--active');

  document.querySelectorAll('.filter-chip--active').forEach(c => c.classList.remove('filter-chip--active'));

  AppState.ui.searchQuery = '';
  renderBranchList();
  renderMap();
}

// ============================================================
// INIT
// ============================================================
function initApp() {
  initMap();
  initWeightSliders();
  initFilterChips();
  initEventHandlers();
  renderBranchList();
  updateDataStatus();

  // Uitlogknop uitgeschakeld zolang authenticatie niet actief is
  // const logoutBtn = document.getElementById('btnLogout');
  // if (logoutBtn && window.AuthGuard && AuthGuard.isConfigured()) {
  //   logoutBtn.style.display = '';
  // }
}

document.addEventListener('DOMContentLoaded', () => {
  // Startup-dialoog: laat gebruiker kiezen tussen Demo en Productie
  const startupOverlay = document.getElementById('startupOverlay');
  const btnStartDemo = document.getElementById('btnStartDemo');
  const btnStartProd = document.getElementById('btnStartProd');
  const mainHeader = document.querySelector('.header');
  const mainLayout = document.querySelector('.layout');

  // Verberg de applicatie tot de gebruiker een modus kiest
  if (mainHeader) mainHeader.style.display = 'none';
  if (mainLayout) mainLayout.style.display = 'none';

  function dismissStartup(callback) {
    startupOverlay.classList.add('startup-overlay--hidden');
    setTimeout(() => {
      startupOverlay.style.display = 'none';
      if (mainHeader) mainHeader.style.display = '';
      if (mainLayout) mainLayout.style.display = '';
      initApp();
      if (typeof callback === 'function') callback();
    }, 500);
  }

  btnStartDemo.addEventListener('click', () => {
    dismissStartup(() => {
      generateDemoData();
    });
  });

  btnStartProd.addEventListener('click', () => {
    dismissStartup();
  });

  /* --- AuthGuard (bewaard voor later gebruik) ---
  const authOverlay = document.getElementById('authOverlay');

  if (window.AuthGuard) {
    if (AuthGuard.isAuthenticated()) {
      authOverlay.style.display = 'none';
      initApp();
      return;
    }

    authOverlay.style.display = 'block';
    if (mainHeader) mainHeader.style.display = 'none';
    if (mainLayout) mainLayout.style.display = 'none';

    AuthGuard.showAuthScreen(authOverlay, () => {
      authOverlay.style.display = 'none';
      if (mainHeader) mainHeader.style.display = '';
      if (mainLayout) mainLayout.style.display = '';
      initApp();
    });
  }
  --- einde AuthGuard --- */
});
</script>
</body>
</html>
